<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>1 微服务网关概述 | JavaPool</title>
    <meta name="generator" content="VuePress 1.8.2">
    
    <meta name="description" content="java poll icu">
    
    <link rel="preload" href="/assets/css/0.styles.f5fa7e15.css" as="style"><link rel="preload" href="/assets/js/app.e7cabdd2.js" as="script"><link rel="preload" href="/assets/js/5.64292b6a.js" as="script"><link rel="preload" href="/assets/js/7.d18fc8f0.js" as="script"><link rel="prefetch" href="/assets/js/10.f69f73f6.js"><link rel="prefetch" href="/assets/js/11.7d78c600.js"><link rel="prefetch" href="/assets/js/12.359c3b3e.js"><link rel="prefetch" href="/assets/js/13.3bf2e101.js"><link rel="prefetch" href="/assets/js/14.4e7c14d2.js"><link rel="prefetch" href="/assets/js/15.80e70614.js"><link rel="prefetch" href="/assets/js/16.4a1dd265.js"><link rel="prefetch" href="/assets/js/17.c166a677.js"><link rel="prefetch" href="/assets/js/18.674fd4df.js"><link rel="prefetch" href="/assets/js/19.611bef21.js"><link rel="prefetch" href="/assets/js/2.710f3c61.js"><link rel="prefetch" href="/assets/js/20.c50f84bf.js"><link rel="prefetch" href="/assets/js/21.0ca5a378.js"><link rel="prefetch" href="/assets/js/22.d0e7f505.js"><link rel="prefetch" href="/assets/js/23.200694b1.js"><link rel="prefetch" href="/assets/js/24.b5c6a80c.js"><link rel="prefetch" href="/assets/js/25.9f973ca8.js"><link rel="prefetch" href="/assets/js/26.5612b24b.js"><link rel="prefetch" href="/assets/js/27.a3a17886.js"><link rel="prefetch" href="/assets/js/28.8919c943.js"><link rel="prefetch" href="/assets/js/29.94e3a29d.js"><link rel="prefetch" href="/assets/js/3.e60d81bc.js"><link rel="prefetch" href="/assets/js/30.a20d1d23.js"><link rel="prefetch" href="/assets/js/31.4051e2fe.js"><link rel="prefetch" href="/assets/js/32.88d78c67.js"><link rel="prefetch" href="/assets/js/33.c7598946.js"><link rel="prefetch" href="/assets/js/34.9be99d5d.js"><link rel="prefetch" href="/assets/js/35.815f5874.js"><link rel="prefetch" href="/assets/js/36.85f93f98.js"><link rel="prefetch" href="/assets/js/37.0fe99059.js"><link rel="prefetch" href="/assets/js/38.f274a4e9.js"><link rel="prefetch" href="/assets/js/39.5242a021.js"><link rel="prefetch" href="/assets/js/4.24b5369d.js"><link rel="prefetch" href="/assets/js/40.c45a8ca9.js"><link rel="prefetch" href="/assets/js/41.6fa615e3.js"><link rel="prefetch" href="/assets/js/42.eca9f9e2.js"><link rel="prefetch" href="/assets/js/43.1bed5a0f.js"><link rel="prefetch" href="/assets/js/44.456d493b.js"><link rel="prefetch" href="/assets/js/45.131f9f0a.js"><link rel="prefetch" href="/assets/js/46.fa2020bb.js"><link rel="prefetch" href="/assets/js/47.4e0c0591.js"><link rel="prefetch" href="/assets/js/48.1954198e.js"><link rel="prefetch" href="/assets/js/49.a35ae12c.js"><link rel="prefetch" href="/assets/js/50.b00814bf.js"><link rel="prefetch" href="/assets/js/51.0621b0f7.js"><link rel="prefetch" href="/assets/js/52.39c6bf8d.js"><link rel="prefetch" href="/assets/js/53.ff2fc717.js"><link rel="prefetch" href="/assets/js/54.db902a9f.js"><link rel="prefetch" href="/assets/js/6.f21ff3ca.js"><link rel="prefetch" href="/assets/js/8.7231fa26.js"><link rel="prefetch" href="/assets/js/9.8cb60c56.js">
    <link rel="stylesheet" href="/assets/css/0.styles.f5fa7e15.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">JavaPool</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <!----></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><!---->  <ul class="sidebar-links"><li><a href="/" aria-current="page" class="sidebar-link">首页</a></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>基础</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/basics/反射.html" class="sidebar-link">反射</a></li><li><a href="/basics/注解.html" class="sidebar-link">注解</a></li><li><a href="/basics/枚举.html" class="sidebar-link">枚举</a></li><li><a href="/basics/IO.html" class="sidebar-link">IO</a></li><li><a href="/basics/集合.html" class="sidebar-link">集合</a></li><li><a href="/basics/异常.html" class="sidebar-link">异常</a></li><li><a href="/basics/拦截器.html" class="sidebar-link">拦截器</a></li><li><a href="/basics/过虑器.html" class="sidebar-link">过虑器</a></li><li><a href="/basics/jdk8.html" class="sidebar-link">jdk8</a></li><li><a href="/basics/Java8-Lambda.html" class="sidebar-link">Java8-Lambda</a></li><li><a href="/basics/Java8-Stream.html" class="sidebar-link">Java8-Stream</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>设计模式</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/designpattern/黑马-设计模式.html" class="sidebar-link">黑马-设计模式</a></li><li><a href="/designpattern/UML.html" class="sidebar-link">UML类图</a></li><li><a href="/designpattern/七大原则.html" class="sidebar-link">七大原则</a></li><li><a href="/designpattern/23种设计模式.html" class="sidebar-link">23种设计模式</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>JVM</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/bar/three.html" class="sidebar-link">JVM基础概念</a></li><li><a href="/bar/four.html" class="sidebar-link">JVM实战</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>并发多线程</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/thread/并发编程三大核心问题.html" class="sidebar-link">并发编程三大核心问题</a></li><li><a href="/thread/深入理解线程池.html" class="sidebar-link">深入理解线程池</a></li><li><a href="/thread/线程池.html" class="sidebar-link">线程池</a></li><li><a href="/thread/并发编程-FutureTask.html" class="sidebar-link">并发编程-FutureTask</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>MySQL</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/mysql/索引.html" class="sidebar-link">索引</a></li><li><a href="/mysql/锁.html" class="sidebar-link">锁</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Redis</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/redis/持久化.html" class="sidebar-link">持久化</a></li><li><a href="/redis/分布式锁.html" class="sidebar-link">分布式锁</a></li><li><a href="/redis/Redis官方的高可用解决方案.html" class="sidebar-link">Redis官方的高可用解决方案</a></li><li><a href="/redis/数据库缓存最终一致性的四种方案.html" class="sidebar-link">数据库缓存最终一致性的四种方案</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Spring</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/spring/BeanFactory和FactoryBean的区别.html" class="sidebar-link">BeanFactory和FactoryBean的区别</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Mybatis</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/mybatis/MyBatis的SQL执行流程分析.html" class="sidebar-link">MyBatis的SQL执行流程分析</a></li><li><a href="/mybatis/MyBatisPlus.html" class="sidebar-link">MyBatisPlus</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>SpringBoot</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/springboot/SpringBoot经典学习笔记.html" class="sidebar-link">SpringBoot经典学习笔记</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Spring Cloud</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/springcloud/springcloud-day1.html" class="sidebar-link">springcloud-day1</a></li><li><a href="/springcloud/springcloud-day2.html" class="sidebar-link">springcloud-day2</a></li><li><a href="/springcloud/springcloud-day3.html" aria-current="page" class="active sidebar-link">springcloud-day3</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/springcloud/springcloud-day3.html#_1-微服务网关概述" class="sidebar-link">1 微服务网关概述</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/springcloud/springcloud-day3.html#_1-1-服务网关的概念" class="sidebar-link">1.1 服务网关的概念</a></li><li class="sidebar-sub-header"><a href="/springcloud/springcloud-day3.html#_1-1-1-什么是微服务网关" class="sidebar-link" style="padding-left:3rem;">1.1.1 什么是微服务网关</a></li><li class="sidebar-sub-header"><a href="/springcloud/springcloud-day3.html#_1-1-2-作用和应用场景" class="sidebar-link" style="padding-left:3rem;">1.1.2 作用和应用场景</a></li><li class="sidebar-sub-header"><a href="/springcloud/springcloud-day3.html#_1-2-常见的api网关实现方式" class="sidebar-link">1.2 常见的API网关实现方式</a></li><li class="sidebar-sub-header"><a href="/springcloud/springcloud-day3.html#_1-3-基于nginx的网关实现" class="sidebar-link">1.3 基于Nginx的网关实现</a></li><li class="sidebar-sub-header"><a href="/springcloud/springcloud-day3.html#_1-3-1-nginx介绍" class="sidebar-link" style="padding-left:3rem;">1.3.1 Nginx介绍</a></li><li class="sidebar-sub-header"><a href="/springcloud/springcloud-day3.html#_1-3-2-正向-反向代理" class="sidebar-link" style="padding-left:3rem;">1.3.2 正向/反向代理</a></li><li class="sidebar-sub-header"><a href="/springcloud/springcloud-day3.html#_1-3-3-准备工作" class="sidebar-link" style="padding-left:3rem;">1.3.3 准备工作</a></li><li class="sidebar-sub-header"><a href="/springcloud/springcloud-day3.html#_1-3-4-配置nginx的请求转发" class="sidebar-link" style="padding-left:3rem;">1.3.4 配置Nginx的请求转发</a></li></ul></li><li class="sidebar-sub-header"><a href="/springcloud/springcloud-day3.html#_2-微服务网关zuul" class="sidebar-link">2 微服务网关Zuul</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/springcloud/springcloud-day3.html#_2-1-zuul简介" class="sidebar-link">2.1 Zuul简介</a></li><li class="sidebar-sub-header"><a href="/springcloud/springcloud-day3.html#_2-2-搭建zuul网关服务器" class="sidebar-link">2.2 搭建Zuul网关服务器</a></li><li class="sidebar-sub-header"><a href="/springcloud/springcloud-day3.html#_2-3-zuul中的路由转发" class="sidebar-link">2.3 Zuul中的路由转发</a></li><li class="sidebar-sub-header"><a href="/springcloud/springcloud-day3.html#_2-3-1-面向服务的路由" class="sidebar-link" style="padding-left:3rem;">2.3.1 面向服务的路由</a></li><li class="sidebar-sub-header"><a href="/springcloud/springcloud-day3.html#_2-3-2-简化的路由配置" class="sidebar-link" style="padding-left:3rem;">2.3.2 简化的路由配置</a></li><li class="sidebar-sub-header"><a href="/springcloud/springcloud-day3.html#_2-3-3-默认的路由规则" class="sidebar-link" style="padding-left:3rem;">2.3.3 默认的路由规则</a></li><li class="sidebar-sub-header"><a href="/springcloud/springcloud-day3.html#_2-3-4-zuul加入后的架构" class="sidebar-link" style="padding-left:3rem;">2.3.4 Zuul加入后的架构</a></li><li class="sidebar-sub-header"><a href="/springcloud/springcloud-day3.html#_2-4-zuul中的过滤器" class="sidebar-link">2.4 Zuul中的过滤器</a></li><li class="sidebar-sub-header"><a href="/springcloud/springcloud-day3.html#_2-4-1-zuulfilter简介" class="sidebar-link" style="padding-left:3rem;">2.4.1 ZuulFilter简介</a></li><li class="sidebar-sub-header"><a href="/springcloud/springcloud-day3.html#_2-4-2-生命周期" class="sidebar-link" style="padding-left:3rem;">2.4.2 生命周期</a></li><li class="sidebar-sub-header"><a href="/springcloud/springcloud-day3.html#_2-4-3-自定义过滤器" class="sidebar-link" style="padding-left:3rem;">2.4.3 自定义过滤器</a></li><li class="sidebar-sub-header"><a href="/springcloud/springcloud-day3.html#_2-5-服务网关zuul的核心源码解析" class="sidebar-link">2.5 服务网关Zuul的核心源码解析</a></li><li class="sidebar-sub-header"><a href="/springcloud/springcloud-day3.html#_2-6-zuul网关存在的问题" class="sidebar-link">2.6 Zuul网关存在的问题</a></li><li class="sidebar-sub-header"><a href="/springcloud/springcloud-day3.html#_2-7-zuul网关的替换方案" class="sidebar-link">2.7 Zuul网关的替换方案</a></li></ul></li><li class="sidebar-sub-header"><a href="/springcloud/springcloud-day3.html#_3-微服务网关gateway" class="sidebar-link">3 微服务网关GateWay</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/springcloud/springcloud-day3.html#_3-1-gateway简介" class="sidebar-link">3.1 Gateway简介</a></li><li class="sidebar-sub-header"><a href="/springcloud/springcloud-day3.html#_3-1-1-简介" class="sidebar-link" style="padding-left:3rem;">3.1.1 简介</a></li><li class="sidebar-sub-header"><a href="/springcloud/springcloud-day3.html#_3-1-2-核心概念" class="sidebar-link" style="padding-left:3rem;">3.1.2 核心概念</a></li><li class="sidebar-sub-header"><a href="/springcloud/springcloud-day3.html#_3-2-入门案例" class="sidebar-link">3.2 入门案例</a></li><li class="sidebar-sub-header"><a href="/springcloud/springcloud-day3.html#_3-2-1-入门案例" class="sidebar-link" style="padding-left:3rem;">3.2.1 入门案例</a></li><li class="sidebar-sub-header"><a href="/springcloud/springcloud-day3.html#_3-2-2-路由规则" class="sidebar-link" style="padding-left:3rem;">3.2.2 路由规则</a></li><li class="sidebar-sub-header"><a href="/springcloud/springcloud-day3.html#_3-2-3-动态路由" class="sidebar-link" style="padding-left:3rem;">3.2.3 动态路由</a></li><li class="sidebar-sub-header"><a href="/springcloud/springcloud-day3.html#_3-2-4-重写转发路径" class="sidebar-link" style="padding-left:3rem;">3.2.4 重写转发路径</a></li><li class="sidebar-sub-header"><a href="/springcloud/springcloud-day3.html#_3-3-过滤器" class="sidebar-link">3.3 过滤器</a></li><li class="sidebar-sub-header"><a href="/springcloud/springcloud-day3.html#_3-3-1-过滤器基础" class="sidebar-link" style="padding-left:3rem;">3.3.1 过滤器基础</a></li><li class="sidebar-sub-header"><a href="/springcloud/springcloud-day3.html#_3-3-2-局部过滤器" class="sidebar-link" style="padding-left:3rem;">3.3.2 局部过滤器</a></li><li class="sidebar-sub-header"><a href="/springcloud/springcloud-day3.html#_3-3-3-全局过滤器" class="sidebar-link" style="padding-left:3rem;">3.3.3 全局过滤器</a></li><li class="sidebar-sub-header"><a href="/springcloud/springcloud-day3.html#_3-4-统一鉴权" class="sidebar-link">3.4 统一鉴权</a></li><li class="sidebar-sub-header"><a href="/springcloud/springcloud-day3.html#_3-4-1-鉴权逻辑" class="sidebar-link" style="padding-left:3rem;">3.4.1 鉴权逻辑</a></li><li class="sidebar-sub-header"><a href="/springcloud/springcloud-day3.html#_3-4-2-代码实现" class="sidebar-link" style="padding-left:3rem;">3.4.2 代码实现</a></li><li class="sidebar-sub-header"><a href="/springcloud/springcloud-day3.html#_3-5-网关限流" class="sidebar-link">3.5 网关限流</a></li><li class="sidebar-sub-header"><a href="/springcloud/springcloud-day3.html#_3-5-1-常见的限流算法" class="sidebar-link" style="padding-left:3rem;">3.5.1 常见的限流算法</a></li><li class="sidebar-sub-header"><a href="/springcloud/springcloud-day3.html#_3-5-2-基于filter的限流" class="sidebar-link" style="padding-left:3rem;">3.5.2 基于Filter的限流</a></li><li class="sidebar-sub-header"><a href="/springcloud/springcloud-day3.html#_3-5-3-基于sentinel的限流" class="sidebar-link" style="padding-left:3rem;">3.5.3 基于Sentinel的限流</a></li><li class="sidebar-sub-header"><a href="/springcloud/springcloud-day3.html#_3-6-网关高可用" class="sidebar-link">3.6 网关高可用</a></li><li class="sidebar-sub-header"><a href="/springcloud/springcloud-day3.html#_3-7-执行流程分析" class="sidebar-link">3.7 执行流程分析</a></li></ul></li><li class="sidebar-sub-header"><a href="/springcloud/springcloud-day3.html#_4-微服务的链路追踪概述" class="sidebar-link">4 微服务的链路追踪概述</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/springcloud/springcloud-day3.html#_4-1-微服务架构下的问题" class="sidebar-link">4.1 微服务架构下的问题</a></li><li class="sidebar-sub-header"><a href="/springcloud/springcloud-day3.html#_4-2-sleuth概述" class="sidebar-link">4.2 Sleuth概述</a></li><li class="sidebar-sub-header"><a href="/springcloud/springcloud-day3.html#_4-2-1-简介" class="sidebar-link" style="padding-left:3rem;">4.2.1 简介</a></li><li class="sidebar-sub-header"><a href="/springcloud/springcloud-day3.html#_4-2-2-相关概念" class="sidebar-link" style="padding-left:3rem;">4.2.2 相关概念</a></li><li class="sidebar-sub-header"><a href="/springcloud/springcloud-day3.html#_4-3-链路追踪sleuth入门" class="sidebar-link" style="padding-left:3rem;">4.3 链路追踪Sleuth入门</a></li><li class="sidebar-sub-header"><a href="/springcloud/springcloud-day3.html#_4-4-zipkin的概述" class="sidebar-link" style="padding-left:3rem;">4.4 Zipkin的概述</a></li><li class="sidebar-sub-header"><a href="/springcloud/springcloud-day3.html#_4-5-zipkin-server的部署和配置" class="sidebar-link" style="padding-left:3rem;">4.5 Zipkin Server的部署和配置</a></li><li class="sidebar-sub-header"><a href="/springcloud/springcloud-day3.html#_4-6-客户端zipkin-sleuth整合" class="sidebar-link" style="padding-left:3rem;">4.6 客户端Zipkin+Sleuth整合</a></li><li class="sidebar-sub-header"><a href="/springcloud/springcloud-day3.html#_4-7-基于消息中间件收集数据" class="sidebar-link" style="padding-left:3rem;">4.7 基于消息中间件收集数据</a></li><li class="sidebar-sub-header"><a href="/springcloud/springcloud-day3.html#_4-7-1-rabbitmq的安装与启动" class="sidebar-link" style="padding-left:4rem;">4.7.1 RabbitMQ的安装与启动</a></li><li class="sidebar-sub-header"><a href="/springcloud/springcloud-day3.html#_4-7-2-服务端启动" class="sidebar-link" style="padding-left:4rem;">4.7.2 服务端启动</a></li><li class="sidebar-sub-header"><a href="/springcloud/springcloud-day3.html#_7-7-3-客户端配置" class="sidebar-link" style="padding-left:4rem;">7.7.3 客户端配置</a></li><li class="sidebar-sub-header"><a href="/springcloud/springcloud-day3.html#_4-8-存储跟踪数据" class="sidebar-link" style="padding-left:3rem;">4.8 存储跟踪数据</a></li><li class="sidebar-sub-header"><a href="/springcloud/springcloud-day3.html#_4-8-1-准备数据库" class="sidebar-link" style="padding-left:4rem;">4.8.1 准备数据库</a></li><li class="sidebar-sub-header"><a href="/springcloud/springcloud-day3.html#_4-8-2-配置启动服务端" class="sidebar-link" style="padding-left:4rem;">4.8.2 配置启动服务端</a></li></ul></li></ul></li><li><a href="/springcloud/springcloud-day4.html" class="sidebar-link">springcloud-day4</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Netty</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/netty/Netty核心技术及源码剖析.html" class="sidebar-link">Netty核心技术及源码剖析</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>K8S</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/k8s/k8s-黑马.html" class="sidebar-link">k8s-黑马教程</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Linux</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/linux/Centos6.8安装mysql6.54.html" class="sidebar-link">Centos6.8安装mysql6.54</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>工具集</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/utils/完整的身份证正则表达式.html" class="sidebar-link">完整的身份证正则表达式</a></li><li><a href="/utils/Java自带工具方法.html" class="sidebar-link">Java自带工具方法</a></li></ul></section></li><li><a href="/about.html" class="sidebar-link">关于</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h2 id="_1-微服务网关概述"><a href="#_1-微服务网关概述" class="header-anchor">#</a> 1 微服务网关概述</h2> <p>在学习完前面的知识后，微服务架构已经初具雏形。但还有一些问题：不同的微服务一般会有不同的网
络地址，客户端在访问这些微服务时必须记住几十甚至几百个地址，这对于客户端方来说太复杂也难以
维护。如下图：</p> <img src="/assets/img/image-20220306102932415.0360133a.png" alt="image-20220306102932415" style="zoom:30%;"> <p>如果让客户端直接与各个微服务通讯，可能会有很多问题：</p> <ul><li>客户端会请求多个不同的服务，需要维护不同的请求地址，增加开发难度</li> <li>在某些场景下存在跨域请求的问题</li> <li>加大身份认证的难度，每个微服务需要独立认证</li></ul> <p>因此，我们需要一个微服务网关，介于客户端与服务器之间的中间层，所有的外部请求都会先经过微服
务网关。客户端只需要与网关交互，只知道一个网关地址即可，这样简化了开发还有以下优点：</p> <ul><li>1、易于监控</li> <li>2、易于认证</li> <li>3、减少了客户端与各个微服务之间的交互次数</li></ul> <img src="/assets/img/image-20220306103101124.d78c3c02.png" alt="image-20220306103101124" style="zoom:50%;"> <h3 id="_1-1-服务网关的概念"><a href="#_1-1-服务网关的概念" class="header-anchor">#</a> 1.1 服务网关的概念</h3> <h4 id="_1-1-1-什么是微服务网关"><a href="#_1-1-1-什么是微服务网关" class="header-anchor">#</a> 1.1.1 什么是微服务网关</h4> <p>​	API网关是一个服务器，是系统对外的唯一入口。API网关封装了系统内部架构，为每个客户端提供一个定制的API。API网关方式的核心要点是，所有的客户端和消费端都通过统一的网关接入微服务，在网关层处理所有的非业务功能。通常，网关也是提供REST/HTTP的访问API。服务端通过API-GW注册和管理服务。</p> <h4 id="_1-1-2-作用和应用场景"><a href="#_1-1-2-作用和应用场景" class="header-anchor">#</a> 1.1.2 作用和应用场景</h4> <p>网关具有的职责，如身份验证、监控、负载均衡、缓存、请求分片与管理、静态响应处理。当然，最主要的职责还是与“外界联系”。</p> <h3 id="_1-2-常见的api网关实现方式"><a href="#_1-2-常见的api网关实现方式" class="header-anchor">#</a> 1.2 常见的API网关实现方式</h3> <p><strong>Kong</strong></p> <p>基于Nginx+Lua开发，性能高，稳定，有多个可用的插件(限流、鉴权等等)可以开箱即用。问题：只支持Http协议；二次开发，自由扩展困难；提供管理API，缺乏更易用的管控、配置方式。</p> <p><strong>Zuul</strong></p> <p>Netflix开源，功能丰富，使用JAVA开发，易于二次开发；需要运行在web容器中，如Tomcat。
问题：缺乏管控，无法动态配置；依赖组件较多；处理Http请求依赖的是Web容器，性能不如Nginx；</p> <p><strong>Traefik</strong></p> <p>Go语言开发；轻量易用；提供大多数的功能：服务路由，负载均衡等等；提供WebUI
问题：二进制文件部署，二次开发难度大；UI更多的是监控，缺乏配置、管理能力；</p> <p><strong>Spring Cloud Gateway</strong></p> <p>SpringCloud提供的网关服务</p> <p><strong>Nginx+lua实现</strong></p> <p>使用Nginx的反向代理和负载均衡可实现对api服务器的负载均衡及高可用
问题：自注册的问题和网关本身的扩展性</p> <h3 id="_1-3-基于nginx的网关实现"><a href="#_1-3-基于nginx的网关实现" class="header-anchor">#</a> 1.3 基于Nginx的网关实现</h3> <h4 id="_1-3-1-nginx介绍"><a href="#_1-3-1-nginx介绍" class="header-anchor">#</a> 1.3.1 Nginx介绍</h4> <img src="/assets/img/image-20220306103326039.a4ffb4a6.png" alt="image-20220306103326039" style="zoom:50%;"> <h4 id="_1-3-2-正向-反向代理"><a href="#_1-3-2-正向-反向代理" class="header-anchor">#</a> 1.3.2 正向/反向代理</h4> <p><strong>（1）正向代理</strong></p> <img src="/assets/img/image-20220306103343136.11b0f825.png" alt="image-20220306103343136" style="zoom:50%;"> <p>正向代理，&quot;它代理的是客户端，代客户端发出请求&quot;，是一个位于客户端和原始服务器(origin server)之
间的服务器，为了从原始服务器取得内容，客户端向代理发送一个请求并指定目标(原始服务器)，然后
代理向原始服务器转交请求并将获得的内容返回给客户端。客户端必须要进行一些特别的设置才能使用
正向代理。</p> <p><strong>（2）反向代理</strong></p> <img src="/assets/img/image-20220306103415413.c6ecf67c.png" alt="image-20220306103415413" style="zoom:50%;"> <p>多个客户端给服务器发送的请求，Nginx服务器接收到之后，按照一定的规则分发给了后端的业务处理服务器进行处理了。此时~请求的来源也就是客户端是明确的，但是请求具体由哪台服务器处理的并不明确了，Nginx扮演的就是一个反向代理角色。客户端是无感知代理的存在的，反向代理对外都是透明的，访问者并不知道自己访问的是一个代理。因为客户端不需要任何配置就可以访问。反向代
理，&quot;它代理的是服务端，代服务端接收请求&quot;，主要用于服务器集群分布式部署的情况下，反向代理隐藏了服务器的信息
如果只是单纯的需要一个最基础的具备转发功能的网关，那么使用Ngnix是一个不错的选择。</p> <h4 id="_1-3-3-准备工作"><a href="#_1-3-3-准备工作" class="header-anchor">#</a> 1.3.3 准备工作</h4> <p>启动 shop_service_order 微服务，单独请求地址：http://127.0.0.1:9001/</p> <p>启动 shop_service_product 微服务,单独请求地址：http://127.0.0.1:9002/</p> <p>安装资料中提供的ngnix。找到ngnix.exe双击运行即可</p> <img src="/assets/img/image-20220306103454696.e73d2667.png" alt="image-20220306103454696" style="zoom:50%;"> <h4 id="_1-3-4-配置nginx的请求转发"><a href="#_1-3-4-配置nginx的请求转发" class="header-anchor">#</a> 1.3.4 配置Nginx的请求转发</h4> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token keyword">location</span> <span class="token operator">/</span>api<span class="token operator">-</span>order <span class="token punctuation">{</span>
 <span class="token keyword">proxy_pass</span> <span class="token keyword">http</span><span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span><span class="token punctuation">:</span><span class="token number">9001</span><span class="token operator">/</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">location</span> <span class="token operator">/</span>api<span class="token operator">-</span>product <span class="token punctuation">{</span>
 <span class="token keyword">proxy_pass</span> <span class="token keyword">http</span><span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span><span class="token punctuation">:</span><span class="token number">9002</span><span class="token operator">/</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="_2-微服务网关zuul"><a href="#_2-微服务网关zuul" class="header-anchor">#</a> 2 微服务网关Zuul</h2> <h3 id="_2-1-zuul简介"><a href="#_2-1-zuul简介" class="header-anchor">#</a> 2.1 Zuul简介</h3> <p>ZUUL是Netflix开源的微服务网关，它可以和Eureka、Ribbon、Hystrix等组件配合使用，Zuul组件的核心是一系列的过滤器，这些过滤器可以完成以下功能：</p> <ul><li>动态路由：动态将请求路由到不同后端集群</li> <li>压力测试：逐渐增加指向集群的流量，以了解性能</li> <li>负载分配：为每一种负载类型分配对应容量，并弃用超出限定值的请求</li> <li>静态响应处理：边缘位置进行响应，避免转发到内部集群</li> <li>身份认证和安全: 识别每一个资源的验证要求，并拒绝那些不符的请求。Spring Cloud对Zuul进行了整合和增强。</li></ul> <p>Spring Cloud对Zuul进行了整合和增强</p> <h3 id="_2-2-搭建zuul网关服务器"><a href="#_2-2-搭建zuul网关服务器" class="header-anchor">#</a> 2.2 搭建Zuul网关服务器</h3> <p><strong>（1）创建工程导入依赖</strong></p> <p>在IDEA中创建ZUUL网关工程 shop_zuul_server ，并添加响应依赖</p> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-netflix-zuul<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>2.1.0.RELEASE<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p><strong>（2）编写启动类</strong></p> <p>创建启动类 ZuulServerApplication</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@SpringBootApplication</span> 
<span class="token annotation punctuation">@EnableZuulProxy</span> <span class="token comment">// 开启Zuul的网关功能 </span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ZuulServerApplication</span> <span class="token punctuation">{</span> 
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span> 
    <span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">ZuulServerApplication</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token punctuation">}</span> 
<span class="token punctuation">}</span>
</code></pre></div><ul><li>@EnableZuulProxy ： 通过 @EnableZuulProxy 注解开启Zuul网管功能</li></ul> <p><strong>（3）编写配置</strong>
创建配置文件 application.yml ，并添加相应配置</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">server</span><span class="token punctuation">:</span> 
	<span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8080</span> <span class="token comment">#服务端口 </span>
<span class="token key atrule">spring</span><span class="token punctuation">:</span> 
	<span class="token key atrule">application</span><span class="token punctuation">:</span> 
		<span class="token key atrule">name</span><span class="token punctuation">:</span> api<span class="token punctuation">-</span>gateway <span class="token comment">#指定服务名 </span>
</code></pre></div><h3 id="_2-3-zuul中的路由转发"><a href="#_2-3-zuul中的路由转发" class="header-anchor">#</a> 2.3 Zuul中的路由转发</h3> <p>最直观的理解：“路由”是指根据请求URL，将请求分配到对应的处理程序。在微服务体系中，Zuul负责
接收所有的请求。根据不同的URL匹配规则，将不同的请求转发到不同的微服务处理。</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">zuul</span><span class="token punctuation">:</span> 
  <span class="token key atrule">routes</span><span class="token punctuation">:</span> 
    <span class="token key atrule">product-service</span><span class="token punctuation">:</span> <span class="token comment"># 这里是路由id，随意写 </span>
      <span class="token key atrule">path</span><span class="token punctuation">:</span> /product<span class="token punctuation">-</span>service/<span class="token important">**</span> <span class="token comment"># 这里是映射路径 </span>
      <span class="token key atrule">url</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//127.0.0.1<span class="token punctuation">:</span><span class="token number">9002</span> <span class="token comment"># 映射路径对应的实际url地址 </span>
      <span class="token key atrule">sensitiveHeaders</span><span class="token punctuation">:</span> <span class="token comment">#默认zuul会屏蔽cookie，cookie不会传到下游服务，这里设置为空则取 消默认的黑名单，如果设置了具体的头信息则不会传到下游服务</span>
</code></pre></div><p>只需要在application.yml文件中配置路由规则即可：</p> <ul><li>product-service：配置路由id，可以随意取名</li> <li>url：映射路径对应的实际url地址</li> <li>path：配置映射路径，这里将所有请求前缀为/product-service/的请求，转发到http://127.0.0.1:9002处理</li></ul> <p>配置好Zuul路由之后启动服务，在浏览器中输入 http://localhost:8080/product- service/product/1 ，即可访问到订单微服务。</p> <img src="/assets/img/image-20220306104253701.4c3fb138.png" alt="image-20220306104253701" style="zoom:50%;"> <h4 id="_2-3-1-面向服务的路由"><a href="#_2-3-1-面向服务的路由" class="header-anchor">#</a> 2.3.1 面向服务的路由</h4> <p>微服务一般是由几十、上百个服务组成，对于一个URL请求，最终会确认一个服务实例进行处理。如果
对每个服务实例手动指定一个唯一访问地址，然后根据URL去手动实现请求匹配，这样做显然就不合
理。</p> <p>Zuul支持与Eureka整合开发，根据ServiceID自动的从注册中心中获取服务地址并转发请求，这样做的
好处不仅可以通过单个端点来访问应用的所有服务，而且在添加或移除服务实例的时候不用修改Zuul的
路由配置。</p> <p><strong>（1）添加Eureka客户端依赖</strong></p> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span> 
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span> 
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-netflix-eureka-client<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span> 
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span> 
</code></pre></div><p><strong>（2）开启Eureka客户端发现功能</strong></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@SpringBootApplication</span> 
<span class="token annotation punctuation">@EnableZuulProxy</span> <span class="token comment">// 开启Zuul的网关功能 </span>
<span class="token annotation punctuation">@EnableDiscoveryClient</span> 
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ZuulServerApplication</span> <span class="token punctuation">{</span> 
  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span> 
    <span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">ZuulServerApplication</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span> 
<span class="token punctuation">}</span>
</code></pre></div><p><strong>（3）添加Eureka配置，获取服务信息</strong></p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">eureka</span><span class="token punctuation">:</span> 
  <span class="token key atrule">client</span><span class="token punctuation">:</span> 
    <span class="token key atrule">serviceUrl</span><span class="token punctuation">:</span> 
      <span class="token key atrule">defaultZone</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//127.0.0.1<span class="token punctuation">:</span>8761/eureka/ 
      <span class="token key atrule">registry-fetch-interval-seconds</span><span class="token punctuation">:</span> <span class="token number">5</span> <span class="token comment"># 获取服务列表的周期：5s </span>
  <span class="token key atrule">instance</span><span class="token punctuation">:</span> 
    <span class="token key atrule">preferIpAddress</span><span class="token punctuation">:</span> <span class="token boolean important">true</span> 
    <span class="token key atrule">ip-address</span><span class="token punctuation">:</span> 127.0.0.1
</code></pre></div><p><strong>（4）修改映射配置，通过服务名称获取</strong></p> <p>因为已经有了Eureka客户端，我们可以从Eureka获取服务的地址信息，因此映射时无需指定IP地址，而
是通过服务名称来访问，而且Zuul已经集成了Ribbon的负载均衡功能。</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code> <span class="token comment">#配置路由规则 </span>
 <span class="token key atrule">zuul</span><span class="token punctuation">:</span> 
 	<span class="token key atrule">routes</span><span class="token punctuation">:</span> 
 		<span class="token key atrule">product-service</span><span class="token punctuation">:</span> <span class="token comment"># 这里是路由id，随意写 </span>
 			<span class="token key atrule">path</span><span class="token punctuation">:</span> /product<span class="token punctuation">-</span>service/<span class="token important">**</span> <span class="token comment"># 这里是映射路径 </span>
 			<span class="token key atrule">serviceId</span><span class="token punctuation">:</span> shop<span class="token punctuation">-</span>service<span class="token punctuation">-</span>product <span class="token comment">#配置转发的微服务名称</span>
</code></pre></div><ul><li>serviceId: 指定需要转发的微服务实例名称</li></ul> <p>依次启动Eureka，商品微服务，API网关，在浏览器上通过访问 <code>http://localhost:8080/product-service/product/1</code> 查看最终效果。</p> <h4 id="_2-3-2-简化的路由配置"><a href="#_2-3-2-简化的路由配置" class="header-anchor">#</a> 2.3.2 简化的路由配置</h4> <p>在刚才的配置中，我们的规则是这样的：</p> <ul><li><code>zuul.routes.&lt;route&gt;.path=/xxx/**</code> ： 来指定映射路径。 <code>&lt;route&gt;</code> 是自定义的路由名</li> <li><code>zuul.routes.&lt;route&gt;.serviceId=/product-service</code> ：来指定服务名。</li></ul> <p>而大多数情况下，我们的 <code>&lt;route&gt;</code> 路由名称往往和服务名会写成一样的。因此Zuul就提供了一种简化的
配置语法： <code>zuul.routes.&lt;serviceId&gt;=&lt;path&gt;</code></p> <p>上面的配置可以简化为一条：</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">zuul</span><span class="token punctuation">:</span> 
	<span class="token key atrule">routes</span><span class="token punctuation">:</span> 
		<span class="token key atrule">shop-service-product</span><span class="token punctuation">:</span> /product<span class="token punctuation">-</span>service/<span class="token important">**</span>
</code></pre></div><h4 id="_2-3-3-默认的路由规则"><a href="#_2-3-3-默认的路由规则" class="header-anchor">#</a> 2.3.3 默认的路由规则</h4> <p>在使用Zuul的过程中，上面讲述的规则已经大大的简化了配置项。但是当服务较多时，配置也是比较繁琐的。因此Zuul就指定了默认的路由规则：</p> <ul><li>默认情况下，一切服务的映射路径就是服务名本身。
<ul><li>例如服务名为： <code>shop-service-product</code> ，则默认的映射路径就是： <code>/shop-service- product/**</code></li></ul></li></ul> <h4 id="_2-3-4-zuul加入后的架构"><a href="#_2-3-4-zuul加入后的架构" class="header-anchor">#</a> 2.3.4 Zuul加入后的架构</h4> <img src="/assets/img/image-20220306104837717.e72e5b7c.png" alt="image-20220306104837717" style="zoom:50%;"> <h3 id="_2-4-zuul中的过滤器"><a href="#_2-4-zuul中的过滤器" class="header-anchor">#</a> 2.4 Zuul中的过滤器</h3> <p>通过之前的学习，我们得知Zuul它包含了两个核心功能：对请求的<strong>路由</strong>和<strong>过滤</strong>。其中路由功能负责将外部请求转发到具体的微服务实例上，是实现外部访问统一入口的基础；而过滤器功能则负责对请求的处理过程进行干预，是实现请求校验、服务聚合等功能的基础。其实，路由功能在真正运行时，它的路由映射和请求转发同样也由几个不同的过滤器完成的。所以，过滤器可以说是Zuul实现API网关功能最为核心的部件，每一个进入Zuul的HTTP请求都会经过一系列的过滤器处理链得到请求响应并返回给客户端。</p> <p>那么接下来，我们重点学习的就是Zuul的第二个核心功能：<strong>过滤器</strong>。</p> <h4 id="_2-4-1-zuulfilter简介"><a href="#_2-4-1-zuulfilter简介" class="header-anchor">#</a> 2.4.1 ZuulFilter简介</h4> <p>Zuul 中的过滤器跟我们之前使用的 javax.servlet.Filter 不一样，javax.servlet.Filter 只有一种类型，可
以通过配置 urlPatterns 来拦截对应的请求。而 Zuul 中的过滤器总共有 4 种类型，且每种类型都有对
应的使用场景。</p> <ol><li><strong>PRE</strong>：这种过滤器在请求被路由之前调用。我们可利用这种过滤器实现身份验证、在集群中选择请
求的微服务、记录调试信息等。</li> <li><strong>ROUTING</strong>：这种过滤器将请求路由到微服务。这种过滤器用于构建发送给微服务的请求，并使用
Apache HttpClient或Netfilx Ribbon请求微服务。</li> <li><strong>POST</strong>：这种过滤器在路由到微服务以后执行。这种过滤器可用来为响应添加标准的HTTP
Header、收集统计信息和指标、将响应从微服务发送给客户端等。</li> <li><strong>ERROR</strong>：在其他阶段发生错误时执行该过滤器。</li></ol> <p>Zuul提供了自定义过滤器的功能实现起来也十分简单，只需要编写一个类去实现zuul提供的接口</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token class-name">ZuulFilter</span> <span class="token keyword">implements</span> <span class="token class-name">IZuulFilter</span><span class="token punctuation">{</span> 
  <span class="token keyword">abstract</span> <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">filterType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token keyword">abstract</span> <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">filterOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token keyword">boolean</span> <span class="token function">shouldFilter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 来自IZuulFilter </span>
  <span class="token class-name">Object</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ZuulException</span><span class="token punctuation">;</span><span class="token comment">// IZuulFilter </span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li><code>ZuulFilter</code>是过滤器的顶级父类。在这里我们看一下其中定义的4个最重要的方法</li> <li><code>shouldFilter</code> ：返回一个 <code>Boolean</code> 值，判断该过滤器是否需要执行。返回<code>true</code>执行，返回<code>false</code>不执行。</li> <li><code>run</code> ：过滤器的具体业务逻辑。</li> <li><code>filterType</code> ：返回字符串，代表过滤器的类型。包含以下4种：
<ul><li><code>pre</code> ：请求在被路由之前执行</li> <li><code>routing</code> ：在路由请求时调用</li> <li><code>post</code> ：在routing和errror过滤器之后调用</li> <li><code>error</code> ：处理请求时发生错误调用</li></ul></li> <li><code>filterOrder</code> ：通过返回的int值来定义过滤器的执行顺序，数字越小优先级越高。</li></ul> <h4 id="_2-4-2-生命周期"><a href="#_2-4-2-生命周期" class="header-anchor">#</a> 2.4.2 生命周期</h4> <img src="/assets/img/image-20220306105318290.1e6c7586.png" alt="image-20220306105318290" style="zoom:67%;"> <ul><li>正常流程：
<ul><li>请求到达首先会经过pre类型过滤器，而后到达routing类型，进行路由，请求就到达真正的服务提供者，执行请求，返回结果后，会到达post过滤器。而后返回响应。</li></ul></li> <li>异常流程：
<ul><li>整个过程中，pre或者routing过滤器出现异常，都会直接进入error过滤器，再error处理完毕后，会将请求交给POST过滤器，最后返回给用户。</li> <li>如果是error过滤器自己出现异常，最终也会进入POST过滤器，而后返回。</li> <li>如果是POST过滤器出现异常，会跳转到error过滤器，但是与pre和routing不同的时，请求不会再到达POST过滤器了。</li></ul></li> <li>不同过滤器的场景：
<ul><li>请求鉴权：一般放在pre类型，如果发现没有访问权限，直接就拦截了</li> <li>异常处理：一般会在error类型和post类型过滤器中结合来处理。</li> <li>服务调用时长统计：pre和post结合使用。</li></ul></li></ul> <p>所有内置过滤器列表：</p> <img src="/assets/img/image-20220306105438627.a1cd1f4a.png" alt="image-20220306105438627" style="zoom:50%;"> <h4 id="_2-4-3-自定义过滤器"><a href="#_2-4-3-自定义过滤器" class="header-anchor">#</a> 2.4.3 自定义过滤器</h4> <p>接下来我们来自定义一个过滤器，模拟一个登录的校验。基本逻辑：如果请求中有access-token参数，
则认为请求有效，放行。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Component</span> 
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LoginFilter</span> <span class="token keyword">extends</span> <span class="token class-name">ZuulFilter</span><span class="token punctuation">{</span> 
  <span class="token annotation punctuation">@Override</span> 
  <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">filterType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
    <span class="token comment">// 登录校验，肯定是在前置拦截 </span>
    <span class="token keyword">return</span> <span class="token string">&quot;pre&quot;</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span>
  <span class="token annotation punctuation">@Override</span> 
  <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">filterOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
    <span class="token comment">// 顺序设置为1 </span>
    <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span>
  <span class="token annotation punctuation">@Override</span> 
  <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">shouldFilter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
    <span class="token comment">// 返回true，代表过滤器生效。 </span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span>
  <span class="token annotation punctuation">@Override</span> 
  <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ZuulException</span> <span class="token punctuation">{</span> 
    <span class="token comment">// 登录校验逻辑。 </span>
    <span class="token comment">// 1）获取Zuul提供的请求上下文对象 </span>
    <span class="token class-name">RequestContext</span> ctx <span class="token operator">=</span> <span class="token class-name">RequestContext</span><span class="token punctuation">.</span><span class="token function">getCurrentContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 2) 从上下文中获取request对象 </span>
    <span class="token class-name">HttpServletRequest</span> req <span class="token operator">=</span> ctx<span class="token punctuation">.</span><span class="token function">getRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token comment">// 3) 从请求中获取token </span>
    <span class="token class-name">String</span> token <span class="token operator">=</span> req<span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span><span class="token string">&quot;access-token&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token comment">// 4) 判断 </span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>token <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>token<span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span> 
      <span class="token comment">// 没有token，登录校验失败，拦截 </span>
      ctx<span class="token punctuation">.</span><span class="token function">setSendZuulResponse</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token comment">// 返回401状态码。也可以考虑重定向到登录页。 </span>
      ctx<span class="token punctuation">.</span><span class="token function">setResponseStatusCode</span><span class="token punctuation">(</span><span class="token class-name">HttpStatus</span><span class="token punctuation">.</span>UNAUTHORIZED<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token punctuation">}</span>
    <span class="token comment">// 校验通过，可以考虑把用户信息放入上下文，继续向后执行 </span>
    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span> 
<span class="token punctuation">}</span>
</code></pre></div><ul><li>RequestContext：用于在过滤器之间传递消息。它的数据保存在每个请求的ThreadLocal中。它用于存储请求路由到哪里、错误、HttpServletRequest、HttpServletResponse都存储在RequestContext中。RequestContext扩展了ConcurrentHashMap，所以，任何数据都可以存储在上下文中</li></ul> <h3 id="_2-5-服务网关zuul的核心源码解析"><a href="#_2-5-服务网关zuul的核心源码解析" class="header-anchor">#</a> 2.5 服务网关Zuul的核心源码解析</h3> <img src="/assets/img/image-20220306112914362.9a38d5c8.png" alt="image-20220306112914362" style="zoom:50%;"> <p>在Zuul中， 整个请求的过程是这样的，首先将请求给zuulservlet处理，zuulservlet中有一个zuulRunner对象，该对象中初始化了RequestContext：作为存储整个请求的一些数据，并被所有的zuulfilter共享。zuulRunner中还有 FilterProcessor，FilterProcessor作为执行所有的zuulfilter的管理器。FilterProcessor从filterloader 中获取zuulfilter，而zuulfilter是被filterFileManager所加载，并支持groovy热加载，采用了轮询的方式热加载。有了这些filter之后，zuulservelet首先执行的Pre类型的过滤器，再执行route类型的过滤器，最后执行的是post 类型的过滤器，如果在执行这些过滤器有错误的时候则会执行error类型的过滤器。执行完这些过滤器，最终将请求的结果返回给客户端。</p> <p><strong>（1）初始化</strong></p> <p>SpringCloud对Zuul的封装使得发布一个ZuulServer无比简单，根据自动装载原则可以在 <code>spring- cloud-netflix-zuul-2.1.0.RELEASE.jar</code> 下找到 <code>spring.factories</code></p> <img src="/assets/img/image-20220306113041569.bfbf07b4.png" alt="image-20220306113041569" style="zoom:50%;"> <p><code>ZuulServerAutoConfiguration，ZuulProxyAutoConfiguration</code> 是Zuul服务端的自动配置类，这些
配置类究竟负责什么工作，我们继续来看</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Configuration</span> 
<span class="token annotation punctuation">@Import</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token class-name">RestClientRibbonConfiguration</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token class-name">OkHttpRibbonConfiguration</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span>
         <span class="token class-name">HttpClientRibbonConfiguration</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token class-name">HttpClientConfiguration</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">}</span><span class="token punctuation">)</span> 
<span class="token annotation punctuation">@ConditionalOnBean</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token class-name">Marker</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">}</span><span class="token punctuation">)</span> 
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ZuulProxyAutoConfiguration</span> <span class="token keyword">extends</span> <span class="token class-name">ZuulServerAutoConfiguration</span> <span class="token punctuation">{</span> 
  <span class="token comment">//省略 </span>
<span class="token punctuation">}</span>
</code></pre></div><p>ZuulProxyAutoConfiguration 继承了 ZuulServerAutoConfiguration ，我们先看下这个配置类</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Configuration</span> <span class="token annotation punctuation">@EnableConfigurationProperties</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token class-name">ZuulProperties</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">}</span><span class="token punctuation">)</span> 
<span class="token annotation punctuation">@ConditionalOnClass</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token class-name">ZuulServlet</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token class-name">ZuulServletFilter</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">}</span><span class="token punctuation">)</span> 
<span class="token annotation punctuation">@ConditionalOnBean</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token class-name">Marker</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">}</span><span class="token punctuation">)</span> 
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ZuulServerAutoConfiguration</span> <span class="token punctuation">{</span> 
  <span class="token annotation punctuation">@Bean</span> 
  <span class="token annotation punctuation">@Primary</span> 
  <span class="token keyword">public</span> <span class="token class-name">CompositeRouteLocator</span> <span class="token function">primaryRouteLocator</span><span class="token punctuation">(</span><span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">RouteLocator</span><span class="token punctuation">&gt;</span></span> routeLocators<span class="token punctuation">)</span> <span class="token punctuation">{</span> 
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">CompositeRouteLocator</span><span class="token punctuation">(</span>routeLocators<span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span>
  <span class="token annotation punctuation">@Bean</span> 
  <span class="token annotation punctuation">@ConditionalOnMissingBean</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token class-name">SimpleRouteLocator</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">}</span><span class="token punctuation">)</span> 
  <span class="token keyword">public</span> <span class="token class-name">SimpleRouteLocator</span> <span class="token function">simpleRouteLocator</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">SimpleRouteLocator</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>server<span class="token punctuation">.</span><span class="token function">getServlet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getContextPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>zuulProperties<span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span>
  <span class="token annotation punctuation">@Bean</span> 
  <span class="token keyword">public</span> <span class="token class-name">ZuulController</span> <span class="token function">zuulController</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ZuulController</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span>
  <span class="token annotation punctuation">@Configuration</span> 
  <span class="token keyword">protected</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">ZuulFilterConfiguration</span> <span class="token punctuation">{</span> 
    <span class="token annotation punctuation">@Autowired</span> 
    <span class="token keyword">private</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">ZuulFilter</span><span class="token punctuation">&gt;</span></span> filters<span class="token punctuation">;</span> 
    <span class="token keyword">protected</span> <span class="token class-name">ZuulFilterConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
    <span class="token punctuation">}</span>

<span class="token annotation punctuation">@Bean</span> 
    <span class="token keyword">public</span> <span class="token class-name">ZuulFilterInitializer</span> <span class="token function">zuulFilterInitializer</span><span class="token punctuation">(</span><span class="token class-name">CounterFactory</span> counterFactory<span class="token punctuation">,</span> <span class="token class-name">TracerFactory</span> tracerFactory<span class="token punctuation">)</span> <span class="token punctuation">{</span> 
      <span class="token class-name">FilterLoader</span> filterLoader <span class="token operator">=</span> <span class="token class-name">FilterLoader</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token class-name">FilterRegistry</span> filterRegistry <span class="token operator">=</span> <span class="token class-name">FilterRegistry</span><span class="token punctuation">.</span><span class="token function">instance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ZuulFilterInitializer</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>filters<span class="token punctuation">,</span> counterFactory<span class="token punctuation">,</span> tracerFactory<span class="token punctuation">,</span> filterLoader<span class="token punctuation">,</span> filterRegistry<span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token punctuation">}</span> 
  <span class="token punctuation">}</span><span class="token comment">//其他省略 </span>
<span class="token punctuation">}</span>
</code></pre></div><p>整理一下这里配置类里面做了哪些事情呢？</p> <ul><li>CompositeRouteLocator：组合路由定位器，看入参就知道应该是会保存好多个RouteLocator，构造过程中其实仅包括一个DiscoveryClientRouteLocator。</li> <li>SimpleRouteLocator：默认的路由定位器，主要负责维护配置文件中的路由配置。</li> <li>ZuulController：Zuul创建的一个Controller，用于将请求交由ZuulServlet处理。</li> <li>ZuulHandlerMapping：这个会添加到SpringMvc的HandlerMapping链中，只有选择了ZuulHandlerMapping的请求才能出发到Zuul的后续流程。</li> <li>注册ZuulFilterInitializer，通过FilterLoader加载应用中所有的过滤器并将过滤器注册到FilterRegistry，</li></ul> <p>那我们接下来一起看下过滤器是如何被加载到应用中的</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ZuulFilterInitializer</span> <span class="token punctuation">{</span> 
  <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Log</span> log <span class="token operator">=</span> <span class="token class-name">LogFactory</span><span class="token punctuation">.</span><span class="token function">getLog</span><span class="token punctuation">(</span><span class="token class-name">ZuulFilterInitializer</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">ZuulFilter</span><span class="token punctuation">&gt;</span></span> filters<span class="token punctuation">;</span> 
  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">CounterFactory</span> counterFactory<span class="token punctuation">;</span> 
  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">TracerFactory</span> tracerFactory<span class="token punctuation">;</span> 
  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">FilterLoader</span> filterLoader<span class="token punctuation">;</span> 
  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">FilterRegistry</span> filterRegistry<span class="token punctuation">;</span> 
  <span class="token keyword">public</span> <span class="token class-name">ZuulFilterInitializer</span><span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">ZuulFilter</span><span class="token punctuation">&gt;</span></span> filters<span class="token punctuation">,</span> <span class="token class-name">CounterFactory</span> counterFactory<span class="token punctuation">,</span>
                               <span class="token class-name">TracerFactory</span> tracerFactory<span class="token punctuation">,</span> <span class="token class-name">FilterLoader</span> filterLoader<span class="token punctuation">,</span> <span class="token class-name">FilterRegistry</span> filterRegistry<span class="token punctuation">)</span> <span class="token punctuation">{</span> 
    <span class="token keyword">this</span><span class="token punctuation">.</span>filters <span class="token operator">=</span> filters<span class="token punctuation">;</span> 
    <span class="token keyword">this</span><span class="token punctuation">.</span>counterFactory <span class="token operator">=</span> counterFactory<span class="token punctuation">;</span> 
    <span class="token keyword">this</span><span class="token punctuation">.</span>tracerFactory <span class="token operator">=</span> tracerFactory<span class="token punctuation">;</span> 
    <span class="token keyword">this</span><span class="token punctuation">.</span>filterLoader <span class="token operator">=</span> filterLoader<span class="token punctuation">;</span> 
    <span class="token keyword">this</span><span class="token punctuation">.</span>filterRegistry <span class="token operator">=</span> filterRegistry<span class="token punctuation">;</span> 
  <span class="token punctuation">}</span>
  <span class="token annotation punctuation">@PostConstruct</span> 
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">contextInitialized</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;Starting filter initializer&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token class-name">TracerFactory</span><span class="token punctuation">.</span><span class="token function">initialize</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>tracerFactory<span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token class-name">CounterFactory</span><span class="token punctuation">.</span><span class="token function">initialize</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>counterFactory<span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token class-name">Iterator</span> var1 <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>filters<span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token keyword">while</span><span class="token punctuation">(</span>var1<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
      <span class="token class-name">Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">ZuulFilter</span><span class="token punctuation">&gt;</span></span> entry <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Entry</span><span class="token punctuation">)</span>var1<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token keyword">this</span><span class="token punctuation">.</span>filterRegistry<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span>entry<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">ZuulFilter</span><span class="token punctuation">)</span>entry<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
                          
    <span class="token punctuation">}</span> 
  <span class="token punctuation">}</span>
</code></pre></div><p><strong>（2）请求转发</strong></p> <p>在Zuul的自动配置中我们看到了 ZuulHandlerMapping ，为SpringMVC中 HandlerMapping 的拓展实
现，会自动的添加到HandlerMapping链中。</p> <div class="language-java extra-class"><pre class="language-java"><code> <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ZuulHandlerMapping</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractUrlHandlerMapping</span> <span class="token punctuation">{</span> 
   <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">RouteLocator</span> routeLocator<span class="token punctuation">;</span> 
   <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ZuulController</span> zuul<span class="token punctuation">;</span> 
   <span class="token keyword">private</span> <span class="token class-name">ErrorController</span> errorController<span class="token punctuation">;</span> 
   <span class="token keyword">private</span> <span class="token class-name">PathMatcher</span> pathMatcher <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AntPathMatcher</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token keyword">boolean</span> dirty <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span> 
   <span class="token keyword">public</span> <span class="token class-name">ZuulHandlerMapping</span><span class="token punctuation">(</span><span class="token class-name">RouteLocator</span> routeLocator<span class="token punctuation">,</span> <span class="token class-name">ZuulController</span> zuul<span class="token punctuation">)</span> <span class="token punctuation">{</span> 
     <span class="token keyword">this</span><span class="token punctuation">.</span>routeLocator <span class="token operator">=</span> routeLocator<span class="token punctuation">;</span> 
     <span class="token keyword">this</span><span class="token punctuation">.</span>zuul <span class="token operator">=</span> zuul<span class="token punctuation">;</span> 
     <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setOrder</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token punctuation">}</span>
   <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">registerHandlers</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
     <span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Route</span><span class="token punctuation">&gt;</span></span> routes <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>routeLocator<span class="token punctuation">.</span><span class="token function">getRoutes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
     <span class="token keyword">if</span> <span class="token punctuation">(</span>routes<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
       <span class="token keyword">this</span><span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;No routes found from RouteLocator&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span> 
       <span class="token class-name">Iterator</span> var2 <span class="token operator">=</span> routes<span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
       <span class="token keyword">while</span><span class="token punctuation">(</span>var2<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
         <span class="token class-name">Route</span> route <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Route</span><span class="token punctuation">)</span>var2<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
         <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">registerHandler</span><span class="token punctuation">(</span>route<span class="token punctuation">.</span><span class="token function">getFullPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>zuul<span class="token punctuation">)</span><span class="token punctuation">;</span> 
       <span class="token punctuation">}</span> 
     <span class="token punctuation">}</span> 
   <span class="token punctuation">}</span> 
 <span class="token punctuation">}</span>
</code></pre></div><p>其主要目的就是把所有路径的请求导入到ZuulController上.另外的功效是当觉察RouteLocator路由表变更,则更新自己dirty状态,重新注册所有Route到ZuulController。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ZuulController</span> <span class="token keyword">extends</span> <span class="token class-name">ServletWrappingController</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token class-name">ZuulController</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setServletClass</span><span class="token punctuation">(</span><span class="token class-name">ZuulServlet</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setServletName</span><span class="token punctuation">(</span><span class="token string">&quot;zuul&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setSupportedMethods</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">ModelAndView</span> <span class="token function">handleRequest</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token class-name">ModelAndView</span> var3<span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            var3 <span class="token operator">=</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">handleRequestInternal</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token class-name">RequestContext</span><span class="token punctuation">.</span><span class="token function">getCurrentContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> var3<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><p>在 <code>ZuulController</code> 中的 <code>handleRequest</code> 方法，会调用已经注册的 <code>ZuulServlet</code> 完成业务请求，我们
进入 <code>ZuulServlet</code> 看下内部是如何处理的</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">service</span><span class="token punctuation">(</span><span class="token class-name">ServletRequest</span> servletRequest<span class="token punctuation">,</span> <span class="token class-name">ServletResponse</span> servletResponse<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ServletException</span><span class="token punctuation">,</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span><span class="token punctuation">)</span>servletRequest<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">HttpServletResponse</span><span class="token punctuation">)</span>servletResponse<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">RequestContext</span> context <span class="token operator">=</span> <span class="token class-name">RequestContext</span><span class="token punctuation">.</span><span class="token function">getCurrentContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        context<span class="token punctuation">.</span><span class="token function">setZuulEngineRan</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">preRoute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ZuulException</span> var13<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>var13<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">postRoute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">route</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ZuulException</span> var12<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>var12<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">postRoute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">postRoute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ZuulException</span> var11<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>var11<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> var14<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ZuulException</span><span class="token punctuation">(</span>var14<span class="token punctuation">,</span> <span class="token number">500</span><span class="token punctuation">,</span> <span class="token string">&quot;UNHANDLED_EXCEPTION_&quot;</span> <span class="token operator">+</span> var14<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
        <span class="token class-name">RequestContext</span><span class="token punctuation">.</span><span class="token function">getCurrentContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong>（3）过滤器</strong></p> <p>Zuul默认注入的过滤器可以在 spring-cloud-netflix-core.jar 中找到。</p> <img src="/assets/img/image-20220306114200644.b9e94ea0.png" alt="image-20220306114200644" style="zoom:80%;"> <h3 id="_2-6-zuul网关存在的问题"><a href="#_2-6-zuul网关存在的问题" class="header-anchor">#</a> 2.6 Zuul网关存在的问题</h3> <p>在实际使用中我们会发现直接使用Zuul会存在诸多问题，包括：</p> <ul><li>性能问题
<ul><li>Zuul1x版本本质上就是一个同步Servlet，采用多线程阻塞模型进行请求转发。简单讲，每来一个请求，Servlet容器要为该请求分配一个线程专门负责处理这个请求，直到响应返回客户端这个线程才会被释放返回容器线程池。如果后台服务调用比较耗时，那么这个线程就会被阻塞，阻塞期间线程资源被占用，不能干其它事情。我们知道Servlet容器线程池的大小是有限制的，当前端请求量大，而后台慢服务比较多时，很容易耗尽容器线程池内的线程，造成容器无法接受新的请求。</li></ul></li> <li>不支持任何长连接，如websocket</li></ul> <h3 id="_2-7-zuul网关的替换方案"><a href="#_2-7-zuul网关的替换方案" class="header-anchor">#</a> 2.7 Zuul网关的替换方案</h3> <p><strong>Zuul2.x版本</strong></p> <p><strong>SpringCloud Gateway</strong></p> <h2 id="_3-微服务网关gateway"><a href="#_3-微服务网关gateway" class="header-anchor">#</a> 3 微服务网关GateWay</h2> <p>Zuul 1.x 是一个基于阻塞 IO 的 API Gateway 以及 Servlet；直到 2018 年 5 月，Zuul 2.x（基于
Netty，也是非阻塞的，支持长连接）才发布，但 Spring Cloud 暂时还没有整合计划。Spring Cloud
Gateway 比 Zuul 1.x 系列的性能和功能整体要好。</p> <h3 id="_3-1-gateway简介"><a href="#_3-1-gateway简介" class="header-anchor">#</a> 3.1 Gateway简介</h3> <h4 id="_3-1-1-简介"><a href="#_3-1-1-简介" class="header-anchor">#</a> 3.1.1 简介</h4> <p>Spring Cloud Gateway 是 Spring 官方基于 Spring 5.0，Spring Boot 2.0 和 Project Reactor 等技术开发的网关，旨在为微服务架构提供一种简单而有效的统一的 API 路由管理方式，统一访问接口。SpringCloud Gateway 作为 Spring Cloud 生态系中的网关，目标是替代 Netflix ZUUL，其不仅提供统一的路由方式，并且基于 Filter 链的方式提供了网关基本的功能，例如：安全，监控/埋点，和限流等。它是基于Nttey的响应式开发模式。</p> <table><thead><tr><th>组件</th> <th>RPS(request per second)</th></tr></thead> <tbody><tr><td>Spring Cloud Gateway</td> <td>Requests/sec: 32213.38</td></tr> <tr><td>Zuul1X</td> <td>Requests/sec: 20800.13</td></tr></tbody></table> <p>上表为Spring Cloud Gateway与Zuul的性能对比，从结果可知，Spring Cloud Gateway的RPS是Zuul的1.6倍</p> <h4 id="_3-1-2-核心概念"><a href="#_3-1-2-核心概念" class="header-anchor">#</a> 3.1.2 核心概念</h4> <img src="/assets/img/image-20220306152146069.95f14323.png" alt="image-20220306152146069" style="zoom:50%;"> <ol><li><strong>路由（route）</strong> 路由是网关最基础的部分，路由信息由一个ID、一个目的URL、一组断言工厂和一组Filter组成。如果断言为真，则说明请求URL和配置的路由匹配。</li> <li><strong>断言（predicates）</strong> Java8中的断言函数，Spring Cloud Gateway中的断言函数输入类型是Spring5.0框架中的ServerWebExchange。Spring Cloud Gateway中的断言函数允许开发者去定义匹配来自Http Request中的任何信息，比如请求头和参数等。</li> <li><strong>过滤器（filter）</strong> 一个标准的Spring webFilter，Spring Cloud Gateway中的Filter分为两种类型，分别是Gateway Filter和Global Filter。过滤器Filter可以对请求和响应进行处理。</li></ol> <h3 id="_3-2-入门案例"><a href="#_3-2-入门案例" class="header-anchor">#</a> 3.2 入门案例</h3> <h4 id="_3-2-1-入门案例"><a href="#_3-2-1-入门案例" class="header-anchor">#</a> 3.2.1 入门案例</h4> <p><strong>（1） 创建工程导入依赖</strong></p> <p>在项目中添加新的模块 shop_gateway_server ，并导入依赖</p> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span> 
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span> 
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-gateway<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span> 
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><ul><li>注意SpringCloud Gateway使用的web框架为webflux，和SpringMVC不兼容。引入的限流组件是hystrix。redis底层不再使用jedis，而是lettuce。</li></ul> <p><strong>(2） 配置启动类</strong></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@SpringBootApplication</span> 
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">GatewayServerApplication</span> <span class="token punctuation">{</span> 
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span> 
    <span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">GatewayServerApplication</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token punctuation">}</span> 
<span class="token punctuation">}</span>
</code></pre></div><p><strong>（3） 编写配置文件</strong>
创建 application.yml 配置文件</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">server</span><span class="token punctuation">:</span> <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8080</span> <span class="token comment">#服务端口 </span>
<span class="token key atrule">spring</span><span class="token punctuation">:</span> 
	<span class="token key atrule">application</span><span class="token punctuation">:</span> 
		<span class="token key atrule">name</span><span class="token punctuation">:</span> api<span class="token punctuation">-</span>gateway <span class="token comment">#指定服务名 </span>
	<span class="token key atrule">cloud</span><span class="token punctuation">:</span> 
		<span class="token key atrule">gateway</span><span class="token punctuation">:</span> 
			<span class="token key atrule">routes</span><span class="token punctuation">:</span> 
			<span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> product<span class="token punctuation">-</span>service 
			  <span class="token key atrule">uri</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//127.0.0.1<span class="token punctuation">:</span><span class="token number">9002</span> 
				<span class="token key atrule">predicates</span><span class="token punctuation">:</span> 
				<span class="token punctuation">-</span> Path=/product/<span class="token important">**</span>
</code></pre></div><ul><li>id：我们自定义的路由 ID，保持唯一</li> <li>uri：目标服务地址</li> <li>predicates：路由条件，Predicate 接受一个输入参数，返回一个布尔值结果。该接口包含多种默认方法来将 Predicate 组合成其他复杂的逻辑（比如：与，或，非）。</li> <li>filters：过滤规则，暂时没用。</li></ul> <p>上面这段配置的意思是，配置了一个 id 为 product-service的路由规则，当访问网关请求地址以product 开头时，会自动转发到地址： http://127.0.0.1:9002/ 。配置完成启动项目即可在浏览器访问进行测试，当我们访问地址 http://localhost:8080/product/1 时会展示页面展示如下：</p> <img src="/assets/img/image-20220306152604360.d57fd49c.png" alt="image-20220306152604360" style="zoom:50%;"> <h4 id="_3-2-2-路由规则"><a href="#_3-2-2-路由规则" class="header-anchor">#</a> 3.2.2 路由规则</h4> <p>Spring Cloud Gateway 的功能很强大，前面我们只是使用了 predicates 进行了简单的条件匹配，其实Spring Cloud Gataway 帮我们内置了很多 Predicates 功能。在 Spring Cloud Gateway 中 Spring 利用Predicate 的特性实现了各种路由匹配规则，有通过 Header、请求参数等不同的条件来进行作为条件匹配到对应的路由。</p> <img src="/assets/img/image-20220306152721028.191cf3ab.png" alt="image-20220306152721028" style="zoom:67%;"> <p><strong>示例</strong></p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token comment">#路由断言之后匹配 </span>
<span class="token key atrule">spring</span><span class="token punctuation">:</span> 
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span> 
    <span class="token key atrule">gateway</span><span class="token punctuation">:</span> 
      <span class="token key atrule">routes</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> after_route 
        <span class="token key atrule">uri</span><span class="token punctuation">:</span> https<span class="token punctuation">:</span>//xxxx.com 
        <span class="token comment">#路由断言之前匹配 </span>
        <span class="token key atrule">predicates</span><span class="token punctuation">:</span> 
        <span class="token punctuation">-</span> After=xxxxx 
<span class="token comment">#路由断言之前匹配 </span>
<span class="token key atrule">spring</span><span class="token punctuation">:</span> 
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span> 
    <span class="token key atrule">gateway</span><span class="token punctuation">:</span> 
      <span class="token key atrule">routes</span><span class="token punctuation">:</span> 
        <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> before_route 
          <span class="token key atrule">uri</span><span class="token punctuation">:</span> https<span class="token punctuation">:</span>//xxxxxx.com 
          <span class="token key atrule">predicates</span><span class="token punctuation">:</span> 
          <span class="token punctuation">-</span> Before=xxxxxxx 
<span class="token comment">#路由断言之间 </span>
<span class="token key atrule">spring</span><span class="token punctuation">:</span> 
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span> 
    <span class="token key atrule">gateway</span><span class="token punctuation">:</span> 
      <span class="token key atrule">routes</span><span class="token punctuation">:</span> 
        <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> between_route 
          <span class="token key atrule">uri</span><span class="token punctuation">:</span> https<span class="token punctuation">:</span>//xxxx.com 
          <span class="token key atrule">predicates</span><span class="token punctuation">:</span> 
          <span class="token punctuation">-</span> Between=xxxx<span class="token punctuation">,</span>xxxx 
<span class="token comment">#路由断言Cookie匹配,此predicate匹配给定名称(chocolate)和正则表达式(ch.p) </span>
<span class="token key atrule">spring</span><span class="token punctuation">:</span> 
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span> 
    <span class="token key atrule">gateway</span><span class="token punctuation">:</span> 
      <span class="token key atrule">routes</span><span class="token punctuation">:</span> 
      <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> cookie_route 
        <span class="token key atrule">uri</span><span class="token punctuation">:</span> https<span class="token punctuation">:</span>//xxxx.com 
        <span class="token key atrule">predicates</span><span class="token punctuation">:</span> 
        <span class="token punctuation">-</span> Cookie=chocolate<span class="token punctuation">,</span> ch.p 
<span class="token comment">#路由断言Header匹配，header名称匹配X-Request-Id,且正则表达式匹配\d+</span>
<span class="token key atrule">spring</span><span class="token punctuation">:</span> 
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span> 
    <span class="token key atrule">gateway</span><span class="token punctuation">:</span> 
      <span class="token key atrule">routes</span><span class="token punctuation">:</span> 
      <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> header_route 
        <span class="token key atrule">uri</span><span class="token punctuation">:</span> https<span class="token punctuation">:</span>//xxxx.com 
        <span class="token key atrule">predicates</span><span class="token punctuation">:</span> 
        <span class="token punctuation">-</span> Header=X<span class="token punctuation">-</span>Request<span class="token punctuation">-</span>Id<span class="token punctuation">,</span> \d+ 
<span class="token comment">#路由断言匹配Host匹配，匹配下面Host主机列表,**代表可变参数 </span>
<span class="token key atrule">spring</span><span class="token punctuation">:</span> 
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span> 
    <span class="token key atrule">gateway</span><span class="token punctuation">:</span> 
      <span class="token key atrule">routes</span><span class="token punctuation">:</span> 
      <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> host_route 
        <span class="token key atrule">uri</span><span class="token punctuation">:</span> https<span class="token punctuation">:</span>//xxxx.com 
        <span class="token key atrule">predicates</span><span class="token punctuation">:</span> 
        <span class="token punctuation">-</span> Host=<span class="token important">**.somehost.org</span><span class="token punctuation">,</span><span class="token important">**.anotherhost.org</span> 
<span class="token comment">#路由断言Method匹配，匹配的是请求的HTTP方法 </span>
<span class="token key atrule">spring</span><span class="token punctuation">:</span> 
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span> 
    <span class="token key atrule">gateway</span><span class="token punctuation">:</span> 
      <span class="token key atrule">routes</span><span class="token punctuation">:</span> 
      <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> method_route 
        <span class="token key atrule">uri</span><span class="token punctuation">:</span> https<span class="token punctuation">:</span>//xxxx.com 
        <span class="token key atrule">predicates</span><span class="token punctuation">:</span> 
        <span class="token punctuation">-</span> Method=GET 
<span class="token comment">#路由断言匹配，{segment}为可变参数 </span>
<span class="token key atrule">spring</span><span class="token punctuation">:</span> 
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span> 
    <span class="token key atrule">gateway</span><span class="token punctuation">:</span> 
      <span class="token key atrule">routes</span><span class="token punctuation">:</span> 
      <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> host_route 
        <span class="token key atrule">uri</span><span class="token punctuation">:</span> https<span class="token punctuation">:</span>//xxxx.com 
        <span class="token key atrule">predicates</span><span class="token punctuation">:</span> 
        <span class="token punctuation">-</span> Path=/foo/<span class="token punctuation">{</span>segment<span class="token punctuation">}</span><span class="token punctuation">,</span>/bar/<span class="token punctuation">{</span>segment<span class="token punctuation">}</span> 
<span class="token comment">#路由断言Query匹配，将请求的参数param(baz)进行匹配，也可以进行regexp正则表达式匹配 (参数包含 foo,并且foo的值匹配ba.) </span>
<span class="token key atrule">spring</span><span class="token punctuation">:</span> 
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span> 
    <span class="token key atrule">gateway</span><span class="token punctuation">:</span> 
      <span class="token key atrule">routes</span><span class="token punctuation">:</span> 
      <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> query_route 
        <span class="token key atrule">uri</span><span class="token punctuation">:</span> https<span class="token punctuation">:</span>//xxxx.com 
        <span class="token key atrule">predicates</span><span class="token punctuation">:</span> 
        <span class="token punctuation">-</span> Query=baz 或 Query=foo<span class="token punctuation">,</span>ba. 
<span class="token comment">#路由断言RemoteAddr匹配，将匹配192.168.1.1~192.168.1.254之间的ip地址，其中24为子网掩码位 数即255.255.255.0 </span>
<span class="token key atrule">spring</span><span class="token punctuation">:</span> 
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span> 
    <span class="token key atrule">gateway</span><span class="token punctuation">:</span> 
      <span class="token key atrule">routes</span><span class="token punctuation">:</span> 
      <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> remoteaddr_route 
        <span class="token key atrule">uri</span><span class="token punctuation">:</span> https<span class="token punctuation">:</span>//example.org 
        <span class="token key atrule">predicates</span><span class="token punctuation">:</span> 
        <span class="token punctuation">-</span> RemoteAddr=192.168.1.1/24
</code></pre></div><h4 id="_3-2-3-动态路由"><a href="#_3-2-3-动态路由" class="header-anchor">#</a> 3.2.3 动态路由</h4> <p>和zuul网关类似，在SpringCloud GateWay中也支持动态路由：即自动的从注册中心中获取服务列表并访问。</p> <p><strong>（1）添加注册中心依赖</strong></p> <p>在工程的pom文件中添加注册中心的客户端依赖（这里以Eureka为例）</p> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span> 
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span> 
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-netflix-eureka-client<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span> 
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span> 
</code></pre></div><p><strong>（2）配置动态路由</strong></p> <p>修改 <code>application.yml</code> 配置文件，添加eureka注册中心的相关配置，并修改访问映射的URL为服务名称</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">server</span><span class="token punctuation">:</span> 
	<span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8080</span> <span class="token comment">#服务端口 </span>
<span class="token key atrule">spring</span><span class="token punctuation">:</span> 
  <span class="token key atrule">application</span><span class="token punctuation">:</span> 
    <span class="token key atrule">name</span><span class="token punctuation">:</span> api<span class="token punctuation">-</span>gateway <span class="token comment">#指定服务名 </span>
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span> 
    <span class="token key atrule">gateway</span><span class="token punctuation">:</span> 
      <span class="token key atrule">routes</span><span class="token punctuation">:</span> 
        <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> product<span class="token punctuation">-</span>service 
          <span class="token key atrule">uri</span><span class="token punctuation">:</span> lb<span class="token punctuation">:</span>//shop<span class="token punctuation">-</span>service<span class="token punctuation">-</span>product 
          <span class="token key atrule">predicates</span><span class="token punctuation">:</span> 
          <span class="token punctuation">-</span> Path=/product/<span class="token important">**</span> 
<span class="token key atrule">eureka</span><span class="token punctuation">:</span> 
  <span class="token key atrule">client</span><span class="token punctuation">:</span> 
    <span class="token key atrule">serviceUrl</span><span class="token punctuation">:</span> 
      <span class="token key atrule">defaultZone</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//127.0.0.1<span class="token punctuation">:</span>8761/eureka/ 
      <span class="token key atrule">registry-fetch-interval-seconds</span><span class="token punctuation">:</span> <span class="token number">5</span> <span class="token comment"># 获取服务列表的周期：5s </span>
  <span class="token key atrule">instance</span><span class="token punctuation">:</span> 
    <span class="token key atrule">preferIpAddress</span><span class="token punctuation">:</span> <span class="token boolean important">true</span> 
    <span class="token key atrule">ip-address</span><span class="token punctuation">:</span> 127.0.0.1
</code></pre></div><ul><li>uri ： uri以 <code>lb</code>: //开头（lb代表从注册中心获取服务），后面接的就是你需要转发到的服务名称</li></ul> <h4 id="_3-2-4-重写转发路径"><a href="#_3-2-4-重写转发路径" class="header-anchor">#</a> 3.2.4 重写转发路径</h4> <p>在SpringCloud Gateway中，路由转发是直接将匹配的路由path直接拼接到映射路径（URI）之后，那
么在微服务开发中往往没有那么便利。这里就可以通过RewritePath机制来进行路径重写。</p> <p><strong>（1） 案例改造</strong></p> <p>修改 application.yml ，将匹配路径改为 <code>/product-service/**</code></p> <img src="/assets/img/image-20220306154913436.1cb21314.png" alt="image-20220306154913436" style="zoom:50%;"> <p>重新启动网关，我们在浏览器访问<code>http://127.0.0.1:8080/product-service/product/1</code>，会抛出404。这是由于路由转发规则默认转发到商品微服务（ <code>http://127.0.0.1:9002/product-service/product/1</code> ）路径上，而商品微服务又没有 <code>product-service</code> 对应的映射配置。</p> <p><strong>（2） 添加RewritePath重写转发路径</strong></p> <p>修改 <code>application.yml</code> ，添加重写规则。</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">spring</span><span class="token punctuation">:</span> 
  <span class="token key atrule">application</span><span class="token punctuation">:</span> 
  	<span class="token key atrule">name</span><span class="token punctuation">:</span> api<span class="token punctuation">-</span>gateway 
  <span class="token comment">#指定服务名 </span>
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span> 
    <span class="token key atrule">gateway</span><span class="token punctuation">:</span> 
      <span class="token key atrule">routes</span><span class="token punctuation">:</span> 
        <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> product<span class="token punctuation">-</span>service 
            <span class="token key atrule">uri</span><span class="token punctuation">:</span> lb<span class="token punctuation">:</span>//shop<span class="token punctuation">-</span>service<span class="token punctuation">-</span>product 
            <span class="token key atrule">predicates</span><span class="token punctuation">:</span> 
            <span class="token punctuation">-</span> Path=/product<span class="token punctuation">-</span>service/<span class="token important">**</span> 
            <span class="token key atrule">filters</span><span class="token punctuation">:</span> 
            <span class="token punctuation">-</span> RewritePath=/product<span class="token punctuation">-</span>service/(<span class="token punctuation">?</span>&lt;segment<span class="token punctuation">&gt;</span>.<span class="token important">*)</span><span class="token punctuation">,</span> /$\<span class="token punctuation">{</span>segment<span class="token punctuation">}</span>
</code></pre></div><p>通过RewritePath配置重写转发的url，将/product-service/(?.*)，重写为{segment}，然后转发到订单
微服务。比如在网页上请求http://localhost:8080/product-service/product，此时会将请求转发到http://127.0.0.1:9002/product/1（ <code>值得注意的是在yml文档中 $ 要写成 $\</code> ）</p> <h3 id="_3-3-过滤器"><a href="#_3-3-过滤器" class="header-anchor">#</a> 3.3 过滤器</h3> <p>Spring Cloud Gateway除了具备请求路由功能之外，也支持对请求的过滤。通过Zuul网关类似，也是通过过滤器的形式来实现的。那么接下来我们一起来研究一下Gateway中的过滤器</p> <h4 id="_3-3-1-过滤器基础"><a href="#_3-3-1-过滤器基础" class="header-anchor">#</a> 3.3.1 过滤器基础</h4> <p><strong>（1） 过滤器的生命周期</strong></p> <p>Spring Cloud Gateway 的 Filter 的生命周期不像 Zuul 的那么丰富，它只有两个：“pre” 和 “post”。</p> <ul><li>PRE： 这种过滤器在请求被路由之前调用。我们可利用这种过滤器实现身份验证、在集群中选择请求的微服务、记录调试信息等。</li> <li>POST：这种过滤器在路由到微服务以后执行。这种过滤器可用来为响应添加标准的 HTTPHeader、收集统计信息和指标、将响应从微服务发送给客户端等。</li></ul> <img src="/assets/img/image-20220306155350451.71c40e54.png" alt="image-20220306155350451" style="zoom:50%;"> <p><strong>（2） 过滤器类型</strong></p> <p>Spring Cloud Gateway 的 Filter 从作用范围可分为另外两种GatewayFilter 与 GlobalFilter。</p> <ul><li>GatewayFilter：应用到单个路由或者一个分组的路由上。</li> <li>GlobalFilter：应用到所有的路由上。</li></ul> <h4 id="_3-3-2-局部过滤器"><a href="#_3-3-2-局部过滤器" class="header-anchor">#</a> <strong>3.3.2 局部过滤器</strong></h4> <p>局部过滤器（GatewayFilter），是针对单个路由的过滤器。可以对访问的URL过滤，进行切面处理。在Spring Cloud Gateway中通过GatewayFilter的形式内置了很多不同类型的局部过滤器。这里简单将Spring Cloud Gateway内置的所有过滤器工厂整理成了一张表格，虽然不是很详细，但能作为速览使
用。如下：</p> <table><thead><tr><th>过滤器工厂</th> <th>作用</th> <th>参数</th></tr></thead> <tbody><tr><td>AddRequestHeader</td> <td>为原始请求添加Header</td> <td>Header的名称及值</td></tr> <tr><td>AddRequestParameter</td> <td>为原始请求添加请求参数</td> <td>参数名称及值</td></tr> <tr><td>AddResponseHeader</td> <td>为原始响应添加Header</td> <td>Header的名称及值</td></tr> <tr><td>DedupeResponseHeader</td> <td>剔除响应头中重复的值</td> <td>需要去重的Header名称及去重策略</td></tr> <tr><td>Hystrix</td> <td>为路由引入Hystrix的断路器保护</td> <td>HystrixCommand的名称</td></tr> <tr><td>FallbackHeaders</td> <td>为fallbackUri的请求头中添加具体的异常信息 Header的名称</td> <td>Header的名称</td></tr> <tr><td>PrefifixPath</td> <td>为原始请求路径添加前缀</td> <td>前缀路径</td></tr> <tr><td>PreserveHostHeader</td> <td>为请求添加一个preserveHostHeader=true的属性，路由过滤器会检查该属性以决定是否要发送原始的Host</td> <td>无</td></tr> <tr><td>RequestRateLimiter</td> <td>用于对请求限流，限流算法为令牌桶</td> <td>keyResolver、 rateLimiter、statusCode、 denyEmptyKey、 emptyKeyStatus</td></tr> <tr><td>RedirectTo</td> <td>将原始请求重定向到指定的URL</td> <td>http状态码及重定向的url</td></tr> <tr><td>RemoveHopByHopHeadersFilter</td> <td>为原始请求删除IETF组织规定的一系列Header</td> <td>默认就会启用，可以通过配置指定仅删除哪些Header</td></tr> <tr><td>RemoveRequestHeader</td> <td>为原始请求删除某个Header</td> <td>Header名称</td></tr> <tr><td>RemoveResponseHeader</td> <td>为原始响应删除某个Header</td> <td>Header名称</td></tr> <tr><td>RewritePath</td> <td>重写原始的请求路径</td> <td>原始路径正则表达式以及重写后路径的正则表达式</td></tr> <tr><td>RewriteResponseHeader</td> <td>重写原始响应中的某个Header</td> <td>Header名称，值的正则表达式，重写后的值</td></tr> <tr><td>SaveSession</td> <td>在转发请求之前，强制执行WebSession::save操作</td> <td>无</td></tr> <tr><td>secureHeaders</td> <td>为原始响应添加一系列起安全作用的响应头</td> <td>无，支持修改这些安全响应头的值</td></tr> <tr><td>SetPath</td> <td>修改原始的请求路径</td> <td>修改后的路径</td></tr> <tr><td>SetResponseHeader</td> <td>修改原始响应中某个Header的值</td> <td>Header名称，修改后的值</td></tr> <tr><td>SetStatus</td> <td>修改原始响应的状态码</td> <td>HTTP 状态码，可以是数字，也可以是字符串</td></tr> <tr><td>StripPrefix</td> <td>用于截断原始请求的路径</td> <td>使用数字表示要截断的路径的数量</td></tr> <tr><td>Retry</td> <td>针对不同的响应进行重试</td> <td>retries、statuses、 methods、series</td></tr> <tr><td>RequestSize</td> <td>设置允许接收最大请求包的大小。如果请求包大小超过设置的值，则返回 413 Payload Too  Large</td> <td>请求包大小，单位为字节，默认值为5M</td></tr> <tr><td>ModifyRequestBody</td> <td>在转发请求之前修改原始请求体内容</td> <td>修改后的请求体内容</td></tr> <tr><td>ModifyResponseBody</td> <td>修改原始响应体的内容</td> <td>修改后的响应体内容</td></tr></tbody></table> <p>每个过滤器工厂都对应一个实现类，并且这些类的名称必须以 <code>GatewayFilterFactory</code> 结尾，这是
Spring Cloud Gateway的一个约定，例如 <code>AddRequestHeader</code> 对应的实现类为
<code>AddRequestHeaderGatewayFilterFactory</code> 。对于这些过滤器的使用方式可以参考官方文档</p> <h4 id="_3-3-3-全局过滤器"><a href="#_3-3-3-全局过滤器" class="header-anchor">#</a> 3.3.3 全局过滤器</h4> <p>全局过滤器（GlobalFilter）作用于所有路由，Spring Cloud Gateway 定义了Global Filter接口，用户
可以自定义实现自己的Global Filter。通过全局过滤器可以实现对权限的统一校验，安全性验证等功
能，并且全局过滤器也是程序员使用比较多的过滤器。</p> <p>Spring Cloud Gateway内部也是通过一系列的内置全局过滤器对整个路由转发进行处理如下：</p> <img src="/assets/img/image-20220306163612706.3dfdc2eb.png" alt="image-20220306163612706" style="zoom:50%;"> <h3 id="_3-4-统一鉴权"><a href="#_3-4-统一鉴权" class="header-anchor">#</a> 3.4 统一鉴权</h3> <p>内置的过滤器已经可以完成大部分的功能，但是对于企业开发的一些业务功能处理，还是需要我们自己
编写过滤器来实现的，那么我们一起通过代码的形式自定义一个过滤器，去完成统一的权限校验。</p> <h4 id="_3-4-1-鉴权逻辑"><a href="#_3-4-1-鉴权逻辑" class="header-anchor">#</a> 3.4.1 鉴权逻辑</h4> <p>开发中的鉴权逻辑：</p> <ul><li>当客户端第一次请求服务时，服务端对用户进行信息认证（登录）</li> <li>认证通过，将用户信息进行加密形成token，返回给客户端，作为登录凭证</li> <li>以后每次请求，客户端都携带认证的token服务端对token进行解密，判断是否有效。</li></ul> <img src="/assets/img/image-20220306163753687.523cf306.png" alt="image-20220306163753687" style="zoom:50%;"> <p>如上图，对于验证用户是否已经登录鉴权的过程可以在网关层统一检验。检验的标准就是请求中是否携带token凭证以及token的正确性。</p> <h4 id="_3-4-2-代码实现"><a href="#_3-4-2-代码实现" class="header-anchor">#</a> 3.4.2 代码实现</h4> <p>下面的我们自定义一个GlobalFilter，去校验所有请求的请求参数中是否包含“token”，如何不包含请求
参数“token”则不转发路由，否则执行正常的逻辑。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Component</span> <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AuthorizeFilter</span> <span class="token keyword">implements</span> <span class="token class-name">GlobalFilter</span><span class="token punctuation">,</span> <span class="token class-name">Ordered</span> <span class="token punctuation">{</span> 
  <span class="token annotation punctuation">@Override</span> <span class="token keyword">public</span> <span class="token class-name">Mono</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">&gt;</span></span> <span class="token function">filter</span><span class="token punctuation">(</span><span class="token class-name">ServerWebExchange</span> exchange<span class="token punctuation">,</span> <span class="token class-name">GatewayFilterChain</span> chain<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//String url = exchange.getRequest().getURI().getPath(); </span>
    <span class="token comment">//忽略以下url请求 </span>
    <span class="token comment">//if(url.indexOf(&quot;/login&quot;) &gt;= 0){ </span>
    <span class="token comment">// return chain.filter(exchange); </span>
    <span class="token comment">// } </span>
    <span class="token class-name">String</span> token <span class="token operator">=</span> exchange<span class="token punctuation">.</span><span class="token function">getRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getQueryParams</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getFirst</span><span class="token punctuation">(</span><span class="token string">&quot;token&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isBlank</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
      log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span> <span class="token string">&quot;token is empty ...&quot;</span> <span class="token punctuation">)</span><span class="token punctuation">;</span> 
      exchange<span class="token punctuation">.</span><span class="token function">getResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setStatusCode</span><span class="token punctuation">(</span> <span class="token class-name">HttpStatus</span><span class="token punctuation">.</span>UNAUTHORIZED <span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token keyword">return</span> exchange<span class="token punctuation">.</span><span class="token function">getResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setComplete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> chain<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>exchange<span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span>
  <span class="token annotation punctuation">@Override</span> <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>自定义全局过滤器需要实现GlobalFilter和Ordered接口。</li> <li>在filter方法中完成过滤器的逻辑判断处理</li> <li>在getOrder方法指定此过滤器的优先级，返回值越大级别越低</li> <li><code>ServerWebExchange</code> 就相当于当前请求和响应的上下文，存放着重要的请求-响应属性、请求实例和响应实例等等。一个请求中的request，response都可以通过 ServerWebExchange 获取</li> <li>调用chain.filter 继续向下游执行</li></ul> <h3 id="_3-5-网关限流"><a href="#_3-5-网关限流" class="header-anchor">#</a> 3.5 网关限流</h3> <h4 id="_3-5-1-常见的限流算法"><a href="#_3-5-1-常见的限流算法" class="header-anchor">#</a> 3.5.1 常见的限流算法</h4> <p><strong>（1） 计数器</strong></p> <p>计数器限流算法是最简单的一种限流实现方式。其本质是通过维护一个单位时间内的计数器，每次请求计数器加1，当单位时间内计数器累加到大于设定的阈值，则之后的请求都被拒绝，直到单位时间已经过去，再将计数器重置为零</p> <img src="/assets/img/image-20220306164457877.f347d11a.png" alt="image-20220306164457877" style="zoom:50%;"> <p><strong>（2） 漏桶算法</strong></p> <p>漏桶算法可以很好地限制容量池的大小，从而防止流量暴增。漏桶可以看作是一个带有常量服务时间的单服务器队列，如果漏桶（包缓存）溢出，那么数据包会被丢弃。 在网络中，漏桶算法可以控制端口的流量输出速率，平滑网络上的突发流量，实现流量整形，从而为网络提供一个稳定的流量。</p> <img src="/assets/img/image-20220306164521721.ecebf41f.png" alt="image-20220306164521721" style="zoom:50%;"> <p>为了更好的控制流量，漏桶算法需要通过两个变量进行控制：一个是桶的大小，支持流量突发增多时可以存多少的水（burst），另一个是水桶漏洞的大小（rate）。</p> <p><strong>（3） 令牌桶算法</strong></p> <p>令牌桶算法是对漏桶算法的一种改进，桶算法能够限制请求调用的速率，而令牌桶算法能够在限制调用的平均速率的同时还允许一定程度的突发调用。在令牌桶算法中，存在一个桶，用来存放固定数量的令牌。算法中存在一种机制，以一定的速率往桶中放令牌。每次请求调用需要先获取令牌，只有拿到令牌，才有机会继续执行，否则选择选择等待可用的令牌、或者直接拒绝。放令牌这个动作是持续不断的进行，如果桶中令牌数达到上限，就丢弃令牌，所以就存在这种情况，桶中一直有大量的可用令牌，这时进来的请求就可以直接拿到令牌执行，比如设置qps为100，那么限流器初始化完成一秒后，桶中就已经有100个令牌了，这时服务还没完全启动好，等启动完成对外提供服务时，该限流器可以抵挡瞬时的100个请求。所以，只有桶中没有令牌时，请求才会进行等待，最后相当于以一定的速率执行。</p> <img src="/assets/img/image-20220306164620751.61d292e9.png" alt="image-20220306164620751" style="zoom:50%;"> <h4 id="_3-5-2-基于filter的限流"><a href="#_3-5-2-基于filter的限流" class="header-anchor">#</a> 3.5.2 基于Filter的限流</h4> <p>SpringCloudGateway官方就提供了基于令牌桶的限流支持。基于其内置的过滤器工厂RequestRateLimiterGatewayFilterFactory 实现。在过滤器工厂中是通过Redis和lua脚本结合的方式进行流量控制。</p> <p><strong>（1） 环境搭建</strong></p> <p><strong>导入redis的依赖</strong></p> <p>首先在工程的pom文件中引入gateway的起步依赖和redis的reactive依赖，代码如下：</p> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span> 
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span> 
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-gateway<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span> 
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span> 
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span> 
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span> 
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifatId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-data-redis-reactive<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span> 
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span> 
</code></pre></div><ul><li>准备redis</li></ul> <p><strong>（2） 修改application.yml配置文件</strong></p> <p>在application.yml配置文件中加入限流的配置，代码如下：</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">spring</span><span class="token punctuation">:</span> 
  <span class="token key atrule">application</span><span class="token punctuation">:</span> 
  	<span class="token key atrule">name</span><span class="token punctuation">:</span> api<span class="token punctuation">-</span>gateway <span class="token comment">#指定服务名 </span>
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span> 
    <span class="token key atrule">gateway</span><span class="token punctuation">:</span> 
      <span class="token key atrule">routes</span><span class="token punctuation">:</span> 
      <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> order<span class="token punctuation">-</span>service
      <span class="token key atrule">uri</span><span class="token punctuation">:</span> lb<span class="token punctuation">:</span>//shop<span class="token punctuation">-</span>service<span class="token punctuation">-</span>order 
      <span class="token key atrule">filters</span><span class="token punctuation">:</span> 
      <span class="token punctuation">-</span> RewritePath=/order<span class="token punctuation">-</span>service/(<span class="token punctuation">?</span>&lt;segment<span class="token punctuation">&gt;</span>.<span class="token important">*)</span><span class="token punctuation">,</span> /$\<span class="token punctuation">{</span>segment<span class="token punctuation">}</span> 
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> RequestRateLimiter 
        <span class="token key atrule">args</span><span class="token punctuation">:</span> <span class="token comment"># 使用SpEL从容器中获取对象 </span>
        <span class="token key atrule">key-resolver</span><span class="token punctuation">:</span> <span class="token string">'#{@pathKeyResolver}'</span> 
        <span class="token comment"># 令牌桶每秒填充平均速率 </span>
        <span class="token key atrule">redis-rate-limiter.replenishRate</span><span class="token punctuation">:</span> <span class="token number">1</span> 
        <span class="token comment"># 令牌桶的总容量 </span>
        <span class="token key atrule">redis-rate-limiter.burstCapacity</span><span class="token punctuation">:</span> <span class="token number">3</span>
   <span class="token key atrule">redis</span><span class="token punctuation">:</span> 
     <span class="token key atrule">host</span><span class="token punctuation">:</span> localhost 
     <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">6379</span>
</code></pre></div><p>在 <code>application.yml</code> 中添加了redis的信息，并配置了RequestRateLimiter的限流过滤器：</p> <ul><li>burstCapacity，令牌桶总容量。</li> <li>replenishRate，令牌桶每秒填充平均速率。</li> <li>key-resolver，用于限流的键的解析器的 Bean 对象的名字。它使用 SpEL 表达式根据#{@beanName}从 Spring 容器中获取 Bean 对象。</li></ul> <p><strong>（3） 配置KeyResolver</strong></p> <p>为了达到不同的限流效果和规则，可以通过实现 KeyResolver 接口，定义不同请求类型的限流键。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">KeyResolverConfiguration</span> <span class="token punctuation">{</span>

   <span class="token comment">/**
    * 基于请求路径的限流规则
    */</span>
   <span class="token annotation punctuation">@Bean</span>
   <span class="token keyword">public</span> <span class="token class-name">KeyResolver</span> <span class="token function">pathKeyResolver</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> exchange <span class="token operator">-&gt;</span> <span class="token class-name">Mono</span><span class="token punctuation">.</span><span class="token function">just</span><span class="token punctuation">(</span> 
        exchange<span class="token punctuation">.</span><span class="token function">getRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   <span class="token comment">/**
   * 基于请求ip地址的限流 
   */</span> 
  <span class="token annotation punctuation">@Bean</span> 
  <span class="token keyword">public</span> <span class="token class-name">KeyResolver</span> <span class="token function">ipKeyResolver</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
    <span class="token keyword">return</span> exchange <span class="token operator">-&gt;</span> <span class="token class-name">Mono</span><span class="token punctuation">.</span><span class="token function">just</span><span class="token punctuation">(</span> 
      exchange<span class="token punctuation">.</span><span class="token function">getRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getHeaders</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getFirst</span><span class="token punctuation">(</span><span class="token string">&quot;X-Forwarded-For&quot;</span><span class="token punctuation">)</span> 
    <span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span>
  <span class="token comment">/**
  * 基于用户的限流 
  */</span> 
  <span class="token annotation punctuation">@Bean</span> 
  <span class="token keyword">public</span> <span class="token class-name">KeyResolver</span> <span class="token function">userKeyResolver</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
    <span class="token keyword">return</span> exchange <span class="token operator">-&gt;</span> <span class="token class-name">Mono</span><span class="token punctuation">.</span><span class="token function">just</span><span class="token punctuation">(</span> 
      exchange<span class="token punctuation">.</span><span class="token function">getRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getQueryParams</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getFirst</span><span class="token punctuation">(</span><span class="token string">&quot;user&quot;</span><span class="token punctuation">)</span> 
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>使用Jmetter模拟5组线程访问，会发现如下结果，当达到令牌桶的总容量3时，其他的请求会返回429错误。</p> <img src="/assets/img/image-20220306170221612.49190b86.png" alt="image-20220306170221612" style="zoom:50%;"> <p>通过reids的MONITOR可以监听redis的执行过程。这时候Redis中会有对应的数据：</p> <img src="/assets/img/image-20220306170236232.45058808.png" alt="image-20220306170236232" style="zoom:50%;"> <p>大括号中就是我们的限流Key,这边是IP，本地的就是localhost</p> <ul><li>timestamp:存储的是当前时间的秒数，也就是System.currentTimeMillis() / 1000或者Instant.now().getEpochSecond()</li> <li>tokens:存储的是当前这秒钟的对应的可用的令牌数量</li></ul> <p>Spring Cloud Gateway目前提供的限流还是相对比较简单的，在实际中我们的限流策略会有很多种情
况，比如：</p> <ul><li>对不同接口的限流</li> <li>被限流后的友好提示</li></ul> <p>这些可以通过自定义RedisRateLimiter来实现自己的限流策略，这里我们不做讨论</p> <h4 id="_3-5-3-基于sentinel的限流"><a href="#_3-5-3-基于sentinel的限流" class="header-anchor">#</a> 3.5.3 基于Sentinel的限流</h4> <p>Sentinel 支持对 Spring Cloud Gateway、Zuul 等主流的 API Gateway 进行限流。</p> <img src="/assets/img/image-20220306170337081.ff72d5fa.png" alt="image-20220306170337081" style="zoom:50%;"> <p>从 1.6.0 版本开始，Sentinel 提供了 Spring Cloud Gateway 的适配模块，可以提供两种资源维度的限
流：</p> <ul><li>route 维度：即在 Spring 配置文件中配置的路由条目，资源名为对应的 routeId</li> <li>自定义 API 维度：用户可以利用 Sentinel 提供的 API 来自定义一些 API 分组</li></ul> <p>Sentinel 1.6.0 引入了 Sentinel API Gateway Adapter Common 模块，此模块中包含网关限流的规则
和自定义 API 的实体和管理逻辑：</p> <ul><li><code>GatewayFlowRule</code> ：网关限流规则，针对 API Gateway 的场景定制的限流规则，可以针对不同route 或自定义的 API 分组进行限流，支持针对请求中的参数、Header、来源 IP 等进行定制化的限流。</li> <li><code>ApiDefinition</code> ：用户自定义的 API 定义分组，可以看做是一些 URL 匹配的组合。比如我们可以定义一个 API 叫 <code>my_api</code> ，请求 path 模式为 <code>/foo/**</code> 和 <code>/baz/**</code> 的都归到 my_api 这个 API分组下面。限流的时候可以针对这个自定义的 API 分组维度进行限流。</li></ul> <p><strong>（1）环境搭建</strong></p> <p>导入Sentinel 的响应依赖</p> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span> 
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.alibaba.csp<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span> 
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>sentinel-spring-cloud-gateway-adapter<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span> 
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>x.y.z<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span> 
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span> 
</code></pre></div><p><strong>（2） 编写配置类</strong></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">GatewayConfiguration</span> <span class="token punctuation">{</span>

   <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ViewResolver</span><span class="token punctuation">&gt;</span></span> viewResolvers<span class="token punctuation">;</span>
   <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ServerCodecConfigurer</span> serverCodecConfigurer<span class="token punctuation">;</span>
   <span class="token keyword">public</span> <span class="token class-name">GatewayConfiguration</span><span class="token punctuation">(</span><span class="token class-name">ObjectProvider</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">ViewResolver</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> viewResolversProvider<span class="token punctuation">,</span>
                               <span class="token class-name">ServerCodecConfigurer</span> serverCodecConfigurer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>viewResolvers <span class="token operator">=</span> viewResolversProvider<span class="token punctuation">.</span><span class="token function">getIfAvailable</span><span class="token punctuation">(</span><span class="token class-name">Collections</span><span class="token operator">::</span><span class="token function">emptyList</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>serverCodecConfigurer <span class="token operator">=</span> serverCodecConfigurer<span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   <span class="token comment">/**
    * 配置限流的异常处理器:SentinelGatewayBlockExceptionHandler
    */</span>
   <span class="token annotation punctuation">@Bean</span>
   <span class="token annotation punctuation">@Order</span><span class="token punctuation">(</span><span class="token class-name">Ordered</span><span class="token punctuation">.</span>HIGHEST_PRECEDENCE<span class="token punctuation">)</span>
   <span class="token keyword">public</span> <span class="token class-name">SentinelGatewayBlockExceptionHandler</span> <span class="token function">sentinelGatewayBlockExceptionHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">SentinelGatewayBlockExceptionHandler</span><span class="token punctuation">(</span>viewResolvers<span class="token punctuation">,</span> serverCodecConfigurer<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   <span class="token comment">/**
    * 配置限流过滤器
    */</span>
   <span class="token annotation punctuation">@Bean</span>
   <span class="token annotation punctuation">@Order</span><span class="token punctuation">(</span><span class="token class-name">Ordered</span><span class="token punctuation">.</span>HIGHEST_PRECEDENCE<span class="token punctuation">)</span>
   <span class="token keyword">public</span> <span class="token class-name">GlobalFilter</span> <span class="token function">sentinelGatewayFilter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">SentinelGatewayFilter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   <span class="token comment">/**
    * 配置初始化的限流参数
    *  用于指定资源的限流规则.
    *      1.资源名称 (路由id)
    *      2.配置统计时间
    *      3.配置限流阈值
    */</span>
   <span class="token annotation punctuation">@PostConstruct</span>
   <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">initGatewayRules</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">GatewayFlowRule</span><span class="token punctuation">&gt;</span></span> rules <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      rules<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">GatewayFlowRule</span><span class="token punctuation">(</span><span class="token string">&quot;order-service&quot;</span><span class="token punctuation">)</span><span class="token comment">//资源名称</span>
         <span class="token punctuation">.</span><span class="token function">setCount</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token comment">// 限流阈值</span>
         <span class="token punctuation">.</span><span class="token function">setIntervalSec</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token comment">// 统计时间窗口，单位是秒，默认是 1 秒</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token class-name">GatewayRuleManager</span><span class="token punctuation">.</span><span class="token function">loadRules</span><span class="token punctuation">(</span>rules<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>基于Sentinel 的Gateway限流是通过其提供的Filter来完成的，使用时只需注入对应的<code>SentinelGatewayFilter</code> 实例以及 <code>SentinelGatewayBlockExceptionHandler</code> 实例即可。</li> <li>@PostConstruct定义初始化的加载方法，用于指定资源的限流规则。这里资源的名称为 <code>order-service</code> ，统计时间是1秒内，限流阈值是1。表示每秒只能访问一个请求。</li></ul> <p><strong>（3）网关配置</strong></p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">spring</span><span class="token punctuation">:</span> 
  <span class="token key atrule">application</span><span class="token punctuation">:</span> 
  	<span class="token key atrule">name</span><span class="token punctuation">:</span> api<span class="token punctuation">-</span>gateway <span class="token comment">#指定服务名 </span>
  <span class="token key atrule">redis</span><span class="token punctuation">:</span> 
    <span class="token key atrule">host</span><span class="token punctuation">:</span> 127.0.0.1 
    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">6379</span> 
    <span class="token key atrule">database</span><span class="token punctuation">:</span> <span class="token number">0</span>
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span> 
    <span class="token key atrule">gateway</span><span class="token punctuation">:</span> 
      <span class="token key atrule">routes</span><span class="token punctuation">:</span> 
      <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> order<span class="token punctuation">-</span>service 
        <span class="token key atrule">uri</span><span class="token punctuation">:</span> lb<span class="token punctuation">:</span>//shop<span class="token punctuation">-</span>service<span class="token punctuation">-</span>order 
        <span class="token key atrule">predicates</span><span class="token punctuation">:</span> 
        <span class="token punctuation">-</span> Path=/order<span class="token punctuation">-</span>service/<span class="token important">**</span> 
        <span class="token key atrule">filters</span><span class="token punctuation">:</span> 
        <span class="token punctuation">-</span> RewritePath=/order<span class="token punctuation">-</span>service/(<span class="token punctuation">?</span>&lt;segment<span class="token punctuation">&gt;</span>.<span class="token important">*)</span><span class="token punctuation">,</span> /$\<span class="token punctuation">{</span>segment<span class="token punctuation">}</span> 
</code></pre></div><p>在一秒钟内多次访问http://localhost:8080/order-service/order/buy/1就可以看到限流启作用了。</p> <img src="/assets/img/image-20220306214602286.c1f08a7c.png" alt="image-20220306214602286" style="zoom:50%;"> <p><strong>（4）自定义异常提示</strong></p> <p>当触发限流后页面显示的是Blocked by Sentinel: FlowException。为了展示更加友好的限流提示，Sentinel支持自定义异常处理。</p> <p>您可以在 <code>GatewayCallbackManager</code> 注册回调进行定制：</p> <ul><li><code>setBlockHandler</code> ：注册函数用于实现自定义的逻辑处理被限流的请求，对应接口为<code>BlockRequestHandler</code> 。默认实现为 <code>DefaultBlockRequestHandler</code> ，当被限流时会返回类似于下面的错误信息： <code>Blocked by Sentinel: FlowException</code> 。</li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@PostConstruct</span> 
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">initBlockHandlers</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
	<span class="token class-name">BlockRequestHandler</span> blockRequestHandler <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BlockRequestHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
    <span class="token keyword">public</span> <span class="token class-name">Mono</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ServerResponse</span><span class="token punctuation">&gt;</span></span> <span class="token function">handleRequest</span><span class="token punctuation">(</span><span class="token class-name">ServerWebExchange</span> 
      serverWebExchange<span class="token punctuation">,</span> <span class="token class-name">Throwable</span> throwable<span class="token punctuation">)</span> <span class="token punctuation">{</span> 
        <span class="token class-name">Map</span> map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
        map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;code&quot;</span><span class="token punctuation">,</span> <span class="token number">001</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
        map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;message&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;对不起,接口限流了&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
        <span class="token keyword">return</span> <span class="token class-name">ServerResponse</span><span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token class-name">HttpStatus</span><span class="token punctuation">.</span>OK<span class="token punctuation">)</span><span class="token punctuation">.</span> 
        <span class="token function">contentType</span><span class="token punctuation">(</span><span class="token class-name">MediaType</span><span class="token punctuation">.</span>APPLICATION_JSON_UTF8<span class="token punctuation">)</span><span class="token punctuation">.</span> 
        <span class="token function">body</span><span class="token punctuation">(</span><span class="token class-name">BodyInserters</span><span class="token punctuation">.</span><span class="token function">fromObject</span><span class="token punctuation">(</span>map<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token punctuation">}</span> 
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token class-name">GatewayCallbackManager</span><span class="token punctuation">.</span><span class="token function">setBlockHandler</span><span class="token punctuation">(</span>blockRequestHandler<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token punctuation">}</span>
</code></pre></div><img src="/assets/img/image-20220306214833983.7ea82a08.png" alt="image-20220306214833983" style="zoom:50%;"> <p><strong>（5） 参数限流</strong></p> <p>上面的配置是针对整个路由来限流的，如果我们只想对某个路由的参数做限流，那么可以使用参数限流
方式：</p> <div class="language-java extra-class"><pre class="language-java"><code>rules<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">GatewayFlowRule</span><span class="token punctuation">(</span><span class="token string">&quot;order-service&quot;</span><span class="token punctuation">)</span> 
    <span class="token punctuation">.</span><span class="token function">setCount</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> 
    <span class="token punctuation">.</span><span class="token function">setIntervalSec</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> 
    <span class="token punctuation">.</span><span class="token function">setParamItem</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">GatewayParamFlowItem</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
    <span class="token punctuation">.</span><span class="token function">setParseStrategy</span><span class="token punctuation">(</span><span class="token class-name">SentinelGatewayConstants</span><span class="token punctuation">.</span>PARAM_PARSE_STRATEGY_URL_PARAM<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setFieldName</span><span class="token punctuation">(</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">)</span> 
    <span class="token punctuation">)</span> 
<span class="token punctuation">)</span><span class="token punctuation">;</span> 
</code></pre></div><p>通过指定PARAM_PARSE_STRATEGY_URL_PARAM表示从url中获取参数，setFieldName指定参数名称</p> <p><strong>（6） 自定义API分组</strong></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@PostConstruct</span> 
<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">initCustomizedApis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
  <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ApiDefinition</span><span class="token punctuation">&gt;</span></span> definitions <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token class-name">ApiDefinition</span> api1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ApiDefinition</span><span class="token punctuation">(</span><span class="token string">&quot;product_api&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">setPredicateItems</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">HashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ApiPredicateItem</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">{</span> 
      <span class="token comment">//以/product-service/product 开头的请求 </span>
      <span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ApiPathPredicateItem</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setPattern</span><span class="token punctuation">(</span><span class="token string">&quot;/product- service/product/**&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setMatchStrategy</span><span class="token punctuation">(</span><span class="token class-name">SentinelGatewayConstants</span><span class="token punctuation">.</span>URL_MATCH_STRATEGY_PREFIX<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token class-name">ApiDefinition</span> api2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ApiDefinition</span><span class="token punctuation">(</span><span class="token string">&quot;order_api&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setPredicateItems</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">HashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ApiPredicateItem</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">{</span>
    <span class="token comment">///order-service/order 完成的url路径匹配 </span>
    <span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ApiPathPredicateItem</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setPattern</span><span class="token punctuation">(</span><span class="token string">&quot;/order-service/order&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
  definitions<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>api1<span class="token punctuation">)</span><span class="token punctuation">;</span> 
  definitions<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>api2<span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token class-name">GatewayApiDefinitionManager</span><span class="token punctuation">.</span><span class="token function">loadApiDefinitions</span><span class="token punctuation">(</span>definitions<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token punctuation">}</span>
</code></pre></div><h3 id="_3-6-网关高可用"><a href="#_3-6-网关高可用" class="header-anchor">#</a> 3.6 网关高可用</h3> <p><strong>高可用HA</strong>（High Availability）是分布式系统架构设计中必须考虑的因素之一，它通常是指，通过设计减少系统不能提供服务的时间。我们都知道，单点是系统高可用的大敌，单点往往是系统高可用最大的风险和敌人，应该尽量在系统设计的过程中避免单点。方法论上，高可用保证的原则是“集群化”，或者叫“冗余”：只有一个单点，挂了服务会受影响；如果有冗余备份，挂了还有其他backup能够顶上。</p> <img src="/assets/img/image-20220306215241566.89d073ae.png" alt="image-20220306215241566" style="zoom:50%;"> <p>我们实际使用 Spring Cloud Gateway 的方式如上图，不同的客户端使用不同的负载将请求分发到后端的 Gateway，Gateway 再通过HTTP调用后端服务，最后对外输出。因此为了保证 Gateway 的高可用性，前端可以同时启动多个 Gateway 实例进行负载，在 Gateway 的前端使用 Nginx 或者 F5 进行负载转发以达到高可用性。</p> <p><strong>（1） 准备多个GateWay工程</strong></p> <p>修改 <code>shop_gateway_server</code> 的application.yml。添加如下配置</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">spring</span><span class="token punctuation">:</span> 
  <span class="token key atrule">application</span><span class="token punctuation">:</span> 
  	<span class="token key atrule">name</span><span class="token punctuation">:</span> api<span class="token punctuation">-</span>gateway <span class="token comment">#指定服务名 </span>
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span> 
    <span class="token key atrule">gateway</span><span class="token punctuation">:</span> 
      <span class="token key atrule">routes</span><span class="token punctuation">:</span> 
        <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> product<span class="token punctuation">-</span>service 
          <span class="token key atrule">uri</span><span class="token punctuation">:</span> lb<span class="token punctuation">:</span>//shop<span class="token punctuation">-</span>service<span class="token punctuation">-</span>product 
          <span class="token key atrule">predicates</span><span class="token punctuation">:</span> 
          <span class="token punctuation">-</span> Path=/product<span class="token punctuation">-</span>service/<span class="token important">**</span> 
          <span class="token key atrule">filters</span><span class="token punctuation">:</span> <span class="token punctuation">-</span> RewritePath=/product<span class="token punctuation">-</span>service/(<span class="token punctuation">?</span>&lt;segment<span class="token punctuation">&gt;</span>.<span class="token important">*)</span><span class="token punctuation">,</span> /$\<span class="token punctuation">{</span>segment<span class="token punctuation">}</span> 
  <span class="token key atrule">eureka</span><span class="token punctuation">:</span> 
    <span class="token key atrule">client</span><span class="token punctuation">:</span> 
      <span class="token key atrule">serviceUrl</span><span class="token punctuation">:</span> 
        <span class="token key atrule">defaultZone</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//eureka1<span class="token punctuation">:</span>8761/eureka/ 
          <span class="token key atrule">registry-fetch-interval-seconds</span><span class="token punctuation">:</span> <span class="token number">5</span> <span class="token comment"># 获取服务列表的周期：5s </span>
    <span class="token key atrule">instance</span><span class="token punctuation">:</span> 
			<span class="token key atrule">preferIpAddress</span><span class="token punctuation">:</span> <span class="token boolean important">true</span> 
      <span class="token key atrule">ip-address</span><span class="token punctuation">:</span> 127.0.0.1 
<span class="token punctuation">---</span> 
<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">profiles</span><span class="token punctuation">:</span> gateway01 
 <span class="token key atrule">server</span><span class="token punctuation">:</span> 
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8080</span> <span class="token comment">#服务端口 </span>
<span class="token punctuation">---</span> 
<span class="token key atrule">spring</span><span class="token punctuation">:</span> 
	<span class="token key atrule">profiles</span><span class="token punctuation">:</span> gateway02 
<span class="token key atrule">server</span><span class="token punctuation">:</span> 
	<span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8081</span> <span class="token comment">#服务端口</span>
</code></pre></div><p>通过不同的profiles配置启动两个网关服务，请求端口分别为8080和8081。浏览器验证发现效果是一致
的。</p> <p><strong>（2） 配置ngnix</strong></p> <p>找到ngnix添加负载均衡配置</p> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token comment">#配置多台服务器（这里只在一台服务器上的不同端口） </span>
<span class="token keyword">upstream</span> gateway <span class="token punctuation">{</span> 
    <span class="token keyword">server</span> <span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span><span class="token punctuation">:</span><span class="token number">8081</span><span class="token punctuation">;</span> 
    <span class="token keyword">server</span> <span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span><span class="token punctuation">:</span><span class="token number">8080</span><span class="token punctuation">;</span> 
<span class="token punctuation">}</span>
<span class="token comment">#请求转向mysvr 定义的服务器列表 </span>
<span class="token keyword">location</span> <span class="token operator">/</span> <span class="token punctuation">{</span> 
  <span class="token keyword">proxy_pass</span> <span class="token keyword">http</span><span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>gateway<span class="token punctuation">;</span> 
<span class="token punctuation">}</span>
</code></pre></div><p>在浏览器上通过访问<code>http://localhost/order-service/order/buy/1</code>请求的效果和之前是一样的。这次关
闭一台网关服务器，还是可以支持部分请求的访问。</p> <h3 id="_3-7-执行流程分析"><a href="#_3-7-执行流程分析" class="header-anchor">#</a> 3.7 执行流程分析</h3> <img src="/assets/img/image-20220306215740249.264e8ab2.png" alt="image-20220306215740249" style="zoom:50%;"> <p>Spring Cloud Gateway 核心处理流程如上图所示，Gateway的客户端向 Spring Cloud Gateway 发送请求，请求首先被 HttpWebHandlerAdapter 进行提取组装成网关上下文，然后网关的上下文会传递到 DispatcherHandler 。 DispatcherHandler 是所有请求的分发处理器， DispatcherHandler 主要负责分发请求对应的处理器。比如请求分发到对应的 RoutePredicateHandlerMapping （路由断言处理映射器）。路由断言处理映射器主要作用用于路由查找，以及找到路由后返回对应的FilterWebHandler 。 FilterWebHandler 主要负责组装Filter链并调用Filter执行一系列的Filter处理，然后再把请求转到后端对应的代理服务处理，处理完毕之后将Response返回到Gateway客户端。</p> <h2 id="_4-微服务的链路追踪概述"><a href="#_4-微服务的链路追踪概述" class="header-anchor">#</a> 4 微服务的链路追踪概述</h2> <h3 id="_4-1-微服务架构下的问题"><a href="#_4-1-微服务架构下的问题" class="header-anchor">#</a> 4.1 微服务架构下的问题</h3> <p>在大型系统的微服务化构建中，一个系统会被拆分成许多模块。这些模块负责不同的功能，组合成系统，最终可以提供丰富的功能。在这种架构中，一次请求往往需要涉及到多个服务。互联网应用构建在不同的软件模块集上，这些软件模块，有可能是由不同的团队开发、可能使用不同的编程语言来实现、有可能布在了几千台服务器，横跨多个不同的数据中心，也就意味着这种架构形式也会存在一些问题：</p> <ul><li>如何快速发现问题？</li> <li>如何判断故障影响范围？</li> <li>如何梳理服务依赖以及依赖的合理性？</li> <li>如何分析链路性能问题以及实时容量规划？</li></ul> <p>分布式链路追踪（Distributed Tracing），就是将一次分布式请求还原成调用链路，进行日志记录，性
能监控并将 一次分布式请求的调用情况集中展示。比如各个服务节点上的耗时、请求具体到达哪台机器
上、每个服务节点的请求状态等等。</p> <p>目前业界比较流行的链路追踪系统如：Twitter的<strong>Zipkin</strong>，阿里的<strong>鹰眼</strong>，美团的<strong>Mtrace</strong>，大众点评的
<strong>cat</strong>等，大部分都是基于google发表的Dapper。Dapper阐述了分布式系统，特别是微服务架构中链路
追踪的概念、数据表示、埋点、传递、收集、存储与展示等技术细节。</p> <h3 id="_4-2-sleuth概述"><a href="#_4-2-sleuth概述" class="header-anchor">#</a> 4.2 Sleuth概述</h3> <h4 id="_4-2-1-简介"><a href="#_4-2-1-简介" class="header-anchor">#</a> 4.2.1 简介</h4> <p>Spring Cloud Sleuth 主要功能就是在分布式系统中提供追踪解决方案，并且兼容支持了 zipkin，你只需要在pom文件中引入相应的依赖即可。</p> <h4 id="_4-2-2-相关概念"><a href="#_4-2-2-相关概念" class="header-anchor">#</a> 4.2.2 相关概念</h4> <p>Spring Cloud Sleuth 为Spring Cloud提供了分布式根据的解决方案。它大量借用了Google Dapper的设计。先来了解一下Sleuth中的术语和相关概念。</p> <p>Spring Cloud Sleuth采用的是Google的开源项目Dapper的专业术语。</p> <ul><li><strong>Span</strong>：基本工作单元，例如，在一个新建的span中发送一个RPC等同于发送一个回应请求给RPC，span通过一个64位ID唯一标识，trace以另一个64位ID表示，span还有其他数据信息，比如摘要、时间戳事件、关键值注释(tags)、span的ID、以及进度ID(通常是IP地址) span在不断的启动和停止，同时记录了时间信息，当你创建了一个span，你必须在未来的某个时刻停止它。</li> <li><strong>Trace</strong>：一系列spans组成的一个树状结构，例如，如果你正在跑一个分布式大数据工程，你可能需要创建一个trace。</li> <li><strong>Annotation</strong>：用来及时记录一个事件的存在，一些核心annotations用来定义一个请求的开始和结束
<ul><li>cs - Client Sent -客户端发起一个请求，这个annotion描述了这个span的开始</li> <li>sr - Server Received -服务端获得请求并准备开始处理它，如果将其sr减去cs时间戳便可得到网络延迟</li> <li>ss - Server Sent -注解表明请求处理的完成(当请求返回客户端)，如果ss减去sr时间戳便可得到服务端需要的处理请求时间</li> <li>cr - Client Received -表明span的结束，客户端成功接收到服务端的回复，如果cr减去cs时间戳便可得到客户端从服务端获取回复的所有所需时间</li></ul></li></ul> <img src="/assets/img/image-20220306220121422.fef6144a.png" alt="image-20220306220121422" style="zoom:50%;"> <h4 id="_4-3-链路追踪sleuth入门"><a href="#_4-3-链路追踪sleuth入门" class="header-anchor">#</a> 4.3 链路追踪Sleuth入门</h4> <p>接下来通过之前的项目案例整合Sleuth，完成入门案例的编写</p> <p><strong>（1） 配置依赖</strong></p> <p>修改微服务工程引入Sleuth依赖</p> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span> 
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span> 
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-sleuth<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span> 
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p><strong>（2） 修改配置文件</strong></p> <p>修改application.yml添加日志级别</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">logging</span><span class="token punctuation">:</span> 
  <span class="token key atrule">level</span><span class="token punctuation">:</span> 
    <span class="token key atrule">root</span><span class="token punctuation">:</span> INFO 
    <span class="token key atrule">org.springframework.web.servlet.DispatcherServlet</span><span class="token punctuation">:</span> DEBUG 
    <span class="token key atrule">org.springframework.cloud.sleuth</span><span class="token punctuation">:</span> DEBUG
</code></pre></div><p>每个微服务都需要添加如上的配置。启动微服务，调用之后，我们可以在控制台观察到sleuth的日志输
出。</p> <p><img src="/assets/img/image-20220306220332437.8af5d3ad.png" alt="image-20220306220332437"></p> <p>其中 <code>ff8ff8b803a3b558</code> 是TraceId，后面跟着的是SpanId，依次调用有一个全局的TraceId，将调用链路串起来。仔细分析每个微服务的日志，不难看出请求的具体过程。</p> <p>查看日志文件并不是一个很好的方法，当微服务越来越多日志文件也会越来越多，通过Zipkin可以将日
志聚合，并进行可视化展示和全文检索。</p> <h4 id="_4-4-zipkin的概述"><a href="#_4-4-zipkin的概述" class="header-anchor">#</a> 4.4 Zipkin的概述</h4> <p>Zipkin 是 Twitter 的一个开源项目，它基于 Google Dapper 实现，它致力于收集服务的定时数据，以解决微服务架构中的延迟问题，包括数据的收集、存储、查找和展现。 我们可以使用它来收集各个服务器上请求链路的跟踪数据，并通过它提供的 REST API 接口来辅助我们查询跟踪数据以实现对分布式系统的监控程序，从而及时地发现系统中出现的延迟升高问题并找出系统性能瓶颈的根源。除了面向开发
的 API 接口之外，它也提供了方便的 UI 组件来帮助我们直观的搜索跟踪信息和分析请求链路明细，比如：可以查询某段时间内各用户请求的处理时间等。 Zipkin 提供了可插拔数据存储方式：In￾Memory、MySql、Cassandra 以及 Elasticsearch。</p> <img src="/assets/img/image-20220306220416803.8c607e90.png" alt="image-20220306220416803" style="zoom:50%;"> <p>上图展示了 Zipkin 的基础架构，它主要由 4 个核心组件构成：</p> <ul><li><strong>Collector</strong>：收集器组件，它主要用于处理从外部系统发送过来的跟踪信息，将这些信息转换为Zipkin 内部处理的 Span 格式，以支持后续的存储、分析、展示等功能。</li> <li><strong>Storage</strong>：存储组件，它主要对处理收集器接收到的跟踪信息，默认会将这些信息存储在内存中，我们也可以修改此存储策略，通过使用其他存储组件将跟踪信息存储到数据库中。</li> <li><strong>RESTful API</strong>：API 组件，它主要用来提供外部访问接口。比如给客户端展示跟踪信息，或是外接系统访问以实现监控等。</li> <li><strong>Web UI</strong>：UI 组件，基于 API 组件实现的上层应用。通过 UI 组件用户可以方便而有直观地查询和分析跟踪信息。</li></ul> <p>Zipkin 分为两端，一个是 Zipkin 服务端，一个是 Zipkin 客户端，客户端也就是微服务的应用。客户端会配置服务端的 URL 地址，一旦发生服务间的调用的时候，会被配置在微服务里面的 Sleuth 的监听器监听，并生成相应的 Trace 和 Span 信息发送给服务端。</p> <p>发送的方式主要有两种，一种是 HTTP 报文的方式，还有一种是消息总线的方式如 RabbitMQ。</p> <p>不论哪种方式，我们都需要：</p> <ul><li>一个 Eureka 服务注册中心，这里我们就用之前的 eureka 项目来当注册中心。</li> <li>一个 Zipkin 服务端。</li> <li>多个微服务，这些微服务中配置Zipkin 客户端。</li></ul> <h4 id="_4-5-zipkin-server的部署和配置"><a href="#_4-5-zipkin-server的部署和配置" class="header-anchor">#</a> 4.5 Zipkin Server的部署和配置</h4> <p><strong>（1） Zipkin Server下载</strong></p> <p>从spring boot 2.0开始，官方就不再支持使用自建Zipkin Server的方式进行服务链路追踪，而是直接提
供了编译好的 jar 包来给我们使用。可以从官方网站下载先下载Zipkin的web UI，我们这里下载的是
<code>zipkin-server-2.12.9-exec.jar</code></p> <p><strong>（2） 启动</strong></p> <p>在命令行输入 <code>java -jar zipkin-server-2.12.9-exec.jar</code> 启动 Zipkin Server</p> <img src="/assets/img/image-20220306220655454.d19c6950.png" alt="image-20220306220655454" style="zoom:50%;"> <ul><li>默认Zipkin Server的请求端口为 9411</li> <li>Zipkin Server的启动参数可以通过官方提供的yml配置文件查找</li> <li>在浏览器输入 http://127.0.0.1:9411即可进入到Zipkin Server的管理后台</li></ul> <h4 id="_4-6-客户端zipkin-sleuth整合"><a href="#_4-6-客户端zipkin-sleuth整合" class="header-anchor">#</a> 4.6 客户端Zipkin+Sleuth整合</h4> <p>通过查看日志分析微服务的调用链路并不是一个很直观的方案，结合zipkin可以很直观地显示微服务之间的调用关系。</p> <p><strong>（1）客户端添加依赖</strong></p> <p>客户端指的是需要被追踪的微服务</p> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span> 
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span> 
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-zipkin<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span> 
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p><strong>（2）修改客户端配置文件</strong></p> <div class="language-yaml extra-class"><pre class="language-yaml"><code> <span class="token key atrule">zipkin</span><span class="token punctuation">:</span> 
   <span class="token key atrule">base-url</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//127.0.0.1<span class="token punctuation">:</span>9411/ <span class="token comment">#zipkin server的请求地址 </span>
   <span class="token key atrule">sender</span><span class="token punctuation">:</span> 
   	<span class="token key atrule">type</span><span class="token punctuation">:</span> web <span class="token comment">#请求方式,默认以http的方式向zipkin server发送追踪数据 </span>
 <span class="token key atrule">sleuth</span><span class="token punctuation">:</span> 
   <span class="token key atrule">sampler</span><span class="token punctuation">:</span> 
   	<span class="token key atrule">probability</span><span class="token punctuation">:</span> <span class="token number">1.0</span> <span class="token comment">#采样的百分比</span>
</code></pre></div><p>指定了zipkin server的地址，下面制定需采样的百分比，默认为0.1，即10%，这里配置1，是记录全部的sleuth信息，是为了收集到更多的数据（仅供测试用）。在分布式系统中，过于频繁的采样会影响系统性能，所以这里配置需要采用一个合适的值。</p> <img src="/assets/img/image-20220306220928185.3d18cf2a.png" alt="image-20220306220928185" style="zoom:50%;"> <p><strong>（3） 测试</strong>
以此启动每个微服务，启动Zipkin Service。通过浏览器发送一次微服务请求。打开 Zipkin Service控制台，我们可以根据条件追踪每次请求调用过程</p> <p>单击该trace可以看到请求的细节</p> <img src="/assets/img/image-20220306220945226.3c23492b.png" alt="image-20220306220945226" style="zoom:50%;"> <h4 id="_4-7-基于消息中间件收集数据"><a href="#_4-7-基于消息中间件收集数据" class="header-anchor">#</a> 4.7 基于消息中间件收集数据</h4> <p>在默认情况下，Zipkin客户端和Server之间是使用HTTP请求的方式进行通信（即同步的请求方式），在网络波动，Server端异常等情况下可能存在信息收集不及时的问题。Zipkin支持与rabbitMQ整合完成异步消息传输。</p> <p>加了MQ之后，通信过程如下图所示：</p> <img src="/assets/img/image-20220306221028271.6ac5dfb2.png" alt="image-20220306221028271" style="zoom:50%;"> <h5 id="_4-7-1-rabbitmq的安装与启动"><a href="#_4-7-1-rabbitmq的安装与启动" class="header-anchor">#</a> 4.7.1 RabbitMQ的安装与启动</h5> <p>略</p> <h5 id="_4-7-2-服务端启动"><a href="#_4-7-2-服务端启动" class="header-anchor">#</a> 4.7.2 服务端启动</h5> <div class="language-bash extra-class"><pre class="language-bash"><code>java -jar zipkin-server-2.12.9-exec.jar --RABBIT_ADDRESSES<span class="token operator">=</span><span class="token number">127.0</span>.0.1:5672
</code></pre></div><ul><li>RABBIT_ADDRESSES ： 指定RabbitMQ地址</li> <li>RABBIT_USER： 用户名（默认guest）</li> <li>RABBIT_PASSWORD ： 密码（默认guest）</li></ul> <p>启动Zipkin Server之后，我们打开RabbitMQ的控制台可以看到多了一个Queue</p> <img src="/assets/img/image-20220306221102337.22fee3b5.png" alt="image-20220306221102337" style="zoom:50%;"> <p>其中 <code>zipkin</code> 就是为我们自动创建的Queue队列</p> <h5 id="_7-7-3-客户端配置"><a href="#_7-7-3-客户端配置" class="header-anchor">#</a> 7.7.3 客户端配置</h5> <p><strong>（1） 配置依赖</strong></p> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-sleuth<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-zipkin<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-sleuth-zipkin<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.amqp<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-rabbit<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>导入 <code>spring-rabbit</code> 依赖，是Spring提供的对rabbit的封装，客户端会根据配置自动的生产消息并发送到目标队列中</p> <p><strong>（2） 配置消息中间件rabbit mq地址等信息</strong></p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">zipkin</span><span class="token punctuation">:</span>
	<span class="token comment">#base-url: http://127.0.0.1:9411/ #zipkin server的请求地址</span>
	<span class="token key atrule">sender</span><span class="token punctuation">:</span>
   <span class="token key atrule">type</span><span class="token punctuation">:</span> rabbit
	<span class="token comment">#type: web #请求方式,默认以http的方式向zipkin server发送追踪数据</span>

<span class="token key atrule">sleuth</span><span class="token punctuation">:</span> 
	<span class="token key atrule">sampler</span><span class="token punctuation">:</span> 
		<span class="token key atrule">probability</span><span class="token punctuation">:</span> <span class="token number">1.0</span> <span class="token comment">#采样的百分比 </span>
<span class="token key atrule">rabbitmq</span><span class="token punctuation">:</span> 
	<span class="token key atrule">host</span><span class="token punctuation">:</span> localhost 
	<span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">5672</span> 
	<span class="token key atrule">username</span><span class="token punctuation">:</span> guest 
	<span class="token key atrule">password</span><span class="token punctuation">:</span> guest 
	<span class="token key atrule">listener</span><span class="token punctuation">:</span> <span class="token comment"># 这里配置了重试策略 </span>
		<span class="token key atrule">direct</span><span class="token punctuation">:</span> 
			<span class="token key atrule">retry</span><span class="token punctuation">:</span> 
				<span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span> 
		<span class="token key atrule">simple</span><span class="token punctuation">:</span> 
			<span class="token key atrule">retry</span><span class="token punctuation">:</span> 
				<span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span> 
</code></pre></div><ul><li>修改消息的投递方式，改为rabbit即可。</li> <li>添加rabbitmq的相关配置</li></ul> <p><strong>（3） 测试</strong></p> <p>关闭Zipkin Server，并随意请求连接。打开rabbitmq管理后台可以看到，消息已经推送到rabbitmq。 当Zipkin Server启动时，会自动的从rabbitmq获取消息并消费，展示追踪数据</p> <p>可以看到如下效果：</p> <ul><li>请求的耗时时间不会出现突然耗时特长的情况</li> <li>当ZipkinServer不可用时（比如关闭、网络不通等），追踪信息不会丢失，因为这些信息会保存在Rabbitmq服务器上，直到Zipkin服务器可用时，再从Rabbitmq中取出这段时间的信息</li></ul> <h4 id="_4-8-存储跟踪数据"><a href="#_4-8-存储跟踪数据" class="header-anchor">#</a> 4.8 存储跟踪数据</h4> <p>Zipkin Server默认时间追踪数据信息保存到内存，这种方式不适合生产环境。因为一旦Service关闭重启或者服务崩溃，就会导致历史数据消失。Zipkin支持将追踪数据持久化到mysql数据库或者存储到elasticsearch中。这里已mysql为例。</p> <h5 id="_4-8-1-准备数据库"><a href="#_4-8-1-准备数据库" class="header-anchor">#</a> 4.8.1 准备数据库</h5> <p>可以从官网找到Zipkin Server持久mysql的数据库脚本。</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token operator">NOT</span> <span class="token keyword">EXISTS</span> zipkin_spans
<span class="token punctuation">(</span>
    <span class="token punctuation">`</span>trace_id_high<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span>       <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token number">0</span> <span class="token keyword">COMMENT</span> <span class="token string">'If non zero, this means the trace uses 128 bit traceIds instead of 64 bit'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>trace_id<span class="token punctuation">`</span>      <span class="token keyword">BIGINT</span>       <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>id<span class="token punctuation">`</span>            <span class="token keyword">BIGINT</span>       <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>name<span class="token punctuation">`</span>          <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>parent_id<span class="token punctuation">`</span>     <span class="token keyword">BIGINT</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>debug<span class="token punctuation">`</span>         <span class="token keyword">BIT</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>start_ts<span class="token punctuation">`</span>      <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'Span.timestamp(): epoch micros used for endTs query and to implement TTL'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>duration<span class="token punctuation">`</span>      <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'Span.duration(): micros used for minDuration and maxDuration query'</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span> <span class="token operator">=</span> <span class="token keyword">InnoDB</span>
  ROW_FORMAT <span class="token operator">=</span> COMPRESSED
  <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> <span class="token operator">=</span> utf8
  <span class="token keyword">COLLATE</span> utf8_general_ci<span class="token punctuation">;</span>
<span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> zipkin_spans
    <span class="token keyword">ADD</span> <span class="token keyword">UNIQUE</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>trace_id_high<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>trace_id<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>id<span class="token punctuation">`</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'ignore insert on duplicate'</span><span class="token punctuation">;</span>
<span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> zipkin_spans
    <span class="token keyword">ADD</span> <span class="token keyword">INDEX</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>trace_id_high<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>trace_id<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>id<span class="token punctuation">`</span><span class="token punctuation">)</span>
        <span class="token keyword">COMMENT</span> <span class="token string">'for joining with zipkin_annotations'</span><span class="token punctuation">;</span>
<span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> zipkin_spans
    <span class="token keyword">ADD</span> <span class="token keyword">INDEX</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>trace_id_high<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>trace_id<span class="token punctuation">`</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'for 
getTracesByIds'</span><span class="token punctuation">;</span>
<span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> zipkin_spans
    <span class="token keyword">ADD</span> <span class="token keyword">INDEX</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>name<span class="token punctuation">`</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'for getTraces and 
getSpanNames'</span><span class="token punctuation">;</span>
<span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> zipkin_spans
    <span class="token keyword">ADD</span> <span class="token keyword">INDEX</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>start_ts<span class="token punctuation">`</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'for getTraces 
ordering and range'</span><span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token operator">NOT</span> <span class="token keyword">EXISTS</span> zipkin_annotations
<span class="token punctuation">(</span>
    <span class="token punctuation">`</span>trace_id_high<span class="token punctuation">`</span>         <span class="token keyword">BIGINT</span>       <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token number">0</span> <span class="token keyword">COMMENT</span> <span class="token string">'If non zero, this means 
the trace uses 128 bit traceIds instead of 64 bit'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>trace_id<span class="token punctuation">`</span>              <span class="token keyword">BIGINT</span>       <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'coincides with zipkin_spans.trace_id'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>span_id<span class="token punctuation">`</span>               <span class="token keyword">BIGINT</span>       <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'coincides with zipkin_spans.id'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>a_key<span class="token punctuation">`</span>                 <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'BinaryAnnotation.key or 
Annotation.value if type == -1'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>a_value<span class="token punctuation">`</span>               <span class="token keyword">BLOB</span> <span class="token keyword">COMMENT</span> <span class="token string">'BinaryAnnotation.value(), which must be smaller 
than 64KB'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>a_type<span class="token punctuation">`</span>                <span class="token keyword">INT</span>          <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'BinaryAnnotation.type() or -1 if 
Annotation'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>a_timestamp<span class="token punctuation">`</span>           <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'Used to implement TTL; Annotation.timestamp 
or zipkin_spans.timestamp'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>endpoint_ipv4<span class="token punctuation">`</span>         <span class="token keyword">INT</span> <span class="token keyword">COMMENT</span> <span class="token string">'Null when Binary/Annotation.endpoint is 
null'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>endpoint_ipv6<span class="token punctuation">`</span>         <span class="token keyword">BINARY</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'Null when Binary/Annotation.endpoint 
is null, or no IPv6 address'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>endpoint_port<span class="token punctuation">`</span>         <span class="token keyword">SMALLINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'Null when Binary/Annotation.endpoint is 
null'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>endpoint_service_name<span class="token punctuation">`</span> <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'Null when 
Binary/Annotation.endpoint is null'</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span> <span class="token operator">=</span> <span class="token keyword">InnoDB</span>
  ROW_FORMAT <span class="token operator">=</span> COMPRESSED
  <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> <span class="token operator">=</span> utf8
  <span class="token keyword">COLLATE</span>
      utf8_general_ci<span class="token punctuation">;</span>
<span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> zipkin_annotations
    <span class="token keyword">ADD</span> <span class="token keyword">UNIQUE</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>trace_id_high<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>trace_id<span class="token punctuation">`</span><span class="token punctuation">,</span>
                    <span class="token punctuation">`</span>span_id<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>a_key<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>a_timestamp<span class="token punctuation">`</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'Ignore insert on duplicate'</span><span class="token punctuation">;</span>
<span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> zipkin_annotations
    <span class="token keyword">ADD</span> <span class="token keyword">INDEX</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>trace_id_high<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>trace_id<span class="token punctuation">`</span><span class="token punctuation">,</span>
               <span class="token punctuation">`</span>span_id<span class="token punctuation">`</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'for joining with zipkin_spans'</span><span class="token punctuation">;</span>
<span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> zipkin_annotations
    <span class="token keyword">ADD</span> <span class="token keyword">INDEX</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>trace_id_high<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>trace_id<span class="token punctuation">`</span><span class="token punctuation">)</span>
        <span class="token keyword">COMMENT</span> <span class="token string">'for getTraces/ByIds'</span><span class="token punctuation">;</span>
<span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> zipkin_annotations
    <span class="token keyword">ADD</span> <span class="token keyword">INDEX</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>endpoint_service_name<span class="token punctuation">`</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span>
        <span class="token string">'for getTraces and getServiceNames'</span><span class="token punctuation">;</span>
<span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> zipkin_annotations
    <span class="token keyword">ADD</span> <span class="token keyword">INDEX</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>a_type<span class="token punctuation">`</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'for getTraces'</span><span class="token punctuation">;</span>
<span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> zipkin_annotations
    <span class="token keyword">ADD</span> <span class="token keyword">INDEX</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>a_key<span class="token punctuation">`</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'for getTraces'</span><span class="token punctuation">;</span>
<span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> zipkin_annotations
    <span class="token keyword">ADD</span> <span class="token keyword">INDEX</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>trace_id<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>span_id<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>a_key<span class="token punctuation">`</span><span class="token punctuation">)</span>
        <span class="token keyword">COMMENT</span> <span class="token string">'for dependencies job'</span><span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token operator">NOT</span> <span class="token keyword">EXISTS</span> zipkin_dependencies
<span class="token punctuation">(</span>
    <span class="token punctuation">`</span><span class="token keyword">day</span><span class="token punctuation">`</span>        <span class="token keyword">DATE</span>         <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>parent<span class="token punctuation">`</span>     <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>child<span class="token punctuation">`</span>      <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>call_count<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span> <span class="token operator">=</span> <span class="token keyword">InnoDB</span>
  ROW_FORMAT <span class="token operator">=</span> COMPRESSED
  <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> <span class="token operator">=</span> utf8
  <span class="token keyword">COLLATE</span>
      utf8_general_ci<span class="token punctuation">;</span>
<span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> zipkin_dependencies
    <span class="token keyword">ADD</span> <span class="token keyword">UNIQUE</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span><span class="token keyword">day</span><span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>parent<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>child<span class="token punctuation">`</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h5 id="_4-8-2-配置启动服务端"><a href="#_4-8-2-配置启动服务端" class="header-anchor">#</a> 4.8.2 配置启动服务端</h5> <div class="language-bash extra-class"><pre class="language-bash"><code>java -jar zipkin-server-2.12.9-exec.jar --STORAGE_TYPE<span class="token operator">=</span>mysql --
<span class="token assign-left variable">MYSQL_HOST</span><span class="token operator">=</span><span class="token number">127.0</span>.0.1 --MYSQL_TCP_PORT<span class="token operator">=</span><span class="token number">3306</span> --MYSQL_DB<span class="token operator">=</span>zipkin --MYSQL_USER<span class="token operator">=</span>root -
-MYSQL_PASS<span class="token operator">=</span><span class="token number">111111</span>
</code></pre></div><ul><li>STORAGE_TYPE : 存储类型</li> <li>MYSQL_HOST： mysql主机地址</li> <li>MYSQL_TCP_PORT：mysql端口</li> <li>MYSQL_DB： mysql数据库名称</li> <li>MYSQL_USER：mysql用户名</li> <li>MYSQL_PASS ：mysql密码</li></ul> <p>配置好服务端之后，可以在浏览器请求几次。回到数据库查看会发现数据已经持久化到mysql中</p> <img src="/assets/img/image-20220306221850527.6cc12706.png" alt="image-20220306221850527" style="zoom:67%;"></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/springcloud/springcloud-day2.html" class="prev">
        springcloud-day2
      </a></span> <span class="next"><a href="/springcloud/springcloud-day4.html">
        springcloud-day4
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.e7cabdd2.js" defer></script><script src="/assets/js/5.64292b6a.js" defer></script><script src="/assets/js/7.d18fc8f0.js" defer></script>
  </body>
</html>
