<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>1 服务调用Feign入门 | JavaPool</title>
    <meta name="generator" content="VuePress 1.8.2">
    
    <meta name="description" content="java poll icu">
    
    <link rel="preload" href="/assets/css/0.styles.739ffb83.css" as="style"><link rel="preload" href="/assets/js/app.703887ae.js" as="script"><link rel="preload" href="/assets/js/5.a0d7f1b0.js" as="script"><link rel="preload" href="/assets/js/7.774e7eba.js" as="script"><link rel="prefetch" href="/assets/js/10.7bf0a1b3.js"><link rel="prefetch" href="/assets/js/11.416a5e09.js"><link rel="prefetch" href="/assets/js/12.e7369249.js"><link rel="prefetch" href="/assets/js/13.e4aa4c93.js"><link rel="prefetch" href="/assets/js/14.6e22c037.js"><link rel="prefetch" href="/assets/js/15.f55f5feb.js"><link rel="prefetch" href="/assets/js/16.665a2199.js"><link rel="prefetch" href="/assets/js/17.b291388d.js"><link rel="prefetch" href="/assets/js/18.dcd2a204.js"><link rel="prefetch" href="/assets/js/19.1791ec85.js"><link rel="prefetch" href="/assets/js/2.dc8fbfc9.js"><link rel="prefetch" href="/assets/js/20.d3c04908.js"><link rel="prefetch" href="/assets/js/21.b7303ae3.js"><link rel="prefetch" href="/assets/js/22.a772e2e0.js"><link rel="prefetch" href="/assets/js/23.2d91ffa4.js"><link rel="prefetch" href="/assets/js/24.12863234.js"><link rel="prefetch" href="/assets/js/25.cb485913.js"><link rel="prefetch" href="/assets/js/26.54d2dfd2.js"><link rel="prefetch" href="/assets/js/27.393a7916.js"><link rel="prefetch" href="/assets/js/28.8ea95b85.js"><link rel="prefetch" href="/assets/js/29.ef83c70d.js"><link rel="prefetch" href="/assets/js/3.16fa89d5.js"><link rel="prefetch" href="/assets/js/30.4b5f3cd3.js"><link rel="prefetch" href="/assets/js/31.01d71860.js"><link rel="prefetch" href="/assets/js/32.963a7f64.js"><link rel="prefetch" href="/assets/js/33.39a77819.js"><link rel="prefetch" href="/assets/js/34.4b8b8c36.js"><link rel="prefetch" href="/assets/js/35.2a760994.js"><link rel="prefetch" href="/assets/js/36.6caffbd6.js"><link rel="prefetch" href="/assets/js/37.2196b9db.js"><link rel="prefetch" href="/assets/js/38.9fb0d6ac.js"><link rel="prefetch" href="/assets/js/39.1d39e635.js"><link rel="prefetch" href="/assets/js/4.65d241db.js"><link rel="prefetch" href="/assets/js/40.3bee0182.js"><link rel="prefetch" href="/assets/js/41.74a36917.js"><link rel="prefetch" href="/assets/js/42.4982c59c.js"><link rel="prefetch" href="/assets/js/43.eefece58.js"><link rel="prefetch" href="/assets/js/44.8df55003.js"><link rel="prefetch" href="/assets/js/45.e1b02261.js"><link rel="prefetch" href="/assets/js/46.2470e152.js"><link rel="prefetch" href="/assets/js/47.3e3a3271.js"><link rel="prefetch" href="/assets/js/48.89b52cdb.js"><link rel="prefetch" href="/assets/js/49.62b331e8.js"><link rel="prefetch" href="/assets/js/50.901c44c5.js"><link rel="prefetch" href="/assets/js/51.d3dd8996.js"><link rel="prefetch" href="/assets/js/52.35a59463.js"><link rel="prefetch" href="/assets/js/6.f00bc246.js"><link rel="prefetch" href="/assets/js/8.6ad0047a.js"><link rel="prefetch" href="/assets/js/9.62e58274.js">
    <link rel="stylesheet" href="/assets/css/0.styles.739ffb83.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">JavaPool</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <!----></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><!---->  <ul class="sidebar-links"><li><a href="/" aria-current="page" class="sidebar-link">首页</a></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>基础</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/basics/反射.html" class="sidebar-link">反射</a></li><li><a href="/basics/注解.html" class="sidebar-link">注解</a></li><li><a href="/basics/枚举.html" class="sidebar-link">枚举</a></li><li><a href="/basics/IO.html" class="sidebar-link">IO</a></li><li><a href="/basics/集合.html" class="sidebar-link">集合</a></li><li><a href="/basics/异常.html" class="sidebar-link">异常</a></li><li><a href="/basics/拦截器.html" class="sidebar-link">拦截器</a></li><li><a href="/basics/过虑器.html" class="sidebar-link">过虑器</a></li><li><a href="/basics/jdk8.html" class="sidebar-link">jdk8</a></li><li><a href="/basics/Java8-Lambda.html" class="sidebar-link">Java8-Lambda</a></li><li><a href="/basics/Java8-Stream.html" class="sidebar-link">Java8-Stream</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>设计模式</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/designpattern/黑马-设计模式.html" class="sidebar-link">黑马-设计模式</a></li><li><a href="/designpattern/UML.html" class="sidebar-link">UML类图</a></li><li><a href="/designpattern/七大原则.html" class="sidebar-link">七大原则</a></li><li><a href="/designpattern/23种设计模式.html" class="sidebar-link">23种设计模式</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>JVM</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/bar/three.html" class="sidebar-link">JVM基础概念</a></li><li><a href="/bar/four.html" class="sidebar-link">JVM实战</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>并发多线程</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/thread/并发编程三大核心问题.html" class="sidebar-link">并发编程三大核心问题</a></li><li><a href="/thread/深入理解线程池.html" class="sidebar-link">深入理解线程池</a></li><li><a href="/thread/线程池.html" class="sidebar-link">线程池</a></li><li><a href="/thread/并发编程-FutureTask.html" class="sidebar-link">并发编程-FutureTask</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>MySQL</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/mysql/索引.html" class="sidebar-link">索引</a></li><li><a href="/mysql/锁.html" class="sidebar-link">锁</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Redis</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/redis/持久化.html" class="sidebar-link">持久化</a></li><li><a href="/redis/分布式锁.html" class="sidebar-link">分布式锁</a></li><li><a href="/redis/Redis官方的高可用解决方案.html" class="sidebar-link">Redis官方的高可用解决方案</a></li><li><a href="/redis/数据库缓存最终一致性的四种方案.html" class="sidebar-link">数据库缓存最终一致性的四种方案</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Spring</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/spring/BeanFactory和FactoryBean的区别.html" class="sidebar-link">BeanFactory和FactoryBean的区别</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Mybatis</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/mybatis/MyBatis的SQL执行流程分析.html" class="sidebar-link">MyBatis的SQL执行流程分析</a></li><li><a href="/mybatis/MyBatisPlus.html" class="sidebar-link">MyBatisPlus</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>SpringBoot</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/springboot/SpringBoot经典学习笔记.html" class="sidebar-link">SpringBoot经典学习笔记</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Spring Cloud</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/springcloud/springcloud-黑马教程.html" class="sidebar-link">springcloud-黑马教程</a></li><li><a href="/springcloud/springcloud-day2.html" aria-current="page" class="active sidebar-link">springcloud-day2</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/springcloud/springcloud-day2.html#_1-服务调用feign入门" class="sidebar-link">1 服务调用Feign入门</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/springcloud/springcloud-day2.html#_1-1-feign简介" class="sidebar-link">1.1 Feign简介</a></li><li class="sidebar-sub-header"><a href="/springcloud/springcloud-day2.html#_1-2-基于feign的服务调用" class="sidebar-link">1.2 基于Feign的服务调用</a></li><li class="sidebar-sub-header"><a href="/springcloud/springcloud-day2.html#_1-3-feign和ribbon的联系" class="sidebar-link">1.3 Feign和Ribbon的联系</a></li><li class="sidebar-sub-header"><a href="/springcloud/springcloud-day2.html#_1-4-负载均衡" class="sidebar-link">1.4 负载均衡</a></li></ul></li><li class="sidebar-sub-header"><a href="/springcloud/springcloud-day2.html#_2-服务调用feign高级" class="sidebar-link">2 服务调用Feign高级</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/springcloud/springcloud-day2.html#_2-1-feign的配置" class="sidebar-link">2.1 Feign的配置</a></li><li class="sidebar-sub-header"><a href="/springcloud/springcloud-day2.html#_2-2-请求压缩" class="sidebar-link">2.2 请求压缩</a></li><li class="sidebar-sub-header"><a href="/springcloud/springcloud-day2.html#_2-3-日志级别" class="sidebar-link">2.3 日志级别</a></li><li class="sidebar-sub-header"><a href="/springcloud/springcloud-day2.html#_2-4-源码分析" class="sidebar-link">2.4 源码分析</a></li></ul></li><li class="sidebar-sub-header"><a href="/springcloud/springcloud-day2.html#_3-服务注册与发现总结" class="sidebar-link">3 服务注册与发现总结</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/springcloud/springcloud-day2.html#_3-1-组件的使用方式" class="sidebar-link">3.1 组件的使用方式</a></li><li class="sidebar-sub-header"><a href="/springcloud/springcloud-day2.html#_3-1-1-注册中心" class="sidebar-link" style="padding-left:3rem;">3.1.1 注册中心</a></li><li class="sidebar-sub-header"><a href="/springcloud/springcloud-day2.html#_3-1-2-服务调用" class="sidebar-link" style="padding-left:3rem;">3.1.2 服务调用</a></li></ul></li><li class="sidebar-sub-header"><a href="/springcloud/springcloud-day2.html#_4-微服务架构的高并发问题" class="sidebar-link">4 微服务架构的高并发问题</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/springcloud/springcloud-day2.html#_4-1-性能工具jmetter" class="sidebar-link">4.1 性能工具Jmetter</a></li><li class="sidebar-sub-header"><a href="/springcloud/springcloud-day2.html#_4-1-1-安装jmetter" class="sidebar-link" style="padding-left:3rem;">4.1.1 安装Jmetter</a></li><li class="sidebar-sub-header"><a href="/springcloud/springcloud-day2.html#_4-1-2-配置jmetter" class="sidebar-link" style="padding-left:3rem;">4.1.2 配置Jmetter</a></li><li class="sidebar-sub-header"><a href="/springcloud/springcloud-day2.html#_4-2-系统负载过高存在的问题" class="sidebar-link">4.2 系统负载过高存在的问题</a></li><li class="sidebar-sub-header"><a href="/springcloud/springcloud-day2.html#_4-2-1-问题分析" class="sidebar-link" style="padding-left:3rem;">4.2.1 问题分析</a></li><li class="sidebar-sub-header"><a href="/springcloud/springcloud-day2.html#_4-2-2-线程池的形式实现服务隔离" class="sidebar-link" style="padding-left:3rem;">4.2.2 线程池的形式实现服务隔离</a></li></ul></li><li class="sidebar-sub-header"><a href="/springcloud/springcloud-day2.html#_5-服务熔断hystrix入门" class="sidebar-link">5 服务熔断Hystrix入门</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/springcloud/springcloud-day2.html#_5-1-服务容错的核心知识" class="sidebar-link">5.1 服务容错的核心知识</a></li><li class="sidebar-sub-header"><a href="/springcloud/springcloud-day2.html#_5-1-1-雪崩效应" class="sidebar-link" style="padding-left:3rem;">5.1.1 雪崩效应</a></li><li class="sidebar-sub-header"><a href="/springcloud/springcloud-day2.html#_5-1-2-服务隔离" class="sidebar-link" style="padding-left:3rem;">5.1.2 服务隔离</a></li><li class="sidebar-sub-header"><a href="/springcloud/springcloud-day2.html#_5-1-3-熔断降级" class="sidebar-link" style="padding-left:3rem;">5.1.3 熔断降级</a></li><li class="sidebar-sub-header"><a href="/springcloud/springcloud-day2.html#_5-1-4-服务限流" class="sidebar-link" style="padding-left:3rem;">5.1.4 服务限流</a></li><li class="sidebar-sub-header"><a href="/springcloud/springcloud-day2.html#_5-2-hystrix介绍" class="sidebar-link">5.2 Hystrix介绍</a></li><li class="sidebar-sub-header"><a href="/springcloud/springcloud-day2.html#_5-3-rest实现服务熔断" class="sidebar-link">5.3 Rest实现服务熔断</a></li><li class="sidebar-sub-header"><a href="/springcloud/springcloud-day2.html#_5-4-feign实现服务熔断" class="sidebar-link">5.4 Feign实现服务熔断</a></li></ul></li><li class="sidebar-sub-header"><a href="/springcloud/springcloud-day2.html#_6-服务熔断hystrix高级" class="sidebar-link">6 服务熔断Hystrix高级</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/springcloud/springcloud-day2.html#_6-1-hystrix的监控平台" class="sidebar-link">6.1 Hystrix的监控平台</a></li><li class="sidebar-sub-header"><a href="/springcloud/springcloud-day2.html#_6-1-1-搭建hystrix-dashboard监控" class="sidebar-link" style="padding-left:3rem;">6.1.1 搭建Hystrix DashBoard监控</a></li><li class="sidebar-sub-header"><a href="/springcloud/springcloud-day2.html#_6-1-2断路器聚合监控turbine" class="sidebar-link" style="padding-left:3rem;">6.1.2断路器聚合监控Turbine</a></li><li class="sidebar-sub-header"><a href="/springcloud/springcloud-day2.html#_6-2-熔断器的状态" class="sidebar-link">6.2 熔断器的状态</a></li><li class="sidebar-sub-header"><a href="/springcloud/springcloud-day2.html#_6-3-熔断器的隔离策略" class="sidebar-link">6.3 熔断器的隔离策略</a></li><li class="sidebar-sub-header"><a href="/springcloud/springcloud-day2.html#_6-4-hystrix的核心源码" class="sidebar-link">6.4 Hystrix的核心源码</a></li><li class="sidebar-sub-header"><a href="/springcloud/springcloud-day2.html#_6-4-1-hystrixcommand注解" class="sidebar-link" style="padding-left:3rem;">6.4.1 HystrixCommand注解</a></li></ul></li><li class="sidebar-sub-header"><a href="/springcloud/springcloud-day2.html#_7-服务熔断hystrix的替换方案" class="sidebar-link">7 服务熔断Hystrix的替换方案</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/springcloud/springcloud-day2.html#_7-1-替换方案介绍" class="sidebar-link">7.1 替换方案介绍</a></li><li class="sidebar-sub-header"><a href="/springcloud/springcloud-day2.html#_7-2-sentinel概述" class="sidebar-link">7.2 Sentinel概述</a></li><li class="sidebar-sub-header"><a href="/springcloud/springcloud-day2.html#_7-2-1-sentinel简介" class="sidebar-link" style="padding-left:3rem;">7.2.1 Sentinel简介</a></li><li class="sidebar-sub-header"><a href="/springcloud/springcloud-day2.html#_7-2-2-sentinel与hystrix的区别" class="sidebar-link" style="padding-left:3rem;">7.2.2 Sentinel与Hystrix的区别</a></li><li class="sidebar-sub-header"><a href="/springcloud/springcloud-day2.html#_7-2-3-迁移方案" class="sidebar-link" style="padding-left:3rem;">7.2.3 迁移方案</a></li><li class="sidebar-sub-header"><a href="/springcloud/springcloud-day2.html#_7-2-4-名词解释" class="sidebar-link" style="padding-left:3rem;">7.2.4 名词解释</a></li><li class="sidebar-sub-header"><a href="/springcloud/springcloud-day2.html#_7-3-sentinel中的管理控制台" class="sidebar-link">7.3 Sentinel中的管理控制台</a></li><li class="sidebar-sub-header"><a href="/springcloud/springcloud-day2.html#_7-3-1-下载启动控制台" class="sidebar-link" style="padding-left:3rem;">7.3.1 下载启动控制台</a></li><li class="sidebar-sub-header"><a href="/springcloud/springcloud-day2.html#_7-3-2-客户端能接入控制台" class="sidebar-link" style="padding-left:3rem;">7.3.2 客户端能接入控制台</a></li><li class="sidebar-sub-header"><a href="/springcloud/springcloud-day2.html#_7-3-3-查看机器列表以及健康情况" class="sidebar-link" style="padding-left:3rem;">7.3.3 查看机器列表以及健康情况</a></li><li class="sidebar-sub-header"><a href="/springcloud/springcloud-day2.html#_7-4-基于sentinel的服务保护" class="sidebar-link">7.4 基于Sentinel的服务保护</a></li><li class="sidebar-sub-header"><a href="/springcloud/springcloud-day2.html#_7-4-1-通用资源保护" class="sidebar-link" style="padding-left:3rem;">7.4.1 通用资源保护</a></li><li class="sidebar-sub-header"><a href="/springcloud/springcloud-day2.html#_7-4-2-rest实现熔断" class="sidebar-link" style="padding-left:3rem;">7.4.2 Rest实现熔断</a></li><li class="sidebar-sub-header"><a href="/springcloud/springcloud-day2.html#_7-4-3-feign实现熔断" class="sidebar-link" style="padding-left:3rem;">7.4.3 Feign实现熔断</a></li></ul></li></ul></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Netty</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/netty/Netty核心技术及源码剖析.html" class="sidebar-link">Netty核心技术及源码剖析</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>K8S</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/k8s/k8s-黑马.html" class="sidebar-link">k8s-黑马教程</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Linux</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/linux/Centos6.8安装mysql6.54.html" class="sidebar-link">Centos6.8安装mysql6.54</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>工具集</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/utils/完整的身份证正则表达式.html" class="sidebar-link">完整的身份证正则表达式</a></li><li><a href="/utils/Java自带工具方法.html" class="sidebar-link">Java自带工具方法</a></li></ul></section></li><li><a href="/about.html" class="sidebar-link">关于</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h2 id="_1-服务调用feign入门"><a href="#_1-服务调用feign入门" class="header-anchor">#</a> 1 服务调用Feign入门</h2> <p>前面我们使用的RestTemplate实现REST API调用，代码大致如下：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/buy/{id}&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">Product</span> <span class="token function">order</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Product</span> product <span class="token operator">=</span> restTemplate<span class="token punctuation">.</span><span class="token function">getForObject</span><span class="token punctuation">(</span><span class="token string">&quot;http://shop-service￾product/product/1&quot;</span><span class="token punctuation">,</span> <span class="token class-name">Product</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> product<span class="token punctuation">;</span> 
<span class="token punctuation">}</span>
</code></pre></div><p>由代码可知，我们是使用拼接字符串的方式构造URL的，该URL只有一个参数。但是，在现实中，URL
中往往含有多个参数。这时候我们如果还用这种方式构造URL，那么就会非常痛苦。那应该如何解决？
我们带着这样的问题进入到本章的学习。</p> <h3 id="_1-1-feign简介"><a href="#_1-1-feign简介" class="header-anchor">#</a> 1.1 Feign简介</h3> <p>Feign是Netflix开发的声明式，模板化的HTTP客户端，其灵感来自Retrofit,JAXRS-2.0以及WebSocket.</p> <ul><li>Feign可帮助我们更加便捷，优雅的调用HTTP API。</li> <li>在SpringCloud中，使用Feign非常简单——创建一个接口，并在接口上添加一些注解，代码就完成了。</li> <li>Feign支持多种注解，例如Feign自带的注解或者JAX-RS注解等。</li> <li>SpringCloud对Feign进行了增强，使Feign支持了SpringMVC注解，并整合了Ribbon和Eureka，从而让Feign的使用更加方便。</li></ul> <h3 id="_1-2-基于feign的服务调用"><a href="#_1-2-基于feign的服务调用" class="header-anchor">#</a> 1.2 基于Feign的服务调用</h3> <p><strong>（1）引入依赖</strong></p> <p>在服务消费者 shop_service_order 添加Fegin依赖</p> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-openfeign<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p><strong>（2）启动类添加Feign的支持</strong></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@SpringBootApplication</span><span class="token punctuation">(</span>scanBasePackages<span class="token operator">=</span><span class="token string">&quot;cn.itcast.order&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@EntityScan</span><span class="token punctuation">(</span><span class="token string">&quot;cn.itcast.entity&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@EnableFeignClients</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderApplication</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    		<span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">OrderApplication</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>通过@EnableFeignClients注解开启Spring Cloud Feign的支持功能</p> <p><strong>（3）启动类激活FeignClient</strong></p> <p>创建一个Feign接口，此接口是在Feign中调用微服务的核心接口</p> <p>在服务消费者 shop_service_order 添加一个 ProductFeginClient 接口</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">//指定需要调用的微服务名称 </span>

<span class="token annotation punctuation">@FeignClient</span><span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">&quot;shop-service-product&quot;</span><span class="token punctuation">)</span> 
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">ProductFeginClient</span> <span class="token punctuation">{</span> 
  <span class="token comment">//调用的请求路径 </span>
  <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;/product/{id}&quot;</span><span class="token punctuation">,</span>method <span class="token operator">=</span> <span class="token class-name">RequestMethod</span><span class="token punctuation">.</span>GET<span class="token punctuation">)</span> 
  <span class="token keyword">public</span> <span class="token class-name">Product</span> <span class="token function">findById</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Long</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token punctuation">}</span>
</code></pre></div><ul><li>定义各参数绑定时，<code>@PathVariable</code>、<code>@RequestParam</code>、<code>@RequestHeader</code>等可以指定参数属性，在Feign中绑定参数必须通过value属性来指明具体的参数名，不然会抛出异常</li> <li>@FeignClient：注解通过name指定需要调用的微服务的名称，用于创建Ribbon的负载均衡器。所以Ribbon会把 shop-service-product 解析为注册中心的服务。</li></ul> <p><strong>（4）配置请求提供者的调用接口</strong></p> <p>修改 OrderController ，添加ProductFeginClient的自动注入，并在order方法中使用ProductFeginClient 完成微服务调用</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@RestController</span> <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/order&quot;</span><span class="token punctuation">)</span> 
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderController</span> <span class="token punctuation">{</span> 
  <span class="token annotation punctuation">@Autowired</span> <span class="token keyword">private</span> <span class="token class-name">ProductFeginClient</span> productFeginClient<span class="token punctuation">;</span> 
  <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/buy/{id}&quot;</span><span class="token punctuation">)</span> 
  <span class="token keyword">public</span> <span class="token class-name">Product</span> <span class="token function">order</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span> <span class="token class-name">Long</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span> 
    <span class="token keyword">return</span> productFeginClient<span class="token punctuation">.</span><span class="token function">findById</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span> 
<span class="token punctuation">}</span> 
</code></pre></div><p>（5）测试效果</p> <p><img src="/assets/img/image-20220305215320430.a0c60e03.png" alt="image-20220305215320430"></p> <h3 id="_1-3-feign和ribbon的联系"><a href="#_1-3-feign和ribbon的联系" class="header-anchor">#</a> 1.3 Feign和Ribbon的联系</h3> <p><strong>Ribbon</strong>是一个基于 HTTP 和 TCP <strong>客户端</strong> 的负载均衡的工具。它可以 <strong>在客户端</strong> 配置RibbonServerList（服务端列表），使用 HttpClient 或 RestTemplate 模拟http请求，步骤相当繁琐。</p> <p><strong>Feign</strong> 是在 Ribbon的基础上进行了一次改进，是一个使用起来更加方便的 HTTP 客户端。采用接口的方式， 只需要创建一个接口，然后在上面添加注解即可 ，将需要调用的其他服务的方法定义成抽象方法即可， 不需要自己构建http请求。然后就像是调用自身工程的方法调用，而感觉不到是调用远程方法，使得编写客户端变得非常容易</p> <h3 id="_1-4-负载均衡"><a href="#_1-4-负载均衡" class="header-anchor">#</a> 1.4 负载均衡</h3> <p>Feign中本身已经集成了Ribbon依赖和自动配置，因此我们不需要额外引入依赖，也不需要再注册RestTemplate 对象。另外，我们可以像上节课中讲的那样去配置Ribbon，可以通过 <code>ribbon.xx</code> 来进行全局配置。也可以通过 服务名.ribbon.xx 来对指定服务配置：</p> <p>启动两个 <code>shop_service_product</code> ，重新测试可以发现使用Ribbon的轮询策略进行负载均衡</p> <p><img src="/assets/img/image-20220305215547405.04c9c7ea.png" alt="image-20220305215547405"></p> <h2 id="_2-服务调用feign高级"><a href="#_2-服务调用feign高级" class="header-anchor">#</a> 2 服务调用Feign高级</h2> <h3 id="_2-1-feign的配置"><a href="#_2-1-feign的配置" class="header-anchor">#</a> 2.1 Feign的配置</h3> <p>从Spring Cloud Edgware开始，Feign支持使用属性自定义Feign。对于一个指定名称的FeignClient（例如该Feign Client的名称为 <code>feignName</code> ），Feign支持如下配置项：</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">feign</span><span class="token punctuation">:</span> 
	<span class="token key atrule">client</span><span class="token punctuation">:</span> 
		<span class="token key atrule">config</span><span class="token punctuation">:</span> 
			<span class="token key atrule">feignName</span><span class="token punctuation">:</span> <span class="token comment">##定义FeginClient的名称 </span>
			<span class="token key atrule">connectTimeout</span><span class="token punctuation">:</span> <span class="token number">5000</span> <span class="token comment"># 相当于Request.Options </span>
			<span class="token key atrule">readTimeout</span><span class="token punctuation">:</span> <span class="token number">5000</span> <span class="token comment"># 相当于Request.Options </span>
			<span class="token comment"># 配置Feign的日志级别，相当于代码配置方式中的Logger </span>
			<span class="token key atrule">loggerLevel</span><span class="token punctuation">:</span> full 
			<span class="token comment"># Feign的错误解码器，相当于代码配置方式中的ErrorDecoder </span>
			<span class="token key atrule">errorDecoder</span><span class="token punctuation">:</span> com.example.SimpleErrorDecoder 
			<span class="token comment"># 配置重试，相当于代码配置方式中的Retryer </span>
			<span class="token key atrule">retryer</span><span class="token punctuation">:</span> com.example.SimpleRetryer 
			<span class="token comment"># 配置拦截器，相当于代码配置方式中的RequestInterceptor </span>
			<span class="token key atrule">requestInterceptors</span><span class="token punctuation">:</span> 
        <span class="token punctuation">-</span> com.example.FooRequestInterceptor 
        <span class="token punctuation">-</span> com.example.BarRequestInterceptor 
			<span class="token key atrule">decode404</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
</code></pre></div><ul><li>feignName：FeginClient的名称</li> <li>connectTimeout ： 建立链接的超时时长</li> <li>readTimeout ： 读取超时时长</li> <li>loggerLevel: Fegin的日志级别</li> <li>errorDecoder ：Feign的错误解码器</li> <li>retryer ： 配置重试</li> <li>requestInterceptors ： 添加请求拦截器</li> <li>decode404 ： 配置熔断不处理404异常</li></ul> <h3 id="_2-2-请求压缩"><a href="#_2-2-请求压缩" class="header-anchor">#</a> 2.2 请求压缩</h3> <p>Spring Cloud Feign 支持对请求和响应进行GZIP压缩，以减少通信过程中的性能损耗。通过下面的参数
即可开启请求与响应的压缩功能：</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">feign</span><span class="token punctuation">:</span> 
	<span class="token key atrule">compression</span><span class="token punctuation">:</span> 
		<span class="token key atrule">request</span><span class="token punctuation">:</span> 
			<span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span> <span class="token comment"># 开启请求压缩 </span>
		<span class="token key atrule">response</span><span class="token punctuation">:</span> 
			<span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span> <span class="token comment"># 开启响应压缩</span>
</code></pre></div><p>同时，我们也可以对请求的数据类型，以及触发压缩的大小下限进行设置：</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">feign</span><span class="token punctuation">:</span> 
	<span class="token key atrule">compression</span><span class="token punctuation">:</span> 
		<span class="token key atrule">request</span><span class="token punctuation">:</span> 
		<span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span> <span class="token comment"># 开启请求压缩 </span>
		<span class="token key atrule">mime-types</span><span class="token punctuation">:</span> text/html<span class="token punctuation">,</span>application/xml<span class="token punctuation">,</span>application/json <span class="token comment"># 设置压缩的数据类型 </span>
		<span class="token key atrule">min-request-size</span><span class="token punctuation">:</span> <span class="token number">2048</span> <span class="token comment"># 设置触发压缩的大小下限</span>
</code></pre></div><p>注：上面的数据类型、压缩大小下限均为默认值。</p> <h3 id="_2-3-日志级别"><a href="#_2-3-日志级别" class="header-anchor">#</a> 2.3 日志级别</h3> <p>在开发或者运行阶段往往希望看到Feign请求过程的日志记录，默认情况下Feign的日志是没有开启的。
要想用属性配置方式来达到日志效果，只需在 application.yml 中添加如下内容即可：</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">feign</span><span class="token punctuation">:</span> 
	<span class="token key atrule">client</span><span class="token punctuation">:</span> 
		<span class="token key atrule">config</span><span class="token punctuation">:</span>
			<span class="token key atrule">shop-service-product</span><span class="token punctuation">:</span> 
				<span class="token key atrule">loggerLevel</span><span class="token punctuation">:</span> FULL 
<span class="token key atrule">logging</span><span class="token punctuation">:</span> 
	<span class="token key atrule">level</span><span class="token punctuation">:</span> 
		<span class="token key atrule">cn.itcast.order.fegin.ProductFeginClient</span><span class="token punctuation">:</span> debug
</code></pre></div><ul><li><code>logging.level.xx : debug</code> : Feign日志只会对日志级别为debug的做出响应</li> <li><code>feign.client.config.shop-service-product.loggerLevel</code> : 配置Feign的日志Feign有四种日志级别：
<ul><li>NONE【性能最佳，适用于生产】：不记录任何日志（默认值）</li> <li>BASIC【适用于生产环境追踪问题】：仅记录请求方法、URL、响应状态代码以及执行时间</li> <li>HEADERS：记录BASIC级别的基础上，记录请求和响应的header。</li> <li>FULL【比较适用于开发及测试环境定位问题】：记录请求和响应的header、body和元数据。</li></ul></li></ul> <p><img src="/assets/img/image-20220305220320424.696be72a.png" alt="image-20220305220320424"></p> <h3 id="_2-4-源码分析"><a href="#_2-4-源码分析" class="header-anchor">#</a> 2.4 源码分析</h3> <p>通过上面的使用过程，@EnableFeignClients和@FeignClient两个注解就实现了Feign的功能，那我们从@EnableFeignClients注解开始分析Feign的源码</p> <p><strong>（1）EnableFeignClients注解</strong></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Retention</span><span class="token punctuation">(</span><span class="token class-name">RetentionPolicy</span><span class="token punctuation">.</span>RUNTIME<span class="token punctuation">)</span> 
<span class="token annotation punctuation">@Target</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token class-name">ElementType</span><span class="token punctuation">.</span>TYPE<span class="token punctuation">}</span><span class="token punctuation">)</span> 
<span class="token annotation punctuation">@Documented</span> 
<span class="token annotation punctuation">@Import</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token class-name">FeignClientsRegistrar</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">}</span><span class="token punctuation">)</span> 
<span class="token keyword">public</span> <span class="token annotation punctuation">@interface</span> <span class="token class-name">EnableFeignClients</span> <span class="token punctuation">{</span> 
	<span class="token comment">//略 </span>
<span class="token punctuation">}</span>
</code></pre></div><p>通过 <code>@EnableFeignClients</code> 引入了FeignClientsRegistrar客户端注册类</p> <p><strong>（2）FeignClientsRegistrar注册类</strong></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">class</span> <span class="token class-name">FeignClientsRegistrar</span> <span class="token keyword">implements</span> <span class="token class-name">ImportBeanDefinitionRegistrar</span><span class="token punctuation">,</span> 
<span class="token class-name">ResourceLoaderAware</span><span class="token punctuation">,</span> <span class="token class-name">EnvironmentAware</span> <span class="token punctuation">{</span> 
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">registerBeanDefinitions</span><span class="token punctuation">(</span><span class="token class-name">AnnotationMetadata</span> metadata<span class="token punctuation">,</span> 
    <span class="token class-name">BeanDefinitionRegistry</span> registry<span class="token punctuation">)</span> <span class="token punctuation">{</span> 
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">registerDefaultConfiguration</span><span class="token punctuation">(</span>metadata<span class="token punctuation">,</span> registry<span class="token punctuation">)</span><span class="token punctuation">;</span> 
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">registerFeignClients</span><span class="token punctuation">(</span>metadata<span class="token punctuation">,</span> registry<span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token punctuation">}</span> 
<span class="token punctuation">}</span>
</code></pre></div><p>通过其类结构可知，由于实现了ImportBeanDefinitionRegistrar接口，那么在registerBeanDefinitions()中就会解析和注册BeanDefinition，主要注册的对象类型有两种：</p> <ul><li>注册缺省配置的配置信息</li> <li>注册那些添加了@FeignClient的类或接口 ： 这也是我们讨论的重点</li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">registerFeignClients</span><span class="token punctuation">(</span><span class="token class-name">AnnotationMetadata</span> metadata<span class="token punctuation">,</span> <span class="token class-name">BeanDefinitionRegistry</span> registry<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">ClassPathScanningCandidateComponentProvider</span> scanner <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getScanner</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        scanner<span class="token punctuation">.</span><span class="token function">setResourceLoader</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>resourceLoader<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> attrs <span class="token operator">=</span> metadata<span class="token punctuation">.</span><span class="token function">getAnnotationAttributes</span><span class="token punctuation">(</span><span class="token class-name">EnableFeignClients</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">AnnotationTypeFilter</span> annotationTypeFilter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AnnotationTypeFilter</span><span class="token punctuation">(</span><span class="token class-name">FeignClient</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> clients <span class="token operator">=</span> attrs <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token keyword">null</span> <span class="token operator">:</span> <span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>attrs<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;clients&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Object</span> basePackages<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>clients <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> clients<span class="token punctuation">.</span>length <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">final</span> <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> clientClasses <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            basePackages <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span> var9 <span class="token operator">=</span> clients<span class="token punctuation">;</span>
            <span class="token keyword">int</span> var10 <span class="token operator">=</span> clients<span class="token punctuation">.</span>length<span class="token punctuation">;</span>

            <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> var11 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> var11 <span class="token operator">&lt;</span> var10<span class="token punctuation">;</span> <span class="token operator">++</span>var11<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> clazz <span class="token operator">=</span> var9<span class="token punctuation">[</span>var11<span class="token punctuation">]</span><span class="token punctuation">;</span>
                <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">Set</span><span class="token punctuation">)</span>basePackages<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">ClassUtils</span><span class="token punctuation">.</span><span class="token function">getPackageName</span><span class="token punctuation">(</span>clazz<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                clientClasses<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>clazz<span class="token punctuation">.</span><span class="token function">getCanonicalName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token class-name">AbstractClassTestingTypeFilter</span> filter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AbstractClassTestingTypeFilter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">protected</span> <span class="token keyword">boolean</span> <span class="token function">match</span><span class="token punctuation">(</span><span class="token class-name">ClassMetadata</span> metadata<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token class-name">String</span> cleaned <span class="token operator">=</span> metadata<span class="token punctuation">.</span><span class="token function">getClassName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replaceAll</span><span class="token punctuation">(</span><span class="token string">&quot;\\$&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">return</span> clientClasses<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>cleaned<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">;</span>
            scanner<span class="token punctuation">.</span><span class="token function">addIncludeFilter</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">FeignClientsRegistrar<span class="token punctuation">.</span>AllTypeFilter</span><span class="token punctuation">(</span><span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span>filter<span class="token punctuation">,</span> annotationTypeFilter<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            scanner<span class="token punctuation">.</span><span class="token function">addIncludeFilter</span><span class="token punctuation">(</span>annotationTypeFilter<span class="token punctuation">)</span><span class="token punctuation">;</span>
            basePackages <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getBasePackages</span><span class="token punctuation">(</span>metadata<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token class-name">Iterator</span> var17 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">Set</span><span class="token punctuation">)</span>basePackages<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">while</span><span class="token punctuation">(</span>var17<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">String</span> basePackage <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span>var17<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">BeanDefinition</span><span class="token punctuation">&gt;</span></span> candidateComponents <span class="token operator">=</span> scanner<span class="token punctuation">.</span><span class="token function">findCandidateComponents</span><span class="token punctuation">(</span>basePackage<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Iterator</span> var21 <span class="token operator">=</span> candidateComponents<span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">while</span><span class="token punctuation">(</span>var21<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">BeanDefinition</span> candidateComponent <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">BeanDefinition</span><span class="token punctuation">)</span>var21<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>candidateComponent <span class="token keyword">instanceof</span> <span class="token class-name">AnnotatedBeanDefinition</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token class-name">AnnotatedBeanDefinition</span> beanDefinition <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">AnnotatedBeanDefinition</span><span class="token punctuation">)</span>candidateComponent<span class="token punctuation">;</span>
                    <span class="token class-name">AnnotationMetadata</span> annotationMetadata <span class="token operator">=</span> beanDefinition<span class="token punctuation">.</span><span class="token function">getMetadata</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">isTrue</span><span class="token punctuation">(</span>annotationMetadata<span class="token punctuation">.</span><span class="token function">isInterface</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;@FeignClient can only be specified on an interface&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> attributes <span class="token operator">=</span> annotationMetadata<span class="token punctuation">.</span><span class="token function">getAnnotationAttributes</span><span class="token punctuation">(</span><span class="token class-name">FeignClient</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getCanonicalName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">String</span> name <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getClientName</span><span class="token punctuation">(</span>attributes<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">registerClientConfiguration</span><span class="token punctuation">(</span>registry<span class="token punctuation">,</span> name<span class="token punctuation">,</span> attributes<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;configuration&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">registerFeignClient</span><span class="token punctuation">(</span>registry<span class="token punctuation">,</span> annotationMetadata<span class="token punctuation">,</span> attributes<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

    <span class="token punctuation">}</span>
</code></pre></div><p>该方法主要是扫描类路径，对所有的FeignClient生成对应的 BeanDefinitio 。同时又调用了registerClientConfiguration 注册配置的方法，这里是第二处调用。这里主要是将扫描的目录下，每个项目的配置类加载的容器当中。调用 registerFeignClient 注册对象</p> <p><strong>（3） 注册FeignClient对象</strong></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">registerFeignClient</span><span class="token punctuation">(</span><span class="token class-name">BeanDefinitionRegistry</span> registry<span class="token punctuation">,</span> <span class="token class-name">AnnotationMetadata</span> annotationMetadata<span class="token punctuation">,</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> attributes<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	  <span class="token comment">// 1.获取类名称，也就是本例中的FeignService接口</span>
    <span class="token class-name">String</span> className <span class="token operator">=</span> annotationMetadata<span class="token punctuation">.</span><span class="token function">getClassName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 2.BeanDefinitionBuilder的主要作用就是构建一个AbstractBeanDefinition </span>
    <span class="token comment">// AbstractBeanDefinition类最终被构建成一个BeanDefinitionHolder </span>
    <span class="token comment">// 然后注册到Spring中 </span>
    <span class="token comment">// 注意：beanDefinition类为FeignClientFactoryBean，故在Spring获取类的时候实际返回 的是 </span>
    <span class="token comment">// FeignClientFactoryBean类</span>
    <span class="token class-name">BeanDefinitionBuilder</span> definition <span class="token operator">=</span> <span class="token class-name">BeanDefinitionBuilder</span><span class="token punctuation">.</span><span class="token function">genericBeanDefinition</span><span class="token punctuation">(</span><span class="token class-name">FeignClientFactoryBean</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">validate</span><span class="token punctuation">(</span>attributes<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 3.添加FeignClientFactoryBean的属性， </span>
    <span class="token comment">// 这些属性也都是我们在@FeignClient中定义的属性</span>
    definition<span class="token punctuation">.</span><span class="token function">addPropertyValue</span><span class="token punctuation">(</span><span class="token string">&quot;url&quot;</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getUrl</span><span class="token punctuation">(</span>attributes<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    definition<span class="token punctuation">.</span><span class="token function">addPropertyValue</span><span class="token punctuation">(</span><span class="token string">&quot;path&quot;</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getPath</span><span class="token punctuation">(</span>attributes<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> name <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span>attributes<span class="token punctuation">)</span><span class="token punctuation">;</span>
    definition<span class="token punctuation">.</span><span class="token function">addPropertyValue</span><span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    definition<span class="token punctuation">.</span><span class="token function">addPropertyValue</span><span class="token punctuation">(</span><span class="token string">&quot;type&quot;</span><span class="token punctuation">,</span> className<span class="token punctuation">)</span><span class="token punctuation">;</span>
    definition<span class="token punctuation">.</span><span class="token function">addPropertyValue</span><span class="token punctuation">(</span><span class="token string">&quot;decode404&quot;</span><span class="token punctuation">,</span> attributes<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;decode404&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    definition<span class="token punctuation">.</span><span class="token function">addPropertyValue</span><span class="token punctuation">(</span><span class="token string">&quot;fallback&quot;</span><span class="token punctuation">,</span> attributes<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;fallback&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    definition<span class="token punctuation">.</span><span class="token function">addPropertyValue</span><span class="token punctuation">(</span><span class="token string">&quot;fallbackFactory&quot;</span><span class="token punctuation">,</span> attributes<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;fallbackFactory&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    definition<span class="token punctuation">.</span><span class="token function">setAutowireMode</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  	<span class="token comment">// 4.设置别名 name就是我们在@FeignClient中定义的name属性</span>
    <span class="token class-name">String</span> alias <span class="token operator">=</span> name <span class="token operator">+</span> <span class="token string">&quot;FeignClient&quot;</span><span class="token punctuation">;</span>
    <span class="token class-name">AbstractBeanDefinition</span> beanDefinition <span class="token operator">=</span> definition<span class="token punctuation">.</span><span class="token function">getBeanDefinition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">boolean</span> primary <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Boolean</span><span class="token punctuation">)</span>attributes<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;primary&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    beanDefinition<span class="token punctuation">.</span><span class="token function">setPrimary</span><span class="token punctuation">(</span>primary<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> qualifier <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getQualifier</span><span class="token punctuation">(</span>attributes<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">hasText</span><span class="token punctuation">(</span>qualifier<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        alias <span class="token operator">=</span> qualifier<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
		<span class="token comment">// 5.定义BeanDefinitionHolder， </span>
  	<span class="token comment">// 在本例中 名称为FeignService，类为FeignClientFactoryBean</span>
    <span class="token class-name">BeanDefinitionHolder</span> holder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BeanDefinitionHolder</span><span class="token punctuation">(</span>beanDefinition<span class="token punctuation">,</span> className<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span>alias<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">BeanDefinitionReaderUtils</span><span class="token punctuation">.</span><span class="token function">registerBeanDefinition</span><span class="token punctuation">(</span>holder<span class="token punctuation">,</span> registry<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>通过分析可知：我们最终是向Spring中注册了一个bean，bean的名称就是类或接口的名称（也就是本例中的FeignService），bean的实现类是FeignClientFactoryBean，其属性设置就是我们在@FeignClient中定义的属性。那么下面我们在Controller中对FeignService的的引入，实际就是引入了<code>FeignClientFactoryBean</code> 类</p> <p><strong>（4） FeignClientFactoryBean类</strong></p> <p>们对@EnableFeignClients注解的源码进行了分析，了解到其主要作用就是把带有@FeignClient注解的
类或接口用FeignClientFactoryBean类注册到Spring中。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">class</span> <span class="token class-name">FeignClientFactoryBean</span> <span class="token keyword">implements</span> <span class="token class-name">FactoryBean</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">,</span> <span class="token class-name">InitializingBean</span><span class="token punctuation">,</span> 
<span class="token class-name">ApplicationContextAware</span> <span class="token punctuation">{</span> 
  <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">getObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span> 
  		<span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getTarget</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span>
  <span class="token comment">//略 </span>

<span class="token punctuation">}</span>
</code></pre></div><p>通过 FeignClientFactoryBean 类结构可以发现其实现了FactoryBean类，那么当从ApplicationContext中获取该bean的时候，实际调用的是其getObject()方法。返回调用getTarget()方法</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">T</span> <span class="token function">getTarget</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">FeignContext</span> context <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>beanFactory <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token punctuation">(</span><span class="token class-name">FeignContext</span><span class="token punctuation">)</span><span class="token keyword">this</span><span class="token punctuation">.</span>beanFactory<span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span><span class="token class-name">FeignContext</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token punctuation">(</span><span class="token class-name">FeignContext</span><span class="token punctuation">)</span><span class="token keyword">this</span><span class="token punctuation">.</span>applicationContext<span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span><span class="token class-name">FeignContext</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Builder</span> builder <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">feign</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">hasText</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>url<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>LOG<span class="token punctuation">.</span><span class="token function">isInfoEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                LOG<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;For '&quot;</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">+</span> <span class="token string">&quot;' URL not provided. Will try picking an instance via load-balancing.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">&quot;http&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>url <span class="token operator">=</span> <span class="token string">&quot;http://&quot;</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>url <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">this</span><span class="token punctuation">.</span>url <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>url <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">cleanPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">loadBalance</span><span class="token punctuation">(</span>builder<span class="token punctuation">,</span> context<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">HardCodedTarget</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>type<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>url<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">hasText</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>url<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>url<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">&quot;http&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>url <span class="token operator">=</span> <span class="token string">&quot;http://&quot;</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>url<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token class-name">String</span> url <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>url <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">cleanPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Client</span> client <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Client</span><span class="token punctuation">)</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getOptional</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> <span class="token class-name">Client</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>client <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>client <span class="token keyword">instanceof</span> <span class="token class-name">LoadBalancerFeignClient</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    client <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">LoadBalancerFeignClient</span><span class="token punctuation">)</span>client<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDelegate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span>client <span class="token keyword">instanceof</span> <span class="token class-name">FeignBlockingLoadBalancerClient</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    client <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">FeignBlockingLoadBalancerClient</span><span class="token punctuation">)</span>client<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDelegate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span>client <span class="token keyword">instanceof</span> <span class="token class-name">RetryableFeignBlockingLoadBalancerClient</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    client <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">RetryableFeignBlockingLoadBalancerClient</span><span class="token punctuation">)</span>client<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDelegate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                builder<span class="token punctuation">.</span><span class="token function">client</span><span class="token punctuation">(</span>client<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token class-name">Targeter</span> targeter <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Targeter</span><span class="token punctuation">)</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> <span class="token class-name">Targeter</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> targeter<span class="token punctuation">.</span><span class="token function">target</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> builder<span class="token punctuation">,</span> context<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">HardCodedTarget</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>type<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token punctuation">,</span> url<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre></div><ul><li><p>FeignClientFactoryBean实现了FactoryBean的getObject、getObjectType、isSingleton方法；</p> <p>实现了InitializingBean的afterPropertiesSet方法；实现了ApplicationContextAware的setApplicationContext方法</p></li> <li><p>getObject调用的是getTarget方法，它从applicationContext取出FeignContext，然后构造Feign.Builder并设置了logger、encoder、decoder、contract，之后通过confifigureFeign根据FeignClientProperties来进一步配置Feign.Builder的retryer、errorDecoder、 request.Options、requestInterceptors、queryMapEncoder、decode404</p></li> <li><p>初步配置完Feign.Builder之后再判断是否需要loadBalance，如果需要则通过loadBalance方法来设置，不需要则在Client是LoadBalancerFeignClient的时候进行unwrap</p></li></ul> <p><strong>（5） 发送请求</strong></p> <p>由上可知，FeignClientFactoryBean.getObject()具体返回的是一个代理类，具体为FeignInvocationHandler</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">FeignInvocationHandler</span> <span class="token keyword">implements</span> <span class="token class-name">InvocationHandler</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Target</span> target<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Method</span><span class="token punctuation">,</span> <span class="token class-name">MethodHandler</span><span class="token punctuation">&gt;</span></span> dispatch<span class="token punctuation">;</span>

    <span class="token class-name">FeignInvocationHandler</span><span class="token punctuation">(</span><span class="token class-name">Target</span> target<span class="token punctuation">,</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Method</span><span class="token punctuation">,</span> <span class="token class-name">MethodHandler</span><span class="token punctuation">&gt;</span></span> dispatch<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>target <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Target</span><span class="token punctuation">)</span><span class="token class-name">Util</span><span class="token punctuation">.</span><span class="token function">checkNotNull</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> <span class="token string">&quot;target&quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>dispatch <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token punctuation">)</span><span class="token class-name">Util</span><span class="token punctuation">.</span><span class="token function">checkNotNull</span><span class="token punctuation">(</span>dispatch<span class="token punctuation">,</span> <span class="token string">&quot;dispatch for %s&quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span>target<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">invoke</span><span class="token punctuation">(</span><span class="token class-name">Object</span> proxy<span class="token punctuation">,</span> <span class="token class-name">Method</span> method<span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token string">&quot;equals&quot;</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>method<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">&quot;hashCode&quot;</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>method<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">hashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token string">&quot;toString&quot;</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>method<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">MethodHandler</span><span class="token punctuation">)</span><span class="token keyword">this</span><span class="token punctuation">.</span>dispatch<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>method<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token class-name">Object</span> otherHandler <span class="token operator">=</span> args<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token class-name">Proxy</span><span class="token punctuation">.</span><span class="token function">getInvocationHandler</span><span class="token punctuation">(</span>args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>otherHandler<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IllegalArgumentException</span> var5<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">equals</span><span class="token punctuation">(</span><span class="token class-name">Object</span> obj<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>obj <span class="token keyword">instanceof</span> <span class="token class-name">ReflectiveFeign<span class="token punctuation">.</span>FeignInvocationHandler</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">ReflectiveFeign<span class="token punctuation">.</span>FeignInvocationHandler</span> other <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">ReflectiveFeign<span class="token punctuation">.</span>FeignInvocationHandler</span><span class="token punctuation">)</span>obj<span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>target<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>other<span class="token punctuation">.</span>target<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">hashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>target<span class="token punctuation">.</span><span class="token function">hashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>target<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>FeignInvocationHandler实现了InvocationHandler，是动态代理的代理类。</li> <li>当执行非Object方法时进入到this.dispatch.get(method)).invoke(args)</li> <li>dispatch是一个map集合，根据方法名称获取MethodHandler。具体实现类为SynchronousMethodHandler</li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">invoke</span><span class="token punctuation">(</span><span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> argv<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">{</span>
    <span class="token class-name">RequestTemplate</span> template <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>buildTemplateFromArgs<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>argv<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Retryer</span> retryer <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>retryer<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">executeAndDecode</span><span class="token punctuation">(</span>template<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RetryableException</span> var5<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            retryer<span class="token punctuation">.</span><span class="token function">continueOrPropagate</span><span class="token punctuation">(</span>var5<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>logLevel <span class="token operator">!=</span> <span class="token class-name">Level</span><span class="token punctuation">.</span>NONE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">logRetry</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>metadata<span class="token punctuation">.</span><span class="token function">configKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>logLevel<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token class-name">Object</span> <span class="token function">executeAndDecode</span><span class="token punctuation">(</span><span class="token class-name">RequestTemplate</span> template<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">{</span>
    <span class="token class-name">Request</span> request <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">targetRequest</span><span class="token punctuation">(</span>template<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>logLevel <span class="token operator">!=</span> <span class="token class-name">Level</span><span class="token punctuation">.</span>NONE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">logRequest</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>metadata<span class="token punctuation">.</span><span class="token function">configKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>logLevel<span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">long</span> start <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">nanoTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">Response</span> response<span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        response <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>client<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>
        response<span class="token punctuation">.</span><span class="token function">toBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">request</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> var15<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>logLevel <span class="token operator">!=</span> <span class="token class-name">Level</span><span class="token punctuation">.</span>NONE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">logIOException</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>metadata<span class="token punctuation">.</span><span class="token function">configKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>logLevel<span class="token punctuation">,</span> var15<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">elapsedTime</span><span class="token punctuation">(</span>start<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">throw</span> <span class="token class-name">FeignException</span><span class="token punctuation">.</span><span class="token function">errorExecuting</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> var15<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">long</span> elapsedTime <span class="token operator">=</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>NANOSECONDS<span class="token punctuation">.</span><span class="token function">toMillis</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">nanoTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> start<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">boolean</span> shouldClose <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

    <span class="token class-name">Object</span> var9<span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>logLevel <span class="token operator">!=</span> <span class="token class-name">Level</span><span class="token punctuation">.</span>NONE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            response <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">logAndRebufferResponse</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>metadata<span class="token punctuation">.</span><span class="token function">configKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>logLevel<span class="token punctuation">,</span> response<span class="token punctuation">,</span> elapsedTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
            response<span class="token punctuation">.</span><span class="token function">toBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">request</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Response</span><span class="token punctuation">.</span><span class="token keyword">class</span> <span class="token operator">==</span> <span class="token keyword">this</span><span class="token punctuation">.</span>metadata<span class="token punctuation">.</span><span class="token function">returnType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">Response</span> var18<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>response<span class="token punctuation">.</span><span class="token function">body</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                var18 <span class="token operator">=</span> response<span class="token punctuation">;</span>
                <span class="token keyword">return</span> var18<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>response<span class="token punctuation">.</span><span class="token function">body</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span>response<span class="token punctuation">.</span><span class="token function">body</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">8192L</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> bodyData <span class="token operator">=</span> <span class="token class-name">Util</span><span class="token punctuation">.</span><span class="token function">toByteArray</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span><span class="token function">body</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">asInputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">Response</span> var10 <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">toBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">body</span><span class="token punctuation">(</span>bodyData<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> var10<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            shouldClose <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            var18 <span class="token operator">=</span> response<span class="token punctuation">;</span>
            <span class="token keyword">return</span> var18<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>response<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;=</span> <span class="token number">200</span> <span class="token operator">&amp;&amp;</span> response<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">300</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Void</span><span class="token punctuation">.</span>TYPE <span class="token operator">==</span> <span class="token keyword">this</span><span class="token punctuation">.</span>metadata<span class="token punctuation">.</span><span class="token function">returnType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                var9 <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> var9<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            var9 <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">decode</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> var9<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>decode404 <span class="token operator">||</span> response<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">404</span> <span class="token operator">||</span> <span class="token class-name">Void</span><span class="token punctuation">.</span>TYPE <span class="token operator">==</span> <span class="token keyword">this</span><span class="token punctuation">.</span>metadata<span class="token punctuation">.</span><span class="token function">returnType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">this</span><span class="token punctuation">.</span>errorDecoder<span class="token punctuation">.</span><span class="token function">decode</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>metadata<span class="token punctuation">.</span><span class="token function">configKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        var9 <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">decode</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> var16<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>logLevel <span class="token operator">!=</span> <span class="token class-name">Level</span><span class="token punctuation">.</span>NONE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">logIOException</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>metadata<span class="token punctuation">.</span><span class="token function">configKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>logLevel<span class="token punctuation">,</span> var16<span class="token punctuation">,</span> elapsedTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">throw</span> <span class="token class-name">FeignException</span><span class="token punctuation">.</span><span class="token function">errorReading</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">,</span> var16<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>shouldClose<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">Util</span><span class="token punctuation">.</span><span class="token function">ensureClosed</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span><span class="token function">body</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> var9<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>SynchronousMethodHandler内部创建了一个RequestTemplate对象，是Feign中的请求模板对象。内部封装了一次请求的所有元数据。</li> <li>retryer中定义了用户的重试策略。</li> <li>调用executeAndDecode方法通过client完成请求处理，client的实现类是<code>LoadBalancerFeignClient</code></li></ul> <h2 id="_3-服务注册与发现总结"><a href="#_3-服务注册与发现总结" class="header-anchor">#</a> 3 服务注册与发现总结</h2> <h3 id="_3-1-组件的使用方式"><a href="#_3-1-组件的使用方式" class="header-anchor">#</a> 3.1 组件的使用方式</h3> <h4 id="_3-1-1-注册中心"><a href="#_3-1-1-注册中心" class="header-anchor">#</a> 3.1.1 注册中心</h4> <p><strong>（1）Eureka</strong></p> <ul><li>搭建注册中心
<ul><li>引入依赖 spring-cloud-starter-netflix-eureka-server</li> <li>配置EurekaServer</li> <li>通过 @EnableEurekaServer 激活Eureka Server端配置</li></ul></li> <li>服务注册
<ul><li>服务提供者引入 spring-cloud-starter-netflix-eureka-client 依赖</li> <li>通过 eureka.client.serviceUrl.defaultZone 配置注册中心地址</li></ul></li></ul> <p><strong>（2）consul</strong></p> <ul><li>搭建注册中心
<ul><li>下载安装consul</li> <li>启动consul consul agent -dev</li></ul></li> <li>服务注册
<ul><li>服务提供者引入 spring-cloud-starter-consul-discovery 依赖</li> <li>通过 spring.cloud.consul.host 和 spring.cloud.consul.port 指定Consul Server的请求地址</li></ul></li></ul> <h4 id="_3-1-2-服务调用"><a href="#_3-1-2-服务调用" class="header-anchor">#</a> 3.1.2 服务调用</h4> <p><strong>（1）Ribbon</strong></p> <ul><li>通过Ribbon结合RestTemplate方式进行服务调用只需要在声明RestTemplate的方法上添加注解<code>@LoadBalanced</code>即可</li> <li>可以通过 <code>{服务名称}.ribbon.NFLoadBalancerRuleClassName</code> 配置负载均衡策略</li></ul> <p><strong>（2）Feign</strong></p> <ul><li>服务消费者引入 spring-cloud-starter-openfeign 依赖</li> <li>通过 @FeignClient 声明一个调用远程微服务接口</li> <li>启动类上通过 @EnableFeignClients 激活Feign</li></ul> <h2 id="_4-微服务架构的高并发问题"><a href="#_4-微服务架构的高并发问题" class="header-anchor">#</a> 4 微服务架构的高并发问题</h2> <p>通过注册中心已经实现了微服务的服务注册和服务发现，并且通过Ribbon实现了负载均衡，已经借助
Feign可以优雅的进行微服务调用。那么我们编写的微服务的性能怎么样呢，是否存在问题呢？</p> <h3 id="_4-1-性能工具jmetter"><a href="#_4-1-性能工具jmetter" class="header-anchor">#</a> 4.1 性能工具Jmetter</h3> <p>Apache JMeter是Apache组织开发的基于Java的压力测试工具。用于对软件做压力测试，它最初被设计用于Web应用测试，但后来扩展到其他测试领域。 它可以用于测试静态和动态资源，例如静态文件、Java 小服务程序、CGI 脚本、Java 对象、数据库、FTP 服务器， 等等。JMeter 可以用于对服务器、网络或对象模拟巨大的负载，来自不同压力类别下测试它们的强度和分析整体性能。另外JMeter能够对应用程序做功能/回归测试，通过创建带有断言的脚本来验证你的程序返回了你期望的结果。为了最大限度的灵活性，JMeter允许使用正则表达式创建断言。</p> <h4 id="_4-1-1-安装jmetter"><a href="#_4-1-1-安装jmetter" class="header-anchor">#</a> 4.1.1 安装Jmetter</h4> <p>Jmetter安装十分简单，使用资料中的 apache-jmeter-2.13.zip 完整压缩包，解压找到安装目录下
bin/jmeter.bat 已管理员身份启动即可</p> <img src="/assets/img/image-20220305222907285.4b17c055.png" alt="image-20220305222907285" style="zoom:67%;"> <h4 id="_4-1-2-配置jmetter"><a href="#_4-1-2-配置jmetter" class="header-anchor">#</a> 4.1.2 配置Jmetter</h4> <p><strong>（1）创建新的测试计划</strong></p> <img src="/assets/img/image-20220305223010206.5126aa49.png" alt="image-20220305223010206" style="zoom:67%;"> <p><strong>（2）测试计划下创建发起请求的线程组</strong></p> <img src="/assets/img/image-20220305223033114.65da4298.png" alt="image-20220305223033114" style="zoom:67%;"> <ul><li>可以配置请求的线程数</li> <li>以及每个请求发送的请求次数</li></ul> <p><strong>（3）创建http请求模板</strong></p> <img src="/assets/img/image-20220305223104622.a4e94b92.png" alt="image-20220305223104622" style="zoom:67%;"> <p><strong>（4）配置测试的接口信息</strong></p> <img src="/assets/img/image-20220305223129169.79674079.png" alt="image-20220305223129169" style="zoom:67%;"> <h3 id="_4-2-系统负载过高存在的问题"><a href="#_4-2-系统负载过高存在的问题" class="header-anchor">#</a> 4.2 系统负载过高存在的问题</h3> <h4 id="_4-2-1-问题分析"><a href="#_4-2-1-问题分析" class="header-anchor">#</a> 4.2.1 问题分析</h4> <p>在微服务架构中，我们将业务拆分成一个个的服务，服务与服务之间可以相互调用，由于网络原因或者自身的原因，服务并不能保证服务的100%可用，如果单个服务出现问题，调用这个服务就会出现网络延迟，此时若有大量的网络涌入，会形成任务累计，导致服务瘫痪。
在SpringBoot程序中，默认使用内置tomcat作为web服务器。单tomcat支持最大的并发请求是有限
的，如果某一接口阻塞，待执行的任务积压越来越多，那么势必会影响其他接口的调用。</p> <h4 id="_4-2-2-线程池的形式实现服务隔离"><a href="#_4-2-2-线程池的形式实现服务隔离" class="header-anchor">#</a> 4.2.2 线程池的形式实现服务隔离</h4> <p><strong>（1） 配置坐标</strong></p> <p>为了方便实现线以线程池的形式完成资源隔离，需要引入如下依赖</p> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span> 
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.netflix.hystrix<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span> 
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>hystrix-metrics-event-stream<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span> 
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.5.12<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span> 
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span> 
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span> 
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.netflix.hystrix<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span> 
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>hystrix-javanica<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span> 
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.5.12<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span> 
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span> 
</code></pre></div><p><strong>（2） 配置线程池</strong></p> <p>配置HystrixCommand接口的实现类，再实现类中可以对线程池进行配置</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderCommand</span> <span class="token keyword">extends</span> <span class="token class-name">HystrixCommand</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token class-name">RestTemplate</span> restTemplate<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Long</span> id<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">OrderCommand</span><span class="token punctuation">(</span><span class="token class-name">RestTemplate</span> restTemplate<span class="token punctuation">,</span> <span class="token class-name">Long</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token function">setter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>restTemplate <span class="token operator">=</span> restTemplate<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>id <span class="token operator">=</span> id<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">Setter</span> <span class="token function">setter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 服务分组</span>
        <span class="token class-name">HystrixCommandGroupKey</span> groupKey <span class="token operator">=</span> <span class="token class-name">HystrixCommandGroupKey<span class="token punctuation">.</span>Factory</span><span class="token punctuation">.</span><span class="token function">asKey</span><span class="token punctuation">(</span><span class="token string">&quot;order_product&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 服务标识</span>
        <span class="token class-name">HystrixCommandKey</span> commandKey <span class="token operator">=</span> <span class="token class-name">HystrixCommandKey<span class="token punctuation">.</span>Factory</span><span class="token punctuation">.</span><span class="token function">asKey</span><span class="token punctuation">(</span><span class="token string">&quot;product&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 线程池名称</span>
        <span class="token class-name">HystrixThreadPoolKey</span> threadPoolKey <span class="token operator">=</span> <span class="token class-name">HystrixThreadPoolKey<span class="token punctuation">.</span>Factory</span><span class="token punctuation">.</span><span class="token function">asKey</span><span class="token punctuation">(</span><span class="token string">&quot;order_product_pool&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">/**
         * 线程池配置 * withCoreSize : 线程池大小为10
         * * withKeepAliveTimeMinutes: 线程存活时间15秒
         * * withQueueSizeRejectionThreshold :队列等待的阈值为100,超过100执行拒绝 策略
         */</span>
        <span class="token class-name">HystrixThreadPoolProperties<span class="token punctuation">.</span>Setter</span> threadPoolProperties <span class="token operator">=</span> <span class="token class-name">HystrixThreadPoolProperties<span class="token punctuation">.</span>Setter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">withCoreSize</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">withKeepAliveTimeMinutes</span><span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">withQueueSizeRejectionThreshold</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 命令属性配置Hystrix 开启超时</span>
        <span class="token class-name">HystrixCommandProperties<span class="token punctuation">.</span>Setter</span> commandProperties <span class="token operator">=</span> <span class="token class-name">HystrixCommandProperties<span class="token punctuation">.</span>Setter</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token comment">// 采用线程池方式实现服务隔离</span>
                <span class="token punctuation">.</span><span class="token function">withExecutionIsolationStrategy</span><span class="token punctuation">(</span><span class="token class-name">HystrixCommandProperties<span class="token punctuation">.</span>ExecutionIsolationStrategy</span><span class="token punctuation">.</span>THREAD<span class="token punctuation">)</span>
                <span class="token comment">// 禁止</span>
                <span class="token punctuation">.</span><span class="token function">withExecutionTimeoutEnabled</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">HystrixCommand<span class="token punctuation">.</span>Setter</span><span class="token punctuation">.</span><span class="token function">withGroupKey</span><span class="token punctuation">(</span>groupKey<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">andCommandKey</span><span class="token punctuation">(</span>commandKey<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">andThreadPoolKey</span><span class="token punctuation">(</span>threadPoolKey<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">andThreadPoolPropertiesDefaults</span><span class="token punctuation">(</span>threadPoolProperties<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">andCommandPropertiesDefaults</span><span class="token punctuation">(</span>commandProperties<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token class-name">String</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> restTemplate<span class="token punctuation">.</span><span class="token function">getForObject</span><span class="token punctuation">(</span><span class="token string">&quot;http://shop-service- product/product/&quot;</span> <span class="token operator">+</span> id<span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token class-name">String</span> <span class="token function">getFallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token string">&quot;熔断降级&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong>（3） 配置调用</strong></p> <p>修改 <code>OrderController</code> ，使用自定义的OrderCommand完成调用</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Autowired</span> <span class="token keyword">private</span> <span class="token class-name">RestTemplate</span> restTemplate<span class="token punctuation">;</span> 
<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/buy/{id}&quot;</span><span class="token punctuation">)</span> 
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">order</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span> <span class="token class-name">Long</span> id<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ExecutionException</span><span class="token punctuation">,</span> 
<span class="token class-name">InterruptedException</span><span class="token punctuation">,</span> <span class="token class-name">TimeoutException</span> <span class="token punctuation">{</span> 
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">OrderCommand</span><span class="token punctuation">(</span>restTemplate<span class="token punctuation">,</span>id<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token punctuation">}</span>
</code></pre></div><h2 id="_5-服务熔断hystrix入门"><a href="#_5-服务熔断hystrix入门" class="header-anchor">#</a> 5 服务熔断Hystrix入门</h2> <h3 id="_5-1-服务容错的核心知识"><a href="#_5-1-服务容错的核心知识" class="header-anchor">#</a> 5.1 服务容错的核心知识</h3> <h4 id="_5-1-1-雪崩效应"><a href="#_5-1-1-雪崩效应" class="header-anchor">#</a> 5.1.1 雪崩效应</h4> <p>在微服务架构中，一个请求需要调用多个服务是非常常见的。如客户端访问A服务，而A服务需要调用B
服务，B服务需要调用C服务，由于网络原因或者自身的原因，如果B服务或者C服务不能及时响应，A服
务将处于阻塞状态，直到B服务C服务响应。此时若有大量的请求涌入，容器的线程资源会被消耗完毕，
导致服务瘫痪。服务与服务之间的依赖性，故障会传播，造成连锁反应，会对整个微服务系统造成灾难
性的严重后果，这就是服务故障的“雪崩”效应。</p> <p><img src="/assets/img/image-20220305225811315.ca390831.png" alt="image-20220305225811315"></p> <p>雪崩是系统中的蝴蝶效应导致其发生的原因多种多样，有不合理的容量设计，或者是高并发下某一个方
法响应变慢，亦或是某台机器的资源耗尽。从源头上我们无法完全杜绝雪崩源头的发生，但是雪崩的根
本原因来源于服务之间的强依赖，所以我们可以提前评估，做好<strong>熔断，隔离，限流</strong>。</p> <h4 id="_5-1-2-服务隔离"><a href="#_5-1-2-服务隔离" class="header-anchor">#</a> 5.1.2 服务隔离</h4> <p>顾名思义，它是指将系统按照一定的原则划分为若干个服务模块，各个模块之间相对独立，无强依赖。
当有故障发生时，能将问题和影响隔离在某个模块内部，而不扩散风险，不波及其它模块，不影响整体
的系统服务。</p> <h4 id="_5-1-3-熔断降级"><a href="#_5-1-3-熔断降级" class="header-anchor">#</a> 5.1.3 熔断降级</h4> <p>熔断这一概念来源于电子工程中的断路器（Circuit Breaker）。在互联网系统中，当下游服务因访问压
力过大而响应变慢或失败，上游服务为了保护系统整体的可用性，可以暂时切断对下游服务的调用。这
种牺牲局部，保全整体的措施就叫做熔断。</p> <img src="/assets/img/image-20220305225852826.e5055566.png" alt="image-20220305225852826" style="zoom:67%;"> <p>所谓降级，就是当某个服务熔断之后，服务器将不再被调用，此时客户端可以自己准备一个本地的
fallback回调，返回一个缺省值。 也可以理解为兜底</p> <h4 id="_5-1-4-服务限流"><a href="#_5-1-4-服务限流" class="header-anchor">#</a> 5.1.4 服务限流</h4> <p>限流可以认为服务降级的一种，限流就是限制系统的输入和输出流量已达到保护系统的目的。一般来说
系统的吞吐量是可以被测算的，为了保证系统的稳固运行，一旦达到的需要限制的阈值，就需要限制流
量并采取少量措施以完成限制流量的目的。比方：推迟解决，拒绝解决，或者者部分拒绝解决等等。</p> <h3 id="_5-2-hystrix介绍"><a href="#_5-2-hystrix介绍" class="header-anchor">#</a> 5.2 Hystrix介绍</h3> <p>Hystrix是由Netflix开源的一个延迟和容错库，用于隔离访问远程系统、服务或者第三方库，防止级联失
败，从而提升系统的可用性与容错性。Hystrix主要通过以下几点实现延迟和容错。</p> <ul><li>包裹请求：使用HystrixCommand包裹对依赖的调用逻辑，每个命令在独立线程中执行。这使用了设计模式中的“命令模式”。</li> <li>跳闸机制：当某服务的错误率超过一定的阈值时，Hystrix可以自动或手动跳闸，停止请求该服务一段时间。</li> <li>资源隔离：Hystrix为每个依赖都维护了一个小型的线程池（或者信号量）。如果该线程池已满，发往该依赖的请求就被立即拒绝，而不是排队等待，从而加速失败判定。</li> <li>监控：Hystrix可以近乎实时地监控运行指标和配置的变化，例如成功、失败、超时、以及被拒绝的请求等。</li> <li>回退机制：当请求失败、超时、被拒绝，或当断路器打开时，执行回退逻辑。回退逻辑由开发人员自行提供，例如返回一个缺省值。</li> <li>自我修复：断路器打开一段时间后，会自动进入“半开”状态。</li></ul> <h3 id="_5-3-rest实现服务熔断"><a href="#_5-3-rest实现服务熔断" class="header-anchor">#</a> 5.3 Rest实现服务熔断</h3> <p><strong>（1）复制 shop_service_order 项目并命名为 shop_service_order_rest_hystrix</strong></p> <p>略</p> <p><strong>（2）配置依赖</strong></p> <p>在 shop_service_order_rest_hystrix 工程中添加Hystrix的相关依赖</p> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span> 
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span> 
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-netflix-hystrix<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span> 
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span> 
</code></pre></div><p><strong>（3）开启熔断</strong></p> <p>在启动类 <code>OrderApplication</code> 中添加 <code>@EnableCircuitBreaker</code> 注解开启对熔断器的支持。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@EntityScan</span><span class="token punctuation">(</span><span class="token string">&quot;cn.itcast.entity&quot;</span><span class="token punctuation">)</span> 
<span class="token comment">//@EnableCircuitBreaker //开启熔断器 </span>
<span class="token comment">//@SpringBootApplication</span>
<span class="token annotation punctuation">@SpringCloudApplication</span> 
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderApplication</span> <span class="token punctuation">{</span> 
  <span class="token comment">//创建RestTemplate对象 </span>
  <span class="token annotation punctuation">@Bean</span> 
  <span class="token annotation punctuation">@LoadBalanced</span> 
  <span class="token keyword">public</span> <span class="token class-name">RestTemplate</span> <span class="token function">restTemplate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">RestTemplate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span>
  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span> 
    <span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">OrderApplication</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span> 
<span class="token punctuation">}</span>
</code></pre></div><p>可以看到，我们类上的注解越来越多，在微服务中，经常会引入上面的三个注解，于是Spring就提供了一个组合注解：@SpringCloudApplication</p> <p><strong>（4）配置熔断降级业务逻辑</strong></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@RestController</span> 
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/order&quot;</span><span class="token punctuation">)</span> 
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderController</span> <span class="token punctuation">{</span> 
<span class="token annotation punctuation">@Autowired</span> 
<span class="token keyword">private</span> <span class="token class-name">RestTemplate</span> restTemplate<span class="token punctuation">;</span> 

    <span class="token comment">//下订单 </span>
    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/product/{id}&quot;</span><span class="token punctuation">)</span> 
    <span class="token annotation punctuation">@HystrixCommand</span><span class="token punctuation">(</span>fallbackMethod <span class="token operator">=</span> <span class="token string">&quot;orderFallBack&quot;</span><span class="token punctuation">)</span> 
    <span class="token keyword">public</span> <span class="token class-name">Product</span> <span class="token function">findProduct</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span> <span class="token class-name">Long</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span> 
    		<span class="token keyword">return</span> restTemplate<span class="token punctuation">.</span><span class="token function">getForObject</span><span class="token punctuation">(</span><span class="token string">&quot;http://shop-service-product/product/1&quot;</span><span class="token punctuation">,</span> <span class="token class-name">Product</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token punctuation">}</span>

    <span class="token comment">//降级方法 </span>
    <span class="token keyword">public</span> <span class="token class-name">Product</span> <span class="token function">orderFallBack</span><span class="token punctuation">(</span><span class="token class-name">Long</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span> 
        <span class="token class-name">Product</span> product <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Product</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
        product<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1l</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
        product<span class="token punctuation">.</span><span class="token function">setProductName</span><span class="token punctuation">(</span><span class="token string">&quot;熔断:触发降级方法&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
        <span class="token keyword">return</span> product<span class="token punctuation">;</span> 
    <span class="token punctuation">}</span> 
<span class="token punctuation">}</span>
</code></pre></div><p>有代码可知，为 findProduct 方法编写一个回退方法findProductFallBack，该方法与 findProduct 方
法具有相同的参数与返回值类型，该方法返回一个默认的错误信息。在 Product 方法上，使用注解@HystrixCommand的fallbackMethod属性，指定熔断触发的降级方法是 findProductFallBack 。</p> <ul><li>因为熔断的降级逻辑方法必须跟正常逻辑方法保证：相同的参数列表和返回值声明。</li> <li>在 findProduct 方法上 HystrixCommand(fallbackMethod = &quot;findProductFallBack&quot;) 用来声明一个降级逻辑的方法</li></ul> <p>当 <code>shop-service-product</code> 微服务正常时，浏览器访问 http://localhost:9001/order/product/1</p> <p><img src="/assets/img/image-20220305230609754.9b3ee50d.png" alt="image-20220305230609754"></p> <p>可以正常调用服务提供者获取数据。当将商品微服务停止时继续访问</p> <p><img src="/assets/img/image-20220305230621416.b52922ae.png" alt="image-20220305230621416"></p> <p>此时Hystrix配置已经生效进入熔断降级方法。</p> <p><strong>默认的Fallback</strong></p> <p>我们刚才把fallback写在了某个业务方法上，如果这样的方法很多，那岂不是要写很多。所以我们可以
把Fallback配置加在类上，实现默认fallback：</p> <p><img src="/assets/img/image-20220305230647488.61199362.png" alt="image-20220305230647488"></p> <p><strong>超时设置</strong></p> <p>在之前的案例中，请求在超过1秒后都会返回错误信息，这是因为Hystix的默认超时时长为1，我们可以
通过配置修改这个值：</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">hystrix</span><span class="token punctuation">:</span> 
	<span class="token key atrule">command</span><span class="token punctuation">:</span> 
		<span class="token key atrule">default</span><span class="token punctuation">:</span> 
			<span class="token key atrule">execution</span><span class="token punctuation">:</span> 
				<span class="token key atrule">isolation</span><span class="token punctuation">:</span> 
					<span class="token key atrule">thread</span><span class="token punctuation">:</span> 
						<span class="token key atrule">timeoutInMilliseconds</span><span class="token punctuation">:</span> <span class="token number">2000</span>
</code></pre></div><h3 id="_5-4-feign实现服务熔断"><a href="#_5-4-feign实现服务熔断" class="header-anchor">#</a> 5.4 Feign实现服务熔断</h3> <p>SpringCloud Fegin默认已为Feign整合了hystrix，所以添加Feign依赖后就不用在添加hystrix，那么怎
么才能让Feign的熔断机制生效呢，只要按以下步骤开发：</p> <p><strong>（1）复制 shop_service_order 项目并命名为 shop_service_order_feign_hystrix</strong></p> <p>略</p> <p><strong>（2）修改application.yml在Fegin中开启hystrix</strong>
在Feign中已经内置了hystrix，但是默认是关闭的需要在工程的 application.yml 中开启对hystrix的支持</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">feign</span><span class="token punctuation">:</span> 
	<span class="token key atrule">hystrix</span><span class="token punctuation">:</span> <span class="token comment">#在feign中开启hystrix熔断</span>
		 <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
</code></pre></div><p><strong>（3）配置FeignClient接口的实现类</strong></p> <p>基于Feign实现熔断降级，那么降级方法需要配置到FeignClient接口的实现类中</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/**
* 实现自定义的ProductFeginClient接口 
* 在接口实现类中编写熔断降级方法 
*/</span> 
<span class="token annotation punctuation">@Component</span> <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ProductFeginClientCallBack</span> <span class="token keyword">implements</span> <span class="token class-name">ProductFeginClient</span> <span class="token punctuation">{</span> 
  <span class="token comment">/*** 降级方法 */</span> 
  <span class="token keyword">public</span> <span class="token class-name">Product</span> <span class="token function">findById</span><span class="token punctuation">(</span><span class="token class-name">Long</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span> 
    <span class="token class-name">Product</span> product <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Product</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> product<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1l</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
    product<span class="token punctuation">.</span><span class="token function">setProductName</span><span class="token punctuation">(</span><span class="token string">&quot;熔断:触发降级方法&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token keyword">return</span> product<span class="token punctuation">;</span> 
  <span class="token punctuation">}</span> 
<span class="token punctuation">}</span>
</code></pre></div><p><strong>（4）修改FeignClient添加hystrix熔断</strong></p> <p>在@FeignClient注解中添加降级方法</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">//指定需要调用的微服务名称 </span>
<span class="token annotation punctuation">@FeignClient</span><span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">&quot;shop-service-product&quot;</span><span class="token punctuation">,</span>fallback <span class="token operator">=</span> <span class="token class-name">ProductFeginClientCallBack</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span> 
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">ProductFeginClient</span> <span class="token punctuation">{</span> 
  <span class="token comment">//调用的请求路径 @RequestMapping(value = &quot;/product/{id}&quot;,method = RequestMethod.GET) </span>
  <span class="token keyword">public</span> <span class="token class-name">Product</span> <span class="token function">findById</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Long</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token punctuation">}</span>
</code></pre></div><p>@FeignClient注解中以fallback声明降级方法</p> <h2 id="_6-服务熔断hystrix高级"><a href="#_6-服务熔断hystrix高级" class="header-anchor">#</a> 6 服务熔断Hystrix高级</h2> <p>我们知道，当请求失败，被拒绝，超时的时候，都会进入到降级方法中。但进入降级方法并不意味着断
路器已经被打开。那么如何才能了解断路器中的状态呢？</p> <h3 id="_6-1-hystrix的监控平台"><a href="#_6-1-hystrix的监控平台" class="header-anchor">#</a> 6.1 Hystrix的监控平台</h3> <p>除了实现容错功能，Hystrix还提供了近乎实时的监控，HystrixCommand和
HystrixObservableCommand在执行时，会生成执行结果和运行指标。比如每秒的请求数量，成功数
量等。这些状态会暴露在Actuator提供的/health端点中。只需为项目添加 spring-boot-actuator 依
赖，重启项目，访问http://localhost:9001/actuator/hystrix.stream ,即可看到实时的监控数据。</p> <h4 id="_6-1-1-搭建hystrix-dashboard监控"><a href="#_6-1-1-搭建hystrix-dashboard监控" class="header-anchor">#</a> 6.1.1 搭建Hystrix DashBoard监控</h4> <p>刚刚讨论了Hystrix的监控，但访问/hystrix.stream接口获取的都是已文字形式展示的信息。很难通过文
字直观的展示系统的运行状态，所以Hystrix官方还提供了基于图形化的DashBoard（仪表板）监控平
台。Hystrix仪表板可以显示每个断路器（被@HystrixCommand注解的方法）的状态。
<strong>（1）导入依赖</strong></p> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span> 
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span> 
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-actuator<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span> 
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span> 
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span> 
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span> 
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-netflix-hystrix<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span> 
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span> 
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span> 
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span> 
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-netflix-hystrix-dashboard<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span> 
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span> 
</code></pre></div><p><strong>（2）添加EnableHystrixDashboard 注解</strong></p> <p>在启动类使用@EnableHystrixDashboard注解激活仪表盘项目</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@EnableHystrixDashboard</span> 
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderApplication</span> <span class="token punctuation">{</span> 
  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span> 
    <span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">OrderApplication</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span> 
<span class="token punctuation">}</span> 
</code></pre></div><p><strong>（3）访问测试</strong></p> <img src="/assets/img/image-20220305231322426.968894b7.png" alt="image-20220305231322426" style="zoom:67%;"> <p>输入监控断点展示监控的详细数据</p> <p><img src="/assets/img/image-20220305231334959.c7dc3aaa.png" alt="image-20220305231334959"></p> <h4 id="_6-1-2断路器聚合监控turbine"><a href="#_6-1-2断路器聚合监控turbine" class="header-anchor">#</a> 6.1.2断路器聚合监控Turbine</h4> <p>在微服务架构体系中，每个服务都需要配置Hystrix DashBoard监控。如果每次只能查看单个实例的监
控数据，就需要不断切换监控地址，这显然很不方便。要想看这个系统的Hystrix Dashboard数据就需
要用到Hystrix Turbine。Turbine是一个聚合Hystrix 监控数据的工具，他可以将所有相关微服务的
Hystrix 监控数据聚合到一起，方便使用。引入Turbine后，整个监控系统架构如下：</p> <img src="/assets/img/image-20220305231406650.fec6aa7a.png" alt="image-20220305231406650" style="zoom:67%;"> <p><strong>（1） 搭建TurbineServer</strong></p> <p>创建工程 shop_hystrix_turbine 引入相关坐标</p> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span> 
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span> 
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-netflix-turbine<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span> 
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span> 
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span> 
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-netflix-hystrix<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-netflix-hystrix-dashboard<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p><strong>（2） 配置多个微服务的hystrix监控</strong></p> <p>在application.yml的配置文件中开启turbine并进行相关配置</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">server</span><span class="token punctuation">:</span>
	<span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8031</span> 
<span class="token key atrule">spring</span><span class="token punctuation">:</span> 
	<span class="token key atrule">application</span><span class="token punctuation">:</span> 
		<span class="token key atrule">name</span><span class="token punctuation">:</span> microservice<span class="token punctuation">-</span>hystrix<span class="token punctuation">-</span>turbine 
<span class="token key atrule">eureka</span><span class="token punctuation">:</span> 
	<span class="token key atrule">client</span><span class="token punctuation">:</span> 
		<span class="token key atrule">service-url</span><span class="token punctuation">:</span> 
			<span class="token key atrule">defaultZone</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//localhost<span class="token punctuation">:</span>8761/eureka/ 
		<span class="token key atrule">instance</span><span class="token punctuation">:</span> 
			<span class="token key atrule">prefer-ip-address</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
<span class="token key atrule">turbine</span><span class="token punctuation">:</span> <span class="token comment"># 要监控的微服务列表，多个用,分隔 </span>
	<span class="token key atrule">appConfig</span><span class="token punctuation">:</span> shop<span class="token punctuation">-</span>service<span class="token punctuation">-</span>order 
	<span class="token key atrule">clusterNameExpression</span><span class="token punctuation">:</span> <span class="token string">&quot;'default'&quot;</span>
</code></pre></div><ul><li>eureka相关配置 ： 指定注册中心地址</li> <li>turbine相关配置：指定需要监控的微服务列表</li></ul> <p>turbine会自动的从注册中心中获取需要监控的微服务，并聚合所有微服务中的 /hystrix.stream 数据</p> <p><strong>（3）配置启动类</strong></p> <p>作为一个独立的监控项目，需要配置启动类，开启HystrixDashboard监控平台，并激活Turbine</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@SpringBootApplication</span> 
<span class="token annotation punctuation">@EnableTurbine</span> 
<span class="token annotation punctuation">@EnableHystrixDashboard</span> 
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TurbineServerApplication</span> <span class="token punctuation">{</span> 
  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span> 
    <span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">TurbineServerApplication</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span> 
<span class="token punctuation">}</span>
</code></pre></div><p><strong>（4） 测试</strong></p> <p>浏览器访问 http://localhost:8031/hystrix 展示HystrixDashboard。并在url位置输入 http://localhost:8031/turbine.stream，动态根据turbine.stream数据展示多个微服务的监控数据</p> <p><img src="/assets/img/image-20220305231809933.e3243cea.png" alt="image-20220305231809933"></p> <h3 id="_6-2-熔断器的状态"><a href="#_6-2-熔断器的状态" class="header-anchor">#</a> <strong>6.2 熔断器的状态</strong></h3> <p>熔断器有三个状态 CLOSED 、 OPEN 、 HALF_OPEN 熔断器默认关闭状态，当触发熔断后状态变更为
OPEN ,在等待到指定的时间，Hystrix会放请求检测服务是否开启，这期间熔断器会变为 HALF_OPEN 半
开启状态，熔断探测服务可用则继续变更为 CLOSED 关闭熔断器。</p> <img src="/assets/img/image-20220305231838365.65a63696.png" alt="image-20220305231838365" style="zoom:67%;"> <ul><li>Closed：关闭状态（断路器关闭），所有请求都正常访问。代理类维护了最近调用失败的次数，如果某次调用失败，则使失败次数加1。如果最近失败次数超过了在给定时间内允许失败的阈值，则代理类切换到断开(Open)状态。此时代理开启了一个超时时钟，当该时钟超过了该时间，则切换到半断开（Half-Open）状态。该超时时间的设定是给了系统一次机会来修正导致调用失败的错误。</li> <li>Open：打开状态（断路器打开），所有请求都会被降级。Hystix会对请求情况计数，当一定时间内失败请求百分比达到阈值，则触发熔断，断路器会完全关闭。默认失败比例的阈值是50%，请求次数最少不低于20次。</li> <li>Half Open：半开状态，open状态不是永久的，打开后会进入休眠时间（默认是5S）。随后断路器会自动进入半开状态。此时会释放1次请求通过，若这个请求是健康的，则会关闭断路器，否则继续保持打开，再次进行5秒休眠计时。</li></ul> <p>为了能够精确控制请求的成功或失败，我们在 shop_service_product 的调用业务中加入一段逻辑：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/{id}&quot;</span><span class="token punctuation">)</span> 
<span class="token keyword">public</span> <span class="token class-name">Product</span> <span class="token function">findById</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span> <span class="token class-name">Long</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span> 
  <span class="token keyword">if</span><span class="token punctuation">(</span>id <span class="token operator">!=</span><span class="token number">1</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span> 
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;太忙了&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> productService<span class="token punctuation">.</span><span class="token function">findById</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token punctuation">}</span>
</code></pre></div><p>这样如果参数是id为1，一定失败，其它情况都成功。
我们准备两个请求窗口：</p> <ul><li>一个请求：http://localhost:8080/consumer/1，注定失败</li> <li>一个请求：http://localhost:8080/consumer/2，肯定成功</li></ul> <p>熔断器的默认触发阈值是20次请求，不好触发。休眠时间时5秒，时间太短，不易观察，为了测试方
便，我们可以通过配置修改熔断策略：</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code>circuitBreaker.requestVolumeThreshold=5 
circuitBreaker.sleepWindowInMilliseconds=10000 
circuitBreaker.errorThresholdPercentage=50
</code></pre></div><p>解读：</p> <ul><li>requestVolumeThreshold：触发熔断的最小请求次数，默认20</li> <li>errorThresholdPercentage：触发熔断的失败请求最小占比，默认50%</li> <li>sleepWindowInMilliseconds：熔断多少秒后去尝试请求</li></ul> <p>当我们疯狂访问id为1的请求时（超过10次），就会触发熔断。断路器会端口，一切请求都会被降级处理。
此时你访问id为2的请求，会发现返回的也是失败，而且失败时间很短，只有20毫秒左右：</p> <p><img src="/assets/img/image-20220305232405066.3f6e9f1d.png" alt="image-20220305232405066"></p> <h3 id="_6-3-熔断器的隔离策略"><a href="#_6-3-熔断器的隔离策略" class="header-anchor">#</a> 6.3 熔断器的隔离策略</h3> <p>微服务使用Hystrix熔断器实现了服务的自动降级，让微服务具备自我保护的能力，提升了系统的稳定
性，也较好的解决雪崩效应。<strong>其使用方式目前支持两种策略：</strong></p> <ul><li><strong>线程池隔离策略</strong>：使用一个线程池来存储当前的请求，线程池对请求作处理，设置任务返回处理超时时间，堆积的请求堆积入线程池队列。这种方式需要为每个依赖的服务申请线程池，有一定的资源消耗，好处是可以应对突发流量（流量洪峰来临时，处理不完可将数据存储到线程池队里慢慢处理）</li> <li><strong>信号量隔离策略</strong>：使用一个原子计数器（或信号量）来记录当前有多少个线程在运行，请求来先判断计数器的数值，若超过设置的最大线程个数则丢弃改类型的新请求，若不超过则执行计数操作请求来计数器+1，请求返回计数器-1。这种方式是严格的控制线程且立即返回模式，无法应对突发流量（流量洪峰来临时，处理的线程超过数量，其他的请求会直接返回，不继续去请求依赖的服务）</li></ul> <p><strong>线程池和型号量两种策略功能支持对比如下：</strong></p> <img src="/assets/img/image-20220305232602591.a281d308.png" alt="image-20220305232602591" style="zoom:50%;"> <ul><li><code>hystrix.command.default.execution.isolation.strategy</code> : 配置隔离策略
<ul><li><code>ExecutionIsolationStrategy.SEMAPHORE</code> 信号量隔离</li> <li><code>ExecutionIsolationStrategy.THREAD</code> 线程池隔离</li></ul></li> <li><code>hystrix.command.default.execution.isolation.maxConcurrentRequests</code> : 最大信号量上限</li></ul> <h3 id="_6-4-hystrix的核心源码"><a href="#_6-4-hystrix的核心源码" class="header-anchor">#</a> 6.4 Hystrix的核心源码</h3> <p>Hystrix 底层基于 RxJava，RxJava 是响应式编程开发库，因此Hystrix的整个实现策略简单说即：把一
个HystrixCommand封装成一个Observable（待观察者），针对自身要实现的核心功能，对Observable进行各种装饰，并在订阅各步装饰的Observable，以便在指定事件到达时，添加自己的业务。</p> <img src="/assets/img/image-20220305232712233.af595384.png" alt="image-20220305232712233" style="zoom:67%;"> <p><strong>Hystrix主要有4种调用方式：</strong></p> <ul><li>toObservable() 方法 ：未做订阅，只是返回一个Observable 。</li> <li>observe() 方法 ：调用 #toObservable() 方法，并向 Observable 注册 rx.subjects.ReplaySubject发起订阅。</li> <li>queue() 方法 ：调用 #toObservable() 方法的基础上，调用：Observable#toBlocking() 和BlockingObservable#toFuture() 返回 Future 对象
execute() 方法 ：调用 #queue() 方法的基础上，调用 Future#get() 方法，同步返回 #run() 的执行结果。</li></ul> <p><strong>主要的执行逻辑：</strong></p> <ol><li>每次调用创建一个新的HystrixCommand,把依赖调用封装在run()方法中.</li> <li>执行execute()/queue做同步或异步调用.</li> <li>判断熔断器(circuit-breaker)是否打开,如果打开跳到步骤8,进行降级策略,如果关闭进入步骤.</li> <li>判断线程池/队列/信号量是否跑满，如果跑满进入降级步骤8,否则继续后续步骤.</li> <li>调用HystrixCommand的run方法.运行依赖逻辑，依赖逻辑调用超时,进入步骤8.</li> <li>判断逻辑是否调用成功。返回成功调用结果；调用出错，进入步骤8.</li> <li>计算熔断器状态,所有的运行状态(成功, 失败, 拒绝,超时)上报给熔断器，用于统计从而判断熔断器状态.</li> <li>getFallback()降级逻辑。以下四种情况将触发getFallback调用：
<ol><li>run()方法抛出非HystrixBadRequestException异常。</li> <li>run()方法调用超时</li> <li>熔断器开启拦截调用</li> <li>线程池/队列/信号量是否跑满</li> <li>没有实现getFallback的Command将直接抛出异常，fallback降级逻辑调用成功直接返回，降级逻辑调用失败抛出异常.</li></ol></li> <li>返回执行成功结果</li></ol> <h4 id="_6-4-1-hystrixcommand注解"><a href="#_6-4-1-hystrixcommand注解" class="header-anchor">#</a> 6.4.1 HystrixCommand注解</h4> <p>在实际应用过程通过@HystrixCommand注解能够更加简单快速的实现Hystrix的应用，那么我们就直接
从@HystrixCommand注解入手，其中包含了诸多参数配置，如执行隔离策略，线程池定义等，这些参
数就不一一说明了，我们来看看其是如何实现服务降级的。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token annotation punctuation">@interface</span> <span class="token class-name">HystrixCommand</span> <span class="token punctuation">{</span> 
  <span class="token class-name">String</span> <span class="token function">groupKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span> 
  <span class="token class-name">String</span> <span class="token function">commandKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span> 
  <span class="token class-name">String</span> <span class="token function">threadPoolKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span> 
  <span class="token class-name">String</span> <span class="token function">fallbackMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span> 
  <span class="token class-name">HystrixProperty</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">commandProperties</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span> 
  <span class="token class-name">HystrixProperty</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">threadPoolProperties</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span> 
  <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">Throwable</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">ignoreExceptions</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span> 
  <span class="token class-name">ObservableExecutionMode</span> <span class="token function">observableExecutionMode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token class-name">ObservableExecutionMode</span><span class="token punctuation">.</span>EAGER<span class="token punctuation">;</span> 
  <span class="token class-name">HystrixException</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">raiseHystrixExceptions</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span> 
  <span class="token class-name">String</span> <span class="token function">defaultFallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span> 
<span class="token punctuation">}</span>
</code></pre></div><p>其定义了fallbackMethod方法名，正如其名，其提供了一个定义回退方法映射，在异常触发时此方法名对应的method将被触发执行，从而实现服务的降级。那么@HystrixCommand注解又是如何被执行的呢，我们找到 HystrixCommandAspect.java ，其切点定义如下</p> <p>@Aspect public class HystrixCommandAspect { private static final Map&lt;HystrixCommandAspect.HystrixPointcutType, HystrixCommandAspect.MetaHolderFactory&gt; META_HOLDER_FACTORY_MAP; public HystrixCommandAspect() {
可以看到被 @HystrixCommand 注解的方法将会执行切面处理。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Aspect</span> <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">HystrixCommandAspect</span> <span class="token punctuation">{</span> 
  <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">HystrixCommandAspect<span class="token punctuation">.</span>HystrixPointcutType</span><span class="token punctuation">,</span> <span class="token class-name">HystrixCommandAspect<span class="token punctuation">.</span>MetaHolderFactory</span><span class="token punctuation">&gt;</span></span> META_HOLDER_FACTORY_MAP<span class="token punctuation">;</span> 
  <span class="token keyword">public</span> <span class="token class-name">HystrixCommandAspect</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    
  <span class="token punctuation">}</span> 
  <span class="token annotation punctuation">@Pointcut</span><span class="token punctuation">(</span><span class="token string">&quot;@annotation(com.netflix.hystrix.contrib.javanica.annotation.HystrixC ommand)&quot;</span><span class="token punctuation">)</span> 
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">hystrixCommandAnnotationPointcut</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
  <span class="token punctuation">}</span> 
  <span class="token annotation punctuation">@Pointcut</span><span class="token punctuation">(</span><span class="token string">&quot;@annotation(com.netflix.hystrix.contrib.javanica.annotation.HystrixC ollapser)&quot;</span><span class="token punctuation">)</span> 
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">hystrixCollapserAnnotationPointcut</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token punctuation">}</span>
  <span class="token annotation punctuation">@Around</span><span class="token punctuation">(</span><span class="token string">&quot;hystrixCommandAnnotationPointcut() || hystrixCollapserAnnotationPointcut()&quot;</span><span class="token punctuation">)</span> 
  <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">methodsAnnotatedWithHystrixCommand</span><span class="token punctuation">(</span><span class="token class-name">ProceedingJoinPoint</span> joinPoint<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">{</span> 
    <span class="token comment">//略 </span>
  <span class="token punctuation">}</span>
</code></pre></div><p>可以看到被 @HystrixCommand 注解的方法将会执行切面处理。</p> <p><strong>6.4.2 环绕通知增强</strong></p> <p>在HystrixCommandAspect的methodsAnnotatedWithHystrixCommand方法中我们可以看到如下</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Around</span><span class="token punctuation">(</span><span class="token string">&quot;hystrixCommandAnnotationPointcut() || hystrixCollapserAnnotationPointcut()&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">methodsAnnotatedWithHystrixCommand</span><span class="token punctuation">(</span><span class="token class-name">ProceedingJoinPoint</span> joinPoint<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">{</span>
    <span class="token class-name">Method</span> method <span class="token operator">=</span> <span class="token class-name">AopUtils</span><span class="token punctuation">.</span><span class="token function">getMethodFromTarget</span><span class="token punctuation">(</span>joinPoint<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Validate</span><span class="token punctuation">.</span><span class="token function">notNull</span><span class="token punctuation">(</span>method<span class="token punctuation">,</span> <span class="token string">&quot;failed to get method from joinPoint: %s&quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span>joinPoint<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>method<span class="token punctuation">.</span><span class="token function">isAnnotationPresent</span><span class="token punctuation">(</span><span class="token class-name">HystrixCommand</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> method<span class="token punctuation">.</span><span class="token function">isAnnotationPresent</span><span class="token punctuation">(</span><span class="token class-name">HystrixCollapser</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">&quot;method cannot be annotated with HystrixCommand and HystrixCollapser annotations at the same time&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token class-name">HystrixCommandAspect<span class="token punctuation">.</span>MetaHolderFactory</span> metaHolderFactory <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">HystrixCommandAspect<span class="token punctuation">.</span>MetaHolderFactory</span><span class="token punctuation">)</span>META_HOLDER_FACTORY_MAP<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">HystrixCommandAspect<span class="token punctuation">.</span>HystrixPointcutType</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>method<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">MetaHolder</span> metaHolder <span class="token operator">=</span> metaHolderFactory<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>joinPoint<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">HystrixInvokable</span> invokable <span class="token operator">=</span> <span class="token class-name">HystrixCommandFactory</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>metaHolder<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ExecutionType</span> executionType <span class="token operator">=</span> metaHolder<span class="token punctuation">.</span><span class="token function">isCollapserAnnotationPresent</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">?</span> metaHolder<span class="token punctuation">.</span><span class="token function">getCollapserExecutionType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> metaHolder<span class="token punctuation">.</span><span class="token function">getExecutionType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">Object</span> result<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>metaHolder<span class="token punctuation">.</span><span class="token function">isObservable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                result <span class="token operator">=</span> <span class="token class-name">CommandExecutor</span><span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span>invokable<span class="token punctuation">,</span> executionType<span class="token punctuation">,</span> metaHolder<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                result <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">executeObservable</span><span class="token punctuation">(</span>invokable<span class="token punctuation">,</span> executionType<span class="token punctuation">,</span> metaHolder<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">return</span> result<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">HystrixBadRequestException</span> var9<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span><span class="token punctuation">)</span><span class="token punctuation">(</span>var9<span class="token punctuation">.</span><span class="token function">getCause</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> var9<span class="token punctuation">.</span><span class="token function">getCause</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> var9<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">HystrixRuntimeException</span> var10<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">hystrixRuntimeExceptionToThrowable</span><span class="token punctuation">(</span>metaHolder<span class="token punctuation">,</span> var10<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>此方法通过环绕通知的形式对目标方法进行增强，主要作用如下：</p> <ul><li>HystrixInvokable：定义了后续真正执行HystrixCommand的GenericCommand实例</li> <li>定义metaHolder，包含了当前被注解方法的所有相关有效信息</li> <li>执行方法： 在进入执行体前，其有一个判断条件，判断其是否是一个Observable模式（在Hystrix中，其实现大量依赖RXJAVA，会无处不在的看到Observable，其是一种观察者模式的实现，具体可以到RxJava项目官方做更多了解）</li></ul> <h2 id="_7-服务熔断hystrix的替换方案"><a href="#_7-服务熔断hystrix的替换方案" class="header-anchor">#</a> 7 服务熔断Hystrix的替换方案</h2> <p>18年底Netflix官方宣布Hystrix 已经足够稳定，不再积极开发 Hystrix，该项目将处于维护模式。就目前来看Hystrix是比较稳定的，并且Hystrix只是停止开发新的版本，并不是完全停止维护，Bug什么的依然会维护的。因此短期内，Hystrix依然是继续使用的。但从长远来看，Hystrix总会达到它的生命周期，那么Spring Cloud生态中是否有替代产品呢？</p> <h3 id="_7-1-替换方案介绍"><a href="#_7-1-替换方案介绍" class="header-anchor">#</a> 7.1 替换方案介绍</h3> <p><strong>Alibaba Sentinel</strong></p> <p>Sentinel 是阿里巴巴开源的一款断路器实现，目前在Spring Cloud的孵化器项目Spring Cloud Alibaba
中的一员Sentinel本身在阿里内部已经被大规模采用，非常稳定。因此可以作为一个较好的替代品。</p> <p><strong>Resilience4J</strong></p> <p>Resilicence4J 一款非常轻量、简单，并且文档非常清晰、丰富的熔断工具，这也是Hystrix官方推荐的替代产品。不仅如此，Resilicence4j还原生支持Spring Boot 1.x/2.x，而且监控也不像Hystrix一样弄Dashboard/Hystrix等一堆轮子，而是支持和Micrometer（Pivotal开源的监控门面，Spring Boot 2.x中的Actuator就是基于Micrometer的）、prometheus（开源监控系统，来自谷歌的论文）、以及Dropwizard metrics（Spring Boot曾经的模仿对象，类似于Spring Boot）进行整合。</p> <h3 id="_7-2-sentinel概述"><a href="#_7-2-sentinel概述" class="header-anchor">#</a> 7.2 Sentinel概述</h3> <h4 id="_7-2-1-sentinel简介"><a href="#_7-2-1-sentinel简介" class="header-anchor">#</a> 7.2.1 Sentinel简介</h4> <p>随着微服务的流行，服务和服务之间的稳定性变得越来越重要。Sentinel 以流量为切入点，从流量控制、熔断降级、系统负载保护等多个维度保护服务的稳定性。</p> <p>Sentinel 具有以下特征:</p> <ul><li><strong>丰富的应用场景</strong>：Sentinel 承接了阿里巴巴近 10 年的双十一大促流量的核心场景，例如秒杀（即突发流量控制在系统容量可以承受的范围）、消息削峰填谷、集群流量控制、实时熔断下游不可用应用等。</li> <li><strong>完备的实时监控</strong>：Sentinel 同时提供实时的监控功能。您可以在控制台中看到接入应用的单台机器秒级数据，甚至 500 台以下规模的集群的汇总运行情况。</li> <li><strong>广泛的开源生态</strong>：Sentinel 提供开箱即用的与其它开源框架/库的整合模块，例如与 SpringCloud、Dubbo、gRPC 的整合。您只需要引入相应的依赖并进行简单的配置即可快速地接入Sentinel。</li> <li><strong>完善的 SPI 扩展点</strong>：Sentinel 提供简单易用、完善的 SPI 扩展接口。您可以通过实现扩展接口来快
速地定制逻辑。例如定制规则管理、适配动态数据源等。</li></ul> <p>Sentinel 的主要特性：</p> <img src="/assets/img/image-20220305233741617.3ae1e82f.png" alt="image-20220305233741617" style="zoom:67%;"> <h4 id="_7-2-2-sentinel与hystrix的区别"><a href="#_7-2-2-sentinel与hystrix的区别" class="header-anchor">#</a> 7.2.2 Sentinel与Hystrix的区别</h4> <table><thead><tr><th></th> <th>Sentinel</th> <th>Hystrix</th> <th>resilience4j</th></tr></thead> <tbody><tr><td>隔离策略</td> <td>信号量隔离（并发线程数限流）</td> <td>线程池隔离/信号量隔离</td> <td>信号量隔离</td></tr> <tr><td>熔断降级策略</td> <td>基于响应时间、异常比率、异常数</td> <td>基于异常比率</td> <td>基于异常比率、响应时间</td></tr> <tr><td>实时统计实现</td> <td>滑动窗口（LeapArray）</td> <td>滑动窗口（基于 RxJava）</td> <td>Ring Bit Buffer</td></tr> <tr><td>动态规则配置</td> <td>支持多种数据源</td> <td>支持多种数据源</td> <td>有限支持</td></tr> <tr><td>扩展性</td> <td>多个扩展点</td> <td>插件的形式</td> <td>接口的形式</td></tr> <tr><td>基于注解的支持</td> <td>支持</td> <td>支持</td> <td>支持</td></tr> <tr><td>限流</td> <td>基于 QPS，支持基于调用关系的限流</td> <td>有限的支持</td> <td>Rate Limiter</td></tr> <tr><td>流量整形</td> <td>支持预热模式、匀速器模式、预热排队模式</td> <td>不支持</td> <td>简单的 Rate Limiter模式</td></tr> <tr><td>系统自适应保护</td> <td>支持</td> <td>不支持</td> <td>支持</td></tr> <tr><td>控制台</td> <td>提供开箱即用的控制台，可配置规则、查看秒级监控、机器发现等</td> <td>简单的监控查看</td> <td>不提供控制台，可对接其它监控系统</td></tr></tbody></table> <p>Sentinel 不支持线程池隔离；信号量隔离对应 Sentinel 中的线程数限流，详见此 处
熔断器 Sentinel 支持按平均响应时间、异常比率、异常数来进行熔断降级。从 Hystrix 的
异常比率熔断迁移的步骤详见此处
Command
创建
直接使用 Sentinel SphU API 定义资源即可，资源定义与规则配置分离，详见此处
规则配置 在 Sentinel 中可通过 API 硬编码配置规则，也支持多种动态规则源
注解支持 Sentinel 也提供注解支持，可以很方便地迁移，详见此处
开源框架支
持
Sentinel 提供 Servlet、Dubbo、Spring Cloud、gRPC 的适配模块，开箱即用；
若之前使用 Spring Cloud Netflix，可迁移至 Spring Cloud Alibaba</p> <h4 id="_7-2-3-迁移方案"><a href="#_7-2-3-迁移方案" class="header-anchor">#</a> 7.2.3 迁移方案</h4> <p><a href="https://github.com/alibaba/Sentinel/wiki/Guideline:-%E4%BB%8E-Hystrix-%E8%BF%81%E7%A7%BB%E5%88%B0-Sentinel" target="_blank" rel="noopener noreferrer">Sentinel<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>官方提供了详细的由Hystrix 迁移到Sentinel 的方法</p> <table><thead><tr><th>Hystrix 功 能</th> <th>迁移方案</th></tr></thead> <tbody><tr><td>线程池隔离/信号量隔离</td> <td>Sentinel 不支持线程池隔离；信号量隔离对应 Sentinel 中的线程数限流，详见<a href="https://github.com/alibaba/Sentinel/wiki/Guideline:-%E4%BB%8E-Hystrix-%E8%BF%81%E7%A7%BB%E5%88%B0-Sentinel#%E4%BF%A1%E5%8F%B7%E9%87%8F%E9%9A%94%E7%A6%BB" target="_blank" rel="noopener noreferrer">此处<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></td></tr> <tr><td>熔断器</td> <td>Sentinel 支持按平均响应时间、异常比率、异常数来进行熔断降级。从 Hystrix 的异常比率熔断迁移的步骤详见<a href="https://github.com/alibaba/Sentinel/wiki/Guideline:-%E4%BB%8E-Hystrix-%E8%BF%81%E7%A7%BB%E5%88%B0-Sentinel#%E7%86%94%E6%96%AD%E9%99%8D%E7%BA%A7" target="_blank" rel="noopener noreferrer">此处<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></td></tr> <tr><td>Command创建</td> <td>直接使用 Sentinel SphU API 定义资源即可，资源定义与规则配置分离，详见<a href="https://github.com/alibaba/Sentinel/wiki/Guideline:-%E4%BB%8E-Hystrix-%E8%BF%81%E7%A7%BB%E5%88%B0-Sentinel#command-%E8%BF%81%E7%A7%BB" target="_blank" rel="noopener noreferrer">此处<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></td></tr> <tr><td>规则配置</td> <td>在 Sentinel 中可通过 API 硬编码配置规则，也支持多种动态规则源</td></tr> <tr><td>注解支持</td> <td>Sentinel 也提供注解支持，可以很方便地迁移，详见<a href="https://github.com/alibaba/Sentinel/wiki/Guideline:-%E4%BB%8E-Hystrix-%E8%BF%81%E7%A7%BB%E5%88%B0-Sentinel#%E6%B3%A8%E8%A7%A3%E6%94%AF%E6%8C%81" target="_blank" rel="noopener noreferrer">此处<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></td></tr> <tr><td>开源框架支持</td> <td>Sentinel 提供 Servlet、Dubbo、Spring Cloud、gRPC 的适配模块，开箱即用；若之前使用 Spring Cloud Netflflix，可迁移至 Spring Cloud Alibaba</td></tr></tbody></table> <h4 id="_7-2-4-名词解释"><a href="#_7-2-4-名词解释" class="header-anchor">#</a> 7.2.4 名词解释</h4> <p>Sentinel 可以简单的分为 Sentinel 核心库和 Dashboard。核心库不依赖 Dashboard，但是结合
Dashboard 可以取得最好的效果。
使用 Sentinel 来进行熔断保护，主要分为几个步骤:</p> <ol><li>定义资源</li> <li>定义规则</li> <li>检验规则是否生效</li></ol> <p><strong>资源</strong>：可以是任何东西，一个服务，服务里的方法，甚至是一段代码。</p> <p><strong>规则</strong>：Sentinel 支持以下几种规则：流量控制规则、熔断降级规则、系统保护规则、来源访问控制规则
和 热点参数规则。Sentinel 的所有规则都可以在内存态中动态地查询及修改，修改之后立即生效</p> <p>先把可能需要保护的资源定义好，之后再配置规则。也可以理解为，只要有了资源，我们就可以在任何时候灵活地定义各种流量控制规则。在编码的时候，只需要考虑这个代码是否需要保护，如果需要保护，就将之定义为一个资源。</p> <h3 id="_7-3-sentinel中的管理控制台"><a href="#_7-3-sentinel中的管理控制台" class="header-anchor">#</a> 7.3 Sentinel中的管理控制台</h3> <h4 id="_7-3-1-下载启动控制台"><a href="#_7-3-1-下载启动控制台" class="header-anchor">#</a> 7.3.1 下载启动控制台</h4> <p><strong>（1）获取 Sentinel 控制台</strong>
您可以从官方网站中下载最新版本的控制台 jar 包，下载地址如下：
https://github.com/alibaba/Sentinel/releases/download/1.6.3/sentinel-dashboard-1.6.3.jar
<strong>（2）启动</strong></p> <p>使用如下命令启动控制台：</p> <div class="language-bash extra-class"><pre class="language-bash"><code>java -Dserver.port<span class="token operator">=</span><span class="token number">8080</span> -Dcsp.sentinel.dashboard.server<span class="token operator">=</span>localhost:8080 - Dproject.name<span class="token operator">=</span>sentinel-dashboard -jar sentinel-dashboard.jar
</code></pre></div><p>其中 <code>-Dserver.port=8080</code> 用于指定 Sentinel 控制台端口为 <code>8080</code> 。</p> <p>从 Sentinel 1.6.0 起，Sentinel 控制台引入基本的<strong>登录</strong>功能，默认用户名和密码都是 <strong><code>sentinel</code></strong> 。可以
参考 鉴权模块文档 配置用户名和密码。</p> <blockquote><p>启动 Sentinel 控制台需要 JDK 版本为 1.8 及以上版本。</p></blockquote> <h4 id="_7-3-2-客户端能接入控制台"><a href="#_7-3-2-客户端能接入控制台" class="header-anchor">#</a> 7.3.2 客户端能接入控制台</h4> <p>控制台启动后，客户端需要按照以下步骤接入到控制台。</p> <p><strong>（1） 引入JAR包</strong></p> <p>客户端需要引入 Transport 模块来与 Sentinel 控制台进行通信。可以通过 pom.xml 引入 JAR 包:</p> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span> 
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.alibaba.csp<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span> 
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>sentinel-transport-simple-http<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span> 
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span> 
</code></pre></div><p><strong>（2）配置启动参数</strong></p> <p>在工程的application.yml中添加Sentinel 控制台配置信息</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">spring</span><span class="token punctuation">:</span> 
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span> 
    <span class="token key atrule">sentinel</span><span class="token punctuation">:</span> 
      <span class="token key atrule">transport</span><span class="token punctuation">:</span> 
      	<span class="token key atrule">dashboard</span><span class="token punctuation">:</span> localhost<span class="token punctuation">:</span><span class="token number">8080</span>
</code></pre></div><p>这里的 <code>spring.cloud.sentinel.transport.dashboard</code> 配置控制台的请求路径。</p> <h4 id="_7-3-3-查看机器列表以及健康情况"><a href="#_7-3-3-查看机器列表以及健康情况" class="header-anchor">#</a> 7.3.3 查看机器列表以及健康情况</h4> <p>默认情况下Sentinel 会在客户端首次调用的时候进行初始化，开始向控制台发送心跳包。也可以配置
<code>sentinel.eager=true</code> ,取消Sentinel控制台懒加载。</p> <p>打开浏览器即可展示Sentinel的管理控制台</p> <img src="/assets/img/image-20220305235523359.ec0dda98.png" alt="image-20220305235523359" style="zoom:67%;"> <h3 id="_7-4-基于sentinel的服务保护"><a href="#_7-4-基于sentinel的服务保护" class="header-anchor">#</a> 7.4 基于Sentinel的服务保护</h3> <h4 id="_7-4-1-通用资源保护"><a href="#_7-4-1-通用资源保护" class="header-anchor">#</a> 7.4.1 通用资源保护</h4> <p><strong>（1） 案例准备</strong></p> <p>复制工程 shop_service_order 并命名为 shop_service_order_rest_sentinel</p> <p><strong>（2）引入依赖</strong></p> <p>需要注意SpringCloud-Alibaba与SpringCloud的版本关系</p> <img src="/assets/img/image-20220305235734937.82dc9372.png" alt="image-20220305235734937" style="zoom:67%;"> <p>父工程引入alibaba实现的SpringCloud</p> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span> 
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.alibaba.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span> 
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-alibaba-dependencies<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span> 
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>2.1.0.RELEASE<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span> 
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>type</span><span class="token punctuation">&gt;</span></span>pom<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>type</span><span class="token punctuation">&gt;</span></span> 
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">&gt;</span></span>import<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">&gt;</span></span> 
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>子工程中引入sentinel</p> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span> 
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.alibaba.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span> 
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-alibaba-sentinel<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span> 
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span> 
</code></pre></div><p><strong>（3） 配置熔断降级方法</strong></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/buy/{id}&quot;</span><span class="token punctuation">)</span> 
<span class="token annotation punctuation">@SentinelResource</span><span class="token punctuation">(</span>value<span class="token operator">=</span><span class="token string">&quot;order&quot;</span><span class="token punctuation">,</span>blockHandler <span class="token operator">=</span> <span class="token string">&quot;orderblockHandler&quot;</span><span class="token punctuation">,</span>fallback <span class="token operator">=</span> <span class="token string">&quot;orderfallback&quot;</span><span class="token punctuation">)</span> 
<span class="token keyword">public</span> <span class="token class-name">Product</span> <span class="token function">order</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span> <span class="token class-name">Long</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span> 
  <span class="token keyword">return</span> restTemplate<span class="token punctuation">.</span><span class="token function">getForObject</span><span class="token punctuation">(</span><span class="token string">&quot;http://shop-service- product/product/1&quot;</span><span class="token punctuation">,</span> <span class="token class-name">Product</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token comment">//降级方法 </span>
<span class="token keyword">public</span> <span class="token class-name">Product</span> <span class="token function">orderblockHandler</span><span class="token punctuation">(</span><span class="token class-name">Long</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span> 
  <span class="token class-name">Product</span> product <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Product</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
  product<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1l</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
  product<span class="token punctuation">.</span><span class="token function">setProductName</span><span class="token punctuation">(</span><span class="token string">&quot;触发熔断降级方法&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">return</span> product<span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token comment">//降级方法 </span>
<span class="token keyword">public</span> <span class="token class-name">Product</span> <span class="token function">orderfallback</span><span class="token punctuation">(</span><span class="token class-name">Long</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span> 
  <span class="token class-name">Product</span> product <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Product</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
  product<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1l</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
  product<span class="token punctuation">.</span><span class="token function">setProductName</span><span class="token punctuation">(</span><span class="token string">&quot;触发抛出异常方法&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token keyword">return</span> product<span class="token punctuation">;</span> 
<span class="token punctuation">}</span>
</code></pre></div><p>在需要被保护的方法上使用@SentinelResource注解进行熔断配置。与Hystrix不同的是，Sentinel对抛
出异常和熔断降级做了更加细致的区分，通过 <code>blockHandler</code> 指定熔断降级方法，通过 <code>fallback</code> 指定
触发异常执行的降级方法。对于@SentinelResource的其他配置如下表：</p> <table><thead><tr><th>属性</th> <th>作用</th> <th>是否必须</th></tr></thead> <tbody><tr><td>value</td> <td>资源名称</td> <td>是</td></tr> <tr><td>entryType</td> <td>entry类型，标记流量的方向，取值IN/OUT，默认是OUT</td> <td>否</td></tr> <tr><td>blockHandler</td> <td>处理BlockException的函数名称。函数要求： 1.必须是 public 2.返回类型与原方法一致 3. 参数类型需要和原方法相匹配，<strong>并在最后加BlockException 类型的参数</strong>。 4. 默认需和原方法在同一个类中。若希望使用其他类的函数，可配置 blockHandlerClass ，并指定blockHandlerClass里面的方法。</td> <td>否</td></tr> <tr><td>blockHandlerClass</td> <td>存放blockHandler的类。对应的处理函数必须static修饰，否则无法解析，其他要求：同blockHandler。</td> <td>否</td></tr> <tr><td>fallback</td> <td>用于在抛出异常的时候提供fallback处理逻辑。fallback函数可以针对所有类型的异常（除了exceptionsToIgnore 里面排除掉的异常类型）进行处理。函数要求： 1. 返回类型与原方法一致 2. 参数类型需要和原方法相匹配，<strong>Sentinel 1.6开始，也可在方法最后</strong>加 Throwable 类型的参数。 3.默认需和原方法在同一个类中。若希望使用其他类的函数，可配置 fallbackClass ，并指定fallbackClass里面的方法。</td> <td>否</td></tr> <tr><td>fallbackClass【1.6】</td> <td>存放fallback的类。对应的处理函数必须static修饰，否则无法解析，其他要求：同fallback。</td> <td>否</td></tr> <tr><td>defaultFallback【1.6】</td> <td>用于通用的 fallback 逻辑。默认fallback函数可以针对所有类型的异常（除了exceptionsToIgnore 里面排除掉的异常类型）进行处理。若同时配置了 fallback 和defaultFallback，以fallback为准。函数要求：1. 返回类型与原方法一致 2. 方法参数列表为空，<strong>或者有一个</strong> Throwable 类型的参数。 3. 默认需要和原方法在同一个类中。若希望使用其他类的函数，可配置 fallbackClass ，并指定fallbackClass 里面的方法。</td> <td>否</td></tr> <tr><td>exceptionsToIgnore【1.6】</td> <td>指定排除掉哪些异常。排除的异常不会计入异常统计，也不会进入fallback逻辑，而是原样抛出</td> <td>否</td></tr> <tr><td>exceptionsToTrace</td> <td>需要trace的异常</td> <td>Throwable</td></tr></tbody></table> <blockquote><p>注：1.6.0 之前的版本 fallback 函数只针对降级异常（ DegradeException ）进行处理，不能针对业务异常进行处理。</p></blockquote> <p>特别地，若 blockHandler 和 fallback 都进行了配置，则被限流降级而抛出 BlockException 时只会进入 blockHandler 处理逻辑。若未配置 blockHandler 、 fallback 和 defaultFallback ，则被限流降级时会将 BlockException <strong>直接抛出</strong>。</p> <h4 id="_7-4-2-rest实现熔断"><a href="#_7-4-2-rest实现熔断" class="header-anchor">#</a> 7.4.2 Rest实现熔断</h4> <p>Spring Cloud Alibaba Sentinel 支持对 RestTemplate 的服务调用使用 Sentinel 进行保护，在构造
RestTemplate bean的时候需要加上 @SentinelRestTemplate 注解。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Bean</span> 
<span class="token annotation punctuation">@LoadBalanced</span> 
<span class="token annotation punctuation">@SentinelRestTemplate</span><span class="token punctuation">(</span>fallback <span class="token operator">=</span> <span class="token string">&quot;handleFallback&quot;</span><span class="token punctuation">,</span> fallbackClass <span class="token operator">=</span> <span class="token class-name">ExceptionUtil</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> blockHandler<span class="token operator">=</span><span class="token string">&quot;handleBlock&quot;</span><span class="token punctuation">,</span>blockHandlerClass<span class="token operator">=</span><span class="token class-name">ExceptionUtil</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span> 
<span class="token keyword">public</span> <span class="token class-name">RestTemplate</span> <span class="token function">getRestTemplate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">RestTemplate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token punctuation">}</span>
</code></pre></div><ul><li><code>@SentinelRestTemplate</code> 注解的属性支持限流( <code>blockHandler</code> , <code>blockHandlerClass</code> )和降级( <code>fallback</code> , <code>fallbackClass</code> )的处理。</li> <li>其中 <code>blockHandler</code> 或 <code>fallback</code> 属性对应的方法必须是对应 <code>blockHandlerClass</code> 或 <code>fallbackClass</code> 属性中的静态方法。</li> <li>该方法的参数跟返回值跟<code>org.springframework.http.client.ClientHttpRequestInterceptor#interceptor</code> 方法一
致，其中参数多出了一个 <code>BlockException</code> 参数用于获取 Sentinel 捕获的异常。</li></ul> <p>比如上述 <code>@SentinelRestTemplate</code> 注解中 <code>ExceptionUtil</code> 的 <code>handleException</code> 属性对应的方法声明如下：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/**
* 熔断降级 
*/</span> 
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ExceptionUtil</span> <span class="token punctuation">{</span> 
  <span class="token comment">//限流熔断业务逻辑 </span>
  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">SentinelClientHttpResponse</span> <span class="token function">handleBlock</span><span class="token punctuation">(</span><span class="token class-name">HttpRequest</span> request<span class="token punctuation">,</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> body<span class="token punctuation">,</span> <span class="token class-name">ClientHttpRequestExecution</span> execution<span class="token punctuation">,</span> <span class="token class-name">BlockException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span> 
    <span class="token class-name">System</span><span class="token punctuation">.</span>err<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Oops: &quot;</span> <span class="token operator">+</span> ex<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getCanonicalName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">SentinelClientHttpResponse</span><span class="token punctuation">(</span><span class="token string">&quot;限流熔断降级&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span>
  <span class="token comment">//异常熔断业务逻辑</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">SentinelClientHttpResponse</span> <span class="token function">handleFallback</span><span class="token punctuation">(</span><span class="token class-name">HttpRequest</span> request<span class="token punctuation">,</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> body<span class="token punctuation">,</span> <span class="token class-name">ClientHttpRequestExecution</span> execution<span class="token punctuation">,</span> <span class="token class-name">BlockException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span> 
      <span class="token class-name">System</span><span class="token punctuation">.</span>err<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;fallback: &quot;</span> <span class="token operator">+</span> ex<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getCanonicalName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">SentinelClientHttpResponse</span><span class="token punctuation">(</span><span class="token string">&quot;异常熔断降级&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token punctuation">}</span> 
<span class="token punctuation">}</span>
</code></pre></div><p>Sentinel RestTemplate 限流的资源规则提供两种粒度：</p> <ul><li><code>httpmethod:schema://host:port/path</code> ：协议、主机、端口和路径</li> <li><code>httpmethod:schema://host:port</code> ：协议、主机和端口</li></ul> <h4 id="_7-4-3-feign实现熔断"><a href="#_7-4-3-feign实现熔断" class="header-anchor">#</a> 7.4.3 Feign实现熔断</h4> <p>Sentinel 适配了 Feign 组件。如果想使用，除了引入 sentinel-starter 的依赖外还需要 2 个步骤：</p> <ul><li>配置文件打开 sentinel 对 feign 的支持： <code>feign.sentinel.enabled=true</code></li> <li>加入 <code>openfeign starter</code> 依赖使 <code>sentinel starter</code> 中的自动化配置类生效：</li></ul> <p><strong>（1） 引入依赖</strong></p> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span> 
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.alibaba.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span> 
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-alibaba-sentinel<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span> 
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span> 
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span> 
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span> 
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-openfeign<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span> 
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span> 
</code></pre></div><p><strong>（2） 开启sentinel 支持</strong></p> <p>在工程的application.yml中添加sentinel 对 feign 的支持</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">feign</span><span class="token punctuation">:</span> 
  <span class="token key atrule">sentinel</span><span class="token punctuation">:</span> 
    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span> 
</code></pre></div><p><strong>（3）配置FeignClient</strong></p> <p>和使用Hystrix的方式基本一致，需要配置FeignClient接口以及通过 fallback 指定熔断降级方法</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">//指定需要调用的微服务名称 </span>
<span class="token annotation punctuation">@FeignClient</span><span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">&quot;shop-service-product&quot;</span><span class="token punctuation">,</span>fallback <span class="token operator">=</span> 
<span class="token class-name">ProductFeginClientCallBack</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span> 
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">ProductFeginClient</span> <span class="token punctuation">{</span> 
    <span class="token comment">//调用的请求路径 </span>
    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;/product/{id}&quot;</span><span class="token punctuation">,</span>method <span class="token operator">=</span> <span class="token class-name">RequestMethod</span><span class="token punctuation">.</span>GET<span class="token punctuation">)</span> 
    <span class="token keyword">public</span> <span class="token class-name">Product</span> <span class="token function">findById</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Long</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token punctuation">}</span>
</code></pre></div><p><strong>（4）配置熔断方法</strong></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/**
* 实现自定义的ProductFeginClient接口 
* 在接口实现类中编写熔断降级方法 
*/</span> 
<span class="token annotation punctuation">@Component</span> 
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ProductFeginClientCallBack</span> <span class="token keyword">implements</span> <span class="token class-name">ProductFeginClient</span> <span class="token punctuation">{</span> 

<span class="token comment">/**
* 降级方法 
*/</span> 
<span class="token keyword">public</span> <span class="token class-name">Product</span> <span class="token function">findById</span><span class="token punctuation">(</span><span class="token class-name">Long</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span> 
    <span class="token class-name">Product</span> product <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Product</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
    product<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1l</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
    product<span class="token punctuation">.</span><span class="token function">setProductName</span><span class="token punctuation">(</span><span class="token string">&quot;熔断:触发降级方法&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token keyword">return</span> product<span class="token punctuation">;</span> 
    <span class="token punctuation">}</span> 
<span class="token punctuation">}</span>
</code></pre></div><p>Feign 对应的接口中的资源名策略定义：httpmethod:protocol://requesturl。 <code>@FeignClient</code> 注解中</p> <p>的所有属性，Sentinel 都做了兼容。</p> <p>ProductFeginClient 接口中方法 fifindById 对应的资源名为 GET:http://shop-service</p> <p>product/product/{str}。</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/springcloud/springcloud-黑马教程.html" class="prev">
        springcloud-黑马教程
      </a></span> <span class="next"><a href="/netty/Netty核心技术及源码剖析.html">
        Netty核心技术及源码剖析
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.703887ae.js" defer></script><script src="/assets/js/5.a0d7f1b0.js" defer></script><script src="/assets/js/7.774e7eba.js" defer></script>
  </body>
</html>
