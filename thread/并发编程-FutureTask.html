<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>并发编程-FutureTask | JavaPool</title>
    <meta name="generator" content="VuePress 1.9.7">
    
    <meta name="description" content="java pool icu">
    
    <link rel="preload" href="/assets/css/0.styles.352a29d9.css" as="style"><link rel="preload" href="/assets/js/app.8d5294d9.js" as="script"><link rel="preload" href="/assets/js/10.c4f7cd1e.js" as="script"><link rel="preload" href="/assets/js/27.005f8f1c.js" as="script"><link rel="prefetch" href="/assets/js/11.61f99dc0.js"><link rel="prefetch" href="/assets/js/12.a855e18b.js"><link rel="prefetch" href="/assets/js/13.9c16b241.js"><link rel="prefetch" href="/assets/js/14.fbf94e2d.js"><link rel="prefetch" href="/assets/js/15.bc99648c.js"><link rel="prefetch" href="/assets/js/16.e4202c0c.js"><link rel="prefetch" href="/assets/js/17.b436115f.js"><link rel="prefetch" href="/assets/js/18.2739463e.js"><link rel="prefetch" href="/assets/js/19.e7a73215.js"><link rel="prefetch" href="/assets/js/2.c31141b5.js"><link rel="prefetch" href="/assets/js/20.26391b50.js"><link rel="prefetch" href="/assets/js/21.eded1cc3.js"><link rel="prefetch" href="/assets/js/22.7be6d8e3.js"><link rel="prefetch" href="/assets/js/23.44ce3621.js"><link rel="prefetch" href="/assets/js/24.beae151b.js"><link rel="prefetch" href="/assets/js/25.e8eb8f9a.js"><link rel="prefetch" href="/assets/js/26.8dd39e3a.js"><link rel="prefetch" href="/assets/js/28.67677726.js"><link rel="prefetch" href="/assets/js/29.05948dfa.js"><link rel="prefetch" href="/assets/js/3.97b7ae40.js"><link rel="prefetch" href="/assets/js/30.208e66ae.js"><link rel="prefetch" href="/assets/js/31.502ae30e.js"><link rel="prefetch" href="/assets/js/32.df6980f3.js"><link rel="prefetch" href="/assets/js/33.2f76ec2c.js"><link rel="prefetch" href="/assets/js/34.c7bac356.js"><link rel="prefetch" href="/assets/js/35.0667b473.js"><link rel="prefetch" href="/assets/js/36.2b374da1.js"><link rel="prefetch" href="/assets/js/37.36ab3364.js"><link rel="prefetch" href="/assets/js/38.4e357da1.js"><link rel="prefetch" href="/assets/js/39.631d8d45.js"><link rel="prefetch" href="/assets/js/4.6eab1a34.js"><link rel="prefetch" href="/assets/js/40.f0b3c7f9.js"><link rel="prefetch" href="/assets/js/41.dd3bc0ff.js"><link rel="prefetch" href="/assets/js/42.f070952d.js"><link rel="prefetch" href="/assets/js/43.07184f56.js"><link rel="prefetch" href="/assets/js/44.89db7843.js"><link rel="prefetch" href="/assets/js/45.539abe19.js"><link rel="prefetch" href="/assets/js/46.ec3e3c5d.js"><link rel="prefetch" href="/assets/js/47.40e22ef4.js"><link rel="prefetch" href="/assets/js/48.6d81dcd0.js"><link rel="prefetch" href="/assets/js/49.51608924.js"><link rel="prefetch" href="/assets/js/5.359b3d9d.js"><link rel="prefetch" href="/assets/js/50.c6d1326b.js"><link rel="prefetch" href="/assets/js/51.55f53858.js"><link rel="prefetch" href="/assets/js/52.14185783.js"><link rel="prefetch" href="/assets/js/53.4ef2ccc6.js"><link rel="prefetch" href="/assets/js/54.f9146511.js"><link rel="prefetch" href="/assets/js/55.a6de0ba0.js"><link rel="prefetch" href="/assets/js/56.b164fa07.js"><link rel="prefetch" href="/assets/js/57.9df9ef1f.js"><link rel="prefetch" href="/assets/js/58.24f0012e.js"><link rel="prefetch" href="/assets/js/59.1803a5d9.js"><link rel="prefetch" href="/assets/js/6.c0573a18.js"><link rel="prefetch" href="/assets/js/60.9b8cc665.js"><link rel="prefetch" href="/assets/js/61.d4fdd699.js"><link rel="prefetch" href="/assets/js/62.e2daa0cc.js"><link rel="prefetch" href="/assets/js/7.d9dd7984.js"><link rel="prefetch" href="/assets/js/8.6d5e6549.js"><link rel="prefetch" href="/assets/js/9.17af99c7.js">
    <link rel="stylesheet" href="/assets/css/0.styles.352a29d9.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">JavaPool</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <!----></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><!---->  <ul class="sidebar-links"><li><a href="/" aria-current="page" class="sidebar-link">首页</a></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>基础</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/basics/反射.html" class="sidebar-link">反射</a></li><li><a href="/basics/注解.html" class="sidebar-link">注解</a></li><li><a href="/basics/枚举.html" class="sidebar-link">枚举</a></li><li><a href="/basics/IO.html" class="sidebar-link">IO</a></li><li><a href="/basics/集合.html" class="sidebar-link">集合</a></li><li><a href="/basics/异常.html" class="sidebar-link">异常</a></li><li><a href="/basics/拦截器.html" class="sidebar-link">拦截器</a></li><li><a href="/basics/过虑器.html" class="sidebar-link">过虑器</a></li><li><a href="/basics/jdk8.html" class="sidebar-link">jdk8</a></li><li><a href="/basics/Java8-Lambda.html" class="sidebar-link">Java8-Lambda</a></li><li><a href="/basics/Java8-Stream.html" class="sidebar-link">Java8-Stream</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>设计模式</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/designpattern/黑马-设计模式.html" class="sidebar-link">黑马-设计模式</a></li><li><a href="/designpattern/UML.html" class="sidebar-link">UML类图</a></li><li><a href="/designpattern/七大原则.html" class="sidebar-link">七大原则</a></li><li><a href="/designpattern/23种设计模式.html" class="sidebar-link">23种设计模式</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>JVM</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/bar/three.html" class="sidebar-link">JVM基础概念</a></li><li><a href="/bar/four.html" class="sidebar-link">JVM实战</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>并发多线程</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/thread/并发编程三大核心问题.html" class="sidebar-link">并发编程三大核心问题</a></li><li><a href="/thread/深入理解线程池.html" class="sidebar-link">深入理解线程池</a></li><li><a href="/thread/线程池.html" class="sidebar-link">线程池</a></li><li><a href="/thread/并发编程-FutureTask.html" class="active sidebar-link">并发编程-FutureTask</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/thread/并发编程-FutureTask.html#_1-runnable、callable、future、futuretask" class="sidebar-link">1. Runnable、Callable、Future、FutureTask</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/thread/并发编程-FutureTask.html#_1-1-runnable" class="sidebar-link">1.1 Runnable</a></li><li class="sidebar-sub-header"><a href="/thread/并发编程-FutureTask.html#_1-2-callable" class="sidebar-link">1.2 Callable</a></li><li class="sidebar-sub-header"><a href="/thread/并发编程-FutureTask.html#_1-3-future" class="sidebar-link">1.3 Future</a></li><li class="sidebar-sub-header"><a href="/thread/并发编程-FutureTask.html#_1-4-futuretask" class="sidebar-link">1.4 FutureTask</a></li></ul></li><li class="sidebar-sub-header"><a href="/thread/并发编程-FutureTask.html#_2-futuretask类结构" class="sidebar-link">2. FutureTask类结构</a></li><li class="sidebar-sub-header"><a href="/thread/并发编程-FutureTask.html#_3-futuretask状态" class="sidebar-link">3. FutureTask状态</a></li><li class="sidebar-sub-header"><a href="/thread/并发编程-FutureTask.html#_4-执行任务run" class="sidebar-link">4. 执行任务run()</a></li><li class="sidebar-sub-header"><a href="/thread/并发编程-FutureTask.html#_5-获取任务返回值get-方法" class="sidebar-link">5. 获取任务返回值get()方法</a></li><li class="sidebar-sub-header"><a href="/thread/并发编程-FutureTask.html#_6-取消任务-cancel" class="sidebar-link">6. 取消任务 cancel()</a></li></ul></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>MySQL</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/mysql/索引.html" class="sidebar-link">索引</a></li><li><a href="/mysql/锁.html" class="sidebar-link">锁</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>MyCat</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/mycat/MyCat课程讲义.html" class="sidebar-link">MyCat课程讲义</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Redis</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/redis/Redis安装说明.html" class="sidebar-link">Redis安装说明</a></li><li><a href="/redis/Redis集群.html" class="sidebar-link">Redis集群</a></li><li><a href="/redis/分布式缓存.html" class="sidebar-link">分布式缓存</a></li><li><a href="/redis/多级缓存.html" class="sidebar-link">多级缓存</a></li><li><a href="/redis/持久化.html" class="sidebar-link">持久化</a></li><li><a href="/redis/分布式锁.html" class="sidebar-link">分布式锁</a></li><li><a href="/redis/Redis官方的高可用解决方案.html" class="sidebar-link">Redis官方的高可用解决方案</a></li><li><a href="/redis/数据库缓存最终一致性的四种方案.html" class="sidebar-link">数据库缓存最终一致性的四种方案</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Spring</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/spring/BeanFactory和FactoryBean的区别.html" class="sidebar-link">BeanFactory和FactoryBean的区别</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Mybatis</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/mybatis/MyBatis的SQL执行流程分析.html" class="sidebar-link">MyBatis的SQL执行流程分析</a></li><li><a href="/mybatis/MyBatisPlus.html" class="sidebar-link">MyBatisPlus</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>SpringBoot</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/springboot/SpringBoot经典学习笔记.html" class="sidebar-link">SpringBoot经典学习笔记</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Spring Cloud</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/springcloud/springcloud-day1.html" class="sidebar-link">springcloud-day1</a></li><li><a href="/springcloud/springcloud-day2.html" class="sidebar-link">springcloud-day2</a></li><li><a href="/springcloud/springcloud-day3.html" class="sidebar-link">springcloud-day3</a></li><li><a href="/springcloud/springcloud-day4.html" class="sidebar-link">springcloud-day4</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Netty</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/netty/Netty核心技术及源码剖析.html" class="sidebar-link">Netty核心技术及源码剖析</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Netty</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/ElasticSearch/ElasticSearch-尚硅谷.html" class="sidebar-link">ElasticSearch-尚硅谷</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>git</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/git/45个git经典操作场景.html" class="sidebar-link">45个git经典操作场景</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>K8S</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/k8s/k8s-黑马.html" class="sidebar-link">k8s-黑马教程</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Linux</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/linux/Centos6.8安装mysql6.54.html" class="sidebar-link">Centos6.8安装mysql6.54</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>工具集</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/utils/完整的身份证正则表达式.html" class="sidebar-link">完整的身份证正则表达式</a></li><li><a href="/utils/Java自带工具方法.html" class="sidebar-link">Java自带工具方法</a></li><li><a href="/utils/RSA加密与解密.html" class="sidebar-link">RSA加密与解密</a></li></ul></section></li><li><a href="/about.html" class="sidebar-link">关于</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="并发编程-futuretask"><a href="#并发编程-futuretask" class="header-anchor">#</a> 并发编程-FutureTask</h1> <p>线程池源码中出现了很多Callable、Future、FutureTask等以前没介绍过的接口，尤其是线程池提交任务时总是把任务封装成FutureTask，今天就来为大家解惑：</p> <ol><li>Runnable、Callable、Future、FutureTask</li> <li>FutureTask类结构</li> <li>FutureTask状态</li> <li>执行任务 run()方法</li> <li>获取任务返回值 get()方法</li> <li>取消任务 cancel()方法</li></ol> <h2 id="_1-runnable、callable、future、futuretask"><a href="#_1-runnable、callable、future、futuretask" class="header-anchor">#</a> 1. Runnable、Callable、Future、FutureTask</h2> <h3 id="_1-1-runnable"><a href="#_1-1-runnable" class="header-anchor">#</a> 1.1 Runnable</h3> <p>Runnable接口只有一个run方法，而run方法的返回值是void，所以线程执行完之后没有返回值。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">Runnable</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="_1-2-callable"><a href="#_1-2-callable" class="header-anchor">#</a> 1.2 Callable</h3> <p>在很多场景下，我们通过线程来异步执行任务之后，希望获取到任务的执行结果。比如RPC框架中，需要异步获取任务返回值。这种情况下，Runnable无法获取返回值就无法满足需求了，因此Callable就出现了。</p> <p>Callable也是一个接口，也只有一个call()方法，不同的是Callable的call()方法有是有返回值的，返回值的类型是一个泛型，泛型由创建Callable对象时指定。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">Callable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
 <span class="token class-name">V</span> <span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="_1-3-future"><a href="#_1-3-future" class="header-anchor">#</a> 1.3 Future</h3> <p>要想获得Callable的返回值就需要用到Future接口。Futrue可以监视和控制Callable任务的执行情况，如对执行结果进行取消、查询是否完成、获取结果等。</p> <p>如：当一个任务通过线程池的submit()方法提交到线程池后，线程池会返回一个Future类型的对象，我们可以通过Future对象来获取任务在线程池中的状态。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">Future</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
    <span class="token keyword">boolean</span> <span class="token function">cancel</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> mayInterruptIfRunning<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">boolean</span> <span class="token function">isCancelled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">boolean</span> <span class="token function">isDone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">V</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span><span class="token punctuation">,</span> <span class="token class-name">ExecutionException</span><span class="token punctuation">;</span>
    <span class="token class-name">V</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token keyword">long</span> timeout<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span> unit<span class="token punctuation">)</span>
            <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span><span class="token punctuation">,</span> <span class="token class-name">ExecutionException</span><span class="token punctuation">,</span> <span class="token class-name">TimeoutException</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>cancel方法：用来取消任务，如果取消任务成功则返回true，如果取消任务失败则返回false。
mayInterruptIfRunning参数用来表示是否需要中断线程，如果传true，表示需要中断线程，那么就会将任务的状态设置为INTERRUPTING；如果为false，那么就会将任务的状态设置为CANCELLED（关于任务的状态INTERRUPTING和CANCELLED后面会说明）</li> <li>isCancelled方法：表示任务是否被取消成功，如果在任务正常完成前被取消成功，则返回 true</li> <li>isDone方法：表示任务是否已经完成，若任务完成，则返回true</li> <li>get()方法：用来获取执行结果，这个方法会产生阻塞，会一直等到任务执行完毕才返回。</li> <li>get(long timeout, TimeUnit unit)方法：获取执行结果，如果在指定时间内，还没获取到结果，就直接返回null。</li></ul> <p>举例：Future获取Callable任务的返回值</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FutureExample</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span><span class="token punctuation">,</span> <span class="token class-name">ExecutionException</span> <span class="token punctuation">{</span>
        <span class="token class-name">ExecutorService</span> threadPool <span class="token operator">=</span> <span class="token class-name">Executors</span><span class="token punctuation">.</span><span class="token function">newCachedThreadPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Future</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> future <span class="token operator">=</span> threadPool<span class="token punctuation">.</span><span class="token function">submit</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Callable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
                <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token string">&quot;结果&quot;</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Callable返回值=&quot;</span> <span class="token operator">+</span> future<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>输出结果：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">Callable</span>返回值<span class="token operator">=</span>结果
</code></pre></div><h3 id="_1-4-futuretask"><a href="#_1-4-futuretask" class="header-anchor">#</a> 1.4 FutureTask</h3> <p>FutureTask是Runnable和Future的实现类，既可以作为Runnable被线程执行，又可以作为Future得到Callable的返回值。</p> <p><img src="data:image/png;base64,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" alt="图片"></p> <p>当线程池调用submit()方法来向线程池中提交任务时，无论提交的是Runnable类型的任务，还是提交的是Callable类型的任务，最终都是将任务封装成一个FutureTask对象，我们可以通过这个FutureTask对象来获取任务在线程池中的状态。</p> <div class="language-java extra-class"><pre class="language-java"><code>    <span class="token keyword">public</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">Future</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token function">submit</span><span class="token punctuation">(</span><span class="token class-name">Callable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> task<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>task <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NullPointerException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 调用newTaskFor()将Callable任务封装成一个FutureTask</span>
        <span class="token class-name">RunnableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> ftask <span class="token operator">=</span> <span class="token function">newTaskFor</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 执行任务</span>
        <span class="token function">execute</span><span class="token punctuation">(</span>ftask<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> ftask<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// newTaskFor</span>
    <span class="token keyword">protected</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">RunnableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token function">newTaskFor</span><span class="token punctuation">(</span><span class="token class-name">Callable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> callable<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 直接new一个FutureTask对象</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">FutureTask</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>callable<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre></div><h2 id="_2-futuretask类结构"><a href="#_2-futuretask类结构" class="header-anchor">#</a> 2. FutureTask类结构</h2> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FutureTask</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">implements</span> <span class="token class-name">RunnableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
    <span class="token comment">/** state变量用来保存任务的状态 */</span>
    <span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token keyword">int</span> state<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">NEW</span>          <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">COMPLETING</span>   <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">NORMAL</span>       <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">EXCEPTIONAL</span>  <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">CANCELLED</span>    <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">INTERRUPTING</span> <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">INTERRUPTED</span>  <span class="token operator">=</span> <span class="token number">6</span><span class="token punctuation">;</span>
    
    <span class="token comment">/** 提交的任务，Runnable类型的任务会通过Executors.callable()来转变为Callable */</span>
    <span class="token keyword">private</span> <span class="token class-name">Callable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> callable<span class="token punctuation">;</span>
    <span class="token comment">/** 用来保存Callable的call()方法的返回值 */</span>
    <span class="token keyword">private</span> <span class="token class-name">Object</span> outcome<span class="token punctuation">;</span>
    <span class="token comment">/** 执行Callable任务的线程 **/</span>
    <span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token class-name">Thread</span> runner<span class="token punctuation">;</span>
    <span class="token comment">/**
     * 任务未完成时，调用get方法获取结果的线程会阻塞等待
     * waiters用于保存这些线程
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token class-name">WaitNode</span> waiters<span class="token punctuation">;</span>
    
    <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">WaitNode</span> <span class="token punctuation">{</span>
        <span class="token keyword">volatile</span> <span class="token class-name">Thread</span> thread<span class="token punctuation">;</span>
        <span class="token keyword">volatile</span> <span class="token class-name">WaitNode</span> next<span class="token punctuation">;</span>
        <span class="token class-name">WaitNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> thread <span class="token operator">=</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="_3-futuretask状态"><a href="#_3-futuretask状态" class="header-anchor">#</a> 3. FutureTask状态</h2> <p>FutureTask任务的状态如下：</p> <div class="language-java extra-class"><pre class="language-java"><code>    <span class="token comment">// 任务的初始状态，当新建一个FutureTask任务时，state值默认为NEW</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">NEW</span>          <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token comment">// 任务处于完成中，也就是正在执行还未设置返回值</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">COMPLETING</span>   <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token comment">// 任务正常被执行完成，并将任务的返回值赋值给outcome属性之后</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">NORMAL</span>       <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
    <span class="token comment">// 任务出了异常，并将异常对象赋值给outcome属性之后</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">EXCEPTIONAL</span>  <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>
    <span class="token comment">// 调用cancle(false)，任务被取消了</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">CANCELLED</span>    <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span>
    <span class="token comment">// 调用cancle(true)，任务中断，但是在线程中断之前</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">INTERRUPTING</span> <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>
    <span class="token comment">//  调用cancle(true)，任务中断，但是在线程中断之后</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">INTERRUPTED</span>  <span class="token operator">=</span> <span class="token number">6</span><span class="token punctuation">;</span>
</code></pre></div><p>状态变化如下图：</p> <p><img src="/assets/img/20210714002.d0054a95.png" alt="图片"></p> <h2 id="_4-执行任务run"><a href="#_4-执行任务run" class="header-anchor">#</a> 4. 执行任务run()</h2> <ol><li>执行future.callable.call()，执行任务；</li> <li>执行成功，设置结果outcome；</li> <li>逐个唤醒waiters中的线程去获取执行结果。</li></ol> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token comment">/*
  * 1. 不是NEW状态，不能执行
  * 2. 设置runner失败，不能执行
  */</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>state <span class="token operator">!=</span> <span class="token constant">NEW</span> <span class="token operator">||</span>
  <span class="token operator">!</span><span class="token constant">UNSAFE</span><span class="token punctuation">.</span><span class="token function">compareAndSwapObject</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> runnerOffset<span class="token punctuation">,</span>
          <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token keyword">return</span><span class="token punctuation">;</span>
 <span class="token keyword">try</span> <span class="token punctuation">{</span>
  <span class="token class-name">Callable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> c <span class="token operator">=</span> callable<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>c <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> state <span class="token operator">==</span> <span class="token constant">NEW</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token class-name">V</span> result<span class="token punctuation">;</span>
   <span class="token keyword">boolean</span> ran<span class="token punctuation">;</span>
   <span class="token keyword">try</span> <span class="token punctuation">{</span>
    result <span class="token operator">=</span> c<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 真正执行任务</span>
    ran <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span><span class="token comment">// 执行成功，设置执行成功标志</span>
   <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    result <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    ran <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span><span class="token comment">// 有异常，执行失败</span>
    <span class="token function">setException</span><span class="token punctuation">(</span>ex<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 设置异常</span>
   <span class="token punctuation">}</span>
   <span class="token comment">// 如果执行成功，则设置返回结果</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span>ran<span class="token punctuation">)</span>
    <span class="token function">set</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
 <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
  runner <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span><span class="token comment">// 无论是否执行成功，把runner设置为null</span>
  <span class="token keyword">int</span> s <span class="token operator">=</span> state<span class="token punctuation">;</span>
  <span class="token comment">// 处理中断</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>s <span class="token operator">&gt;=</span> <span class="token constant">INTERRUPTING</span><span class="token punctuation">)</span>
   <span class="token function">handlePossibleCancellationInterrupt</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
 * 设置执行结果
 */</span>
<span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">set</span><span class="token punctuation">(</span><span class="token class-name">V</span> v<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">UNSAFE</span><span class="token punctuation">.</span><span class="token function">compareAndSwapInt</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> stateOffset<span class="token punctuation">,</span> <span class="token constant">NEW</span><span class="token punctuation">,</span> <span class="token constant">COMPLETING</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">// 执行完成，设置COMPLETING状态</span>
  outcome <span class="token operator">=</span> v<span class="token punctuation">;</span><span class="token comment">// 设置执行结果</span>
  <span class="token constant">UNSAFE</span><span class="token punctuation">.</span><span class="token function">putOrderedInt</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> stateOffset<span class="token punctuation">,</span> <span class="token constant">NORMAL</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 设置完结果，设置NORMAL状态</span>
  <span class="token function">finishCompletion</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 逐个唤醒waiters中的线程去获取执行结果</span>
 <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="_5-获取任务返回值get-方法"><a href="#_5-获取任务返回值get-方法" class="header-anchor">#</a> 5. 获取任务返回值get()方法</h2> <ol><li>任务状态为NORMAL，直接返回执行结果；</li> <li>任务状态为COMPLETING，线程yield()让出CPU，因为COMPLETING到NORMAL只需要很短的时间，get线程让出CPU的短暂时间，任务状态就是从COMPLETING变成了NORMAL；</li> <li>任务状态为NEW，将get线程阻塞，如果设置了超时，阻塞至超时时间；如果没有设置超时，会一直阻塞直到任务完成后唤醒。</li></ol> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">V</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span><span class="token punctuation">,</span> <span class="token class-name">ExecutionException</span> <span class="token punctuation">{</span>
 <span class="token keyword">int</span> s <span class="token operator">=</span> state<span class="token punctuation">;</span>
 <span class="token comment">// 如果状态处于NEW或者COMPLETING状态，表示任务还没有执行完成，awaitDone()等待</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>s <span class="token operator">&lt;=</span> <span class="token constant">COMPLETING</span><span class="token punctuation">)</span>
  s <span class="token operator">=</span> <span class="token function">awaitDone</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token number">0L</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 下文详解</span>
 <span class="token comment">// 返回结果，下文详解</span>
 <span class="token keyword">return</span> <span class="token function">report</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
 * 返回执行结果
 */</span>
<span class="token keyword">private</span> <span class="token class-name">V</span> <span class="token function">report</span><span class="token punctuation">(</span><span class="token keyword">int</span> s<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ExecutionException</span> <span class="token punctuation">{</span>
 <span class="token class-name">Object</span> x <span class="token operator">=</span> outcome<span class="token punctuation">;</span>
 <span class="token comment">// 任务正常结束时，返回outcome</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>s <span class="token operator">==</span> <span class="token constant">NORMAL</span><span class="token punctuation">)</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token class-name">V</span><span class="token punctuation">)</span>x<span class="token punctuation">;</span>
 <span class="token comment">// 任务被取消了，抛出CancellationException</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>s <span class="token operator">&gt;=</span> <span class="token constant">CANCELLED</span><span class="token punctuation">)</span>
  <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">CancellationException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token comment">// 这里只能第EXCEPTIONAL状态，表示在执行过程中出现了异常，抛出ExecutionException。</span>
 <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ExecutionException</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">Throwable</span><span class="token punctuation">)</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
 * 处于NEW或者COMPLETING状态时，get线程等待
 */</span>
<span class="token keyword">private</span> <span class="token keyword">int</span> <span class="token function">awaitDone</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> timed<span class="token punctuation">,</span> <span class="token keyword">long</span> nanos<span class="token punctuation">)</span>
  <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
 <span class="token comment">// ......</span>
 <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// ......</span>
  <span class="token comment">// 任务处于COMPLETING中，就让当前线程先暂时放弃CPU的执行权</span>
  <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>s <span class="token operator">==</span> <span class="token constant">COMPLETING</span><span class="token punctuation">)</span> <span class="token comment">// cannot time out yet</span>
   <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token keyword">yield</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// ......         </span>
  <span class="token comment">// 如果设置了超时，阻塞至超时时间</span>
  <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>timed<span class="token punctuation">)</span> <span class="token punctuation">{</span>
   nanos <span class="token operator">=</span> deadline <span class="token operator">-</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">nanoTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span>nanos <span class="token operator">&lt;=</span> <span class="token number">0L</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">removeWaiter</span><span class="token punctuation">(</span>q<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> state<span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token comment">// 等待一段时间</span>
   <span class="token class-name">LockSupport</span><span class="token punctuation">.</span><span class="token function">parkNanos</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> nanos<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">else</span>
   <span class="token comment">// 如果没有设置超时，会一直阻塞，直到被中断或者被唤醒</span>
   <span class="token class-name">LockSupport</span><span class="token punctuation">.</span><span class="token function">park</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="_6-取消任务-cancel"><a href="#_6-取消任务-cancel" class="header-anchor">#</a> 6. 取消任务 cancel()</h2> <p>将任务状态设置成INTERRUPTING/INTERRUPTED/CANCELLED状态就表示取消了线程，因为在这些状态下任务的run方法是不能执行的。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">cancel</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> mayInterruptIfRunning<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token comment">/*
  * 以下情况不能取消任务：
  * 1. 当前任务不是NEW状态，已经被执行了，不能取消
  * 2. 当前任务还没有执行，state == NEW，但是CAS设置状态失败，不能取消
  */</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>state <span class="token operator">==</span> <span class="token constant">NEW</span> <span class="token operator">&amp;&amp;</span>
    <span class="token constant">UNSAFE</span><span class="token punctuation">.</span><span class="token function">compareAndSwapInt</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> stateOffset<span class="token punctuation">,</span> <span class="token constant">NEW</span><span class="token punctuation">,</span>
     mayInterruptIfRunning <span class="token operator">?</span> <span class="token constant">INTERRUPTING</span> <span class="token operator">:</span> <span class="token constant">CANCELLED</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
 <span class="token keyword">try</span> <span class="token punctuation">{</span>    <span class="token comment">// in case call to interrupt throws exception</span>
  <span class="token comment">// 中断</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>mayInterruptIfRunning<span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token class-name">Thread</span> t <span class="token operator">=</span> runner<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>t <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
     t<span class="token punctuation">.</span><span class="token function">interrupt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 中断线程</span>
   <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span> <span class="token comment">// final state</span>
    <span class="token comment">// 中断之后，设置INTERRUPTED状态</span>
    <span class="token constant">UNSAFE</span><span class="token punctuation">.</span><span class="token function">putOrderedInt</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> stateOffset<span class="token punctuation">,</span> <span class="token constant">INTERRUPTED</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
 <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
  <span class="token function">finishCompletion</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 唤醒waiters中的线程去获取执行结果</span>
 <span class="token punctuation">}</span>
 <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="custom-block tip"><p class="custom-block-title">来源</p> <p><a href="https://mp.weixin.qq.com/s?__biz=MzAxMjEwMzQ5MA==&amp;mid=2448893268&amp;idx=2&amp;sn=a1aeb955fbbba6af7c0914abd3eb4399&amp;chksm=8fb57f79b8c2f66f3bf500776965d4fc305e273e408d7fc33c51da813ecfa8f237e98ce77186&amp;scene=178&amp;cur_album_id=1348578428257353729#rd" target="_blank" rel="noopener noreferrer">java进阶架构师<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></div></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/thread/线程池.html" class="prev">
        线程池
      </a></span> <span class="next"><a href="/mysql/索引.html">
        索引
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.8d5294d9.js" defer></script><script src="/assets/js/10.c4f7cd1e.js" defer></script><script src="/assets/js/27.005f8f1c.js" defer></script>
  </body>
</html>
