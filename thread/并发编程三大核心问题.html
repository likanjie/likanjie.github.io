<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>并发编程三大问题：原子性、可见性、有序性。 | JavaPool</title>
    <meta name="generator" content="VuePress 1.8.2">
    
    <meta name="description" content="java poll icu">
    
    <link rel="preload" href="/assets/css/0.styles.f5fa7e15.css" as="style"><link rel="preload" href="/assets/js/app.939029db.js" as="script"><link rel="preload" href="/assets/js/5.a0d7f1b0.js" as="script"><link rel="preload" href="/assets/js/13.f2ff2520.js" as="script"><link rel="prefetch" href="/assets/js/10.4930db7c.js"><link rel="prefetch" href="/assets/js/11.664c83f6.js"><link rel="prefetch" href="/assets/js/12.b07b045c.js"><link rel="prefetch" href="/assets/js/14.6e22c037.js"><link rel="prefetch" href="/assets/js/15.e1312efe.js"><link rel="prefetch" href="/assets/js/16.1cf74602.js"><link rel="prefetch" href="/assets/js/17.b9e8e731.js"><link rel="prefetch" href="/assets/js/18.dcd2a204.js"><link rel="prefetch" href="/assets/js/19.0c0ab762.js"><link rel="prefetch" href="/assets/js/2.dc8fbfc9.js"><link rel="prefetch" href="/assets/js/20.302be875.js"><link rel="prefetch" href="/assets/js/21.84065760.js"><link rel="prefetch" href="/assets/js/22.a772e2e0.js"><link rel="prefetch" href="/assets/js/23.405a3f6d.js"><link rel="prefetch" href="/assets/js/24.cdf49edf.js"><link rel="prefetch" href="/assets/js/25.661bff2a.js"><link rel="prefetch" href="/assets/js/26.e54d2e81.js"><link rel="prefetch" href="/assets/js/27.21badb7b.js"><link rel="prefetch" href="/assets/js/28.abf47a58.js"><link rel="prefetch" href="/assets/js/29.31368a4c.js"><link rel="prefetch" href="/assets/js/3.b22e8034.js"><link rel="prefetch" href="/assets/js/30.2b3fec8b.js"><link rel="prefetch" href="/assets/js/31.127d34fd.js"><link rel="prefetch" href="/assets/js/32.bb536940.js"><link rel="prefetch" href="/assets/js/33.6bb10321.js"><link rel="prefetch" href="/assets/js/34.196e9342.js"><link rel="prefetch" href="/assets/js/35.91f5e2d7.js"><link rel="prefetch" href="/assets/js/36.44bd11af.js"><link rel="prefetch" href="/assets/js/37.2196b9db.js"><link rel="prefetch" href="/assets/js/38.b5fc08ca.js"><link rel="prefetch" href="/assets/js/39.1d39e635.js"><link rel="prefetch" href="/assets/js/4.5de2ab9a.js"><link rel="prefetch" href="/assets/js/40.6a4052db.js"><link rel="prefetch" href="/assets/js/41.74a36917.js"><link rel="prefetch" href="/assets/js/42.c5e0d73e.js"><link rel="prefetch" href="/assets/js/43.eefece58.js"><link rel="prefetch" href="/assets/js/44.99992d39.js"><link rel="prefetch" href="/assets/js/45.f9d650f6.js"><link rel="prefetch" href="/assets/js/46.2470e152.js"><link rel="prefetch" href="/assets/js/47.a03f8573.js"><link rel="prefetch" href="/assets/js/48.130f4e32.js"><link rel="prefetch" href="/assets/js/49.e3515dad.js"><link rel="prefetch" href="/assets/js/50.901c44c5.js"><link rel="prefetch" href="/assets/js/51.a01a4d9e.js"><link rel="prefetch" href="/assets/js/52.35a59463.js"><link rel="prefetch" href="/assets/js/6.f9f76ed6.js"><link rel="prefetch" href="/assets/js/7.f65121c9.js"><link rel="prefetch" href="/assets/js/8.6fa13a5d.js"><link rel="prefetch" href="/assets/js/9.f9cb8b5e.js">
    <link rel="stylesheet" href="/assets/css/0.styles.f5fa7e15.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">JavaPool</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <!----></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><!---->  <ul class="sidebar-links"><li><a href="/" aria-current="page" class="sidebar-link">首页</a></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>基础</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/basics/反射.html" class="sidebar-link">反射</a></li><li><a href="/basics/注解.html" class="sidebar-link">注解</a></li><li><a href="/basics/枚举.html" class="sidebar-link">枚举</a></li><li><a href="/basics/IO.html" class="sidebar-link">IO</a></li><li><a href="/basics/集合.html" class="sidebar-link">集合</a></li><li><a href="/basics/异常.html" class="sidebar-link">异常</a></li><li><a href="/basics/拦截器.html" class="sidebar-link">拦截器</a></li><li><a href="/basics/过虑器.html" class="sidebar-link">过虑器</a></li><li><a href="/basics/jdk8.html" class="sidebar-link">jdk8</a></li><li><a href="/basics/Java8-Lambda.html" class="sidebar-link">Java8-Lambda</a></li><li><a href="/basics/Java8-Stream.html" class="sidebar-link">Java8-Stream</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>设计模式</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/designpattern/黑马-设计模式.html" class="sidebar-link">黑马-设计模式</a></li><li><a href="/designpattern/UML.html" class="sidebar-link">UML类图</a></li><li><a href="/designpattern/七大原则.html" class="sidebar-link">七大原则</a></li><li><a href="/designpattern/23种设计模式.html" class="sidebar-link">23种设计模式</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>JVM</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/bar/three.html" class="sidebar-link">JVM基础概念</a></li><li><a href="/bar/four.html" class="sidebar-link">JVM实战</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>并发多线程</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/thread/并发编程三大核心问题.html" class="active sidebar-link">并发编程三大核心问题</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/thread/并发编程三大核心问题.html#可见性" class="sidebar-link">可见性</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/thread/并发编程三大核心问题.html#可见性是什么" class="sidebar-link">可见性是什么？</a></li><li class="sidebar-sub-header"><a href="/thread/并发编程三大核心问题.html#为什么会有可见性问题" class="sidebar-link">为什么会有可见性问题？</a></li></ul></li><li class="sidebar-sub-header"><a href="/thread/并发编程三大核心问题.html#原子性" class="sidebar-link">原子性</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/thread/并发编程三大核心问题.html#原子性是什么" class="sidebar-link">原子性是什么？</a></li><li class="sidebar-sub-header"><a href="/thread/并发编程三大核心问题.html#为什么会有原子性问题" class="sidebar-link">为什么会有原子性问题？</a></li><li class="sidebar-sub-header"><a href="/thread/并发编程三大核心问题.html#线程切换带来原子性问题。" class="sidebar-link">线程切换带来原子性问题。</a></li><li class="sidebar-sub-header"><a href="/thread/并发编程三大核心问题.html#原子性问题举例" class="sidebar-link">原子性问题举例</a></li></ul></li><li class="sidebar-sub-header"><a href="/thread/并发编程三大核心问题.html#有序性" class="sidebar-link">有序性</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/thread/并发编程三大核心问题.html#有序性问题举例" class="sidebar-link">有序性问题举例</a></li></ul></li><li class="sidebar-sub-header"><a href="/thread/并发编程三大核心问题.html#总结" class="sidebar-link">总结</a></li></ul></li><li><a href="/thread/深入理解线程池.html" class="sidebar-link">深入理解线程池</a></li><li><a href="/thread/线程池.html" class="sidebar-link">线程池</a></li><li><a href="/thread/并发编程-FutureTask.html" class="sidebar-link">并发编程-FutureTask</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>MySQL</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/mysql/索引.html" class="sidebar-link">索引</a></li><li><a href="/mysql/锁.html" class="sidebar-link">锁</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Redis</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/redis/持久化.html" class="sidebar-link">持久化</a></li><li><a href="/redis/分布式锁.html" class="sidebar-link">分布式锁</a></li><li><a href="/redis/Redis官方的高可用解决方案.html" class="sidebar-link">Redis官方的高可用解决方案</a></li><li><a href="/redis/数据库缓存最终一致性的四种方案.html" class="sidebar-link">数据库缓存最终一致性的四种方案</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Spring</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/spring/BeanFactory和FactoryBean的区别.html" class="sidebar-link">BeanFactory和FactoryBean的区别</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Mybatis</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/mybatis/MyBatis的SQL执行流程分析.html" class="sidebar-link">MyBatis的SQL执行流程分析</a></li><li><a href="/mybatis/MyBatisPlus.html" class="sidebar-link">MyBatisPlus</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>SpringBoot</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/springboot/SpringBoot经典学习笔记.html" class="sidebar-link">SpringBoot经典学习笔记</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Spring Cloud</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/springcloud/springcloud-黑马教程.html" class="sidebar-link">springcloud-黑马教程</a></li><li><a href="/springcloud/springcloud-day2.html" class="sidebar-link">springcloud-day2</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Netty</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/netty/Netty核心技术及源码剖析.html" class="sidebar-link">Netty核心技术及源码剖析</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>K8S</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/k8s/k8s-黑马.html" class="sidebar-link">k8s-黑马教程</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Linux</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/linux/Centos6.8安装mysql6.54.html" class="sidebar-link">Centos6.8安装mysql6.54</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>工具集</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/utils/完整的身份证正则表达式.html" class="sidebar-link">完整的身份证正则表达式</a></li><li><a href="/utils/Java自带工具方法.html" class="sidebar-link">Java自带工具方法</a></li></ul></section></li><li><a href="/about.html" class="sidebar-link">关于</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="并发编程三大问题-原子性、可见性、有序性。"><a href="#并发编程三大问题-原子性、可见性、有序性。" class="header-anchor">#</a> 并发编程三大问题：原子性、可见性、有序性。</h1> <h2 id="可见性"><a href="#可见性" class="header-anchor">#</a> 可见性</h2> <h3 id="可见性是什么"><a href="#可见性是什么" class="header-anchor">#</a> 可见性是什么？</h3> <p>一个线程对共享变量的修改，另外一个线程能够立刻看到，我们称为可见性。</p> <h3 id="为什么会有可见性问题"><a href="#为什么会有可见性问题" class="header-anchor">#</a> 为什么会有可见性问题？</h3> <p>对于如今的多核处理器，每颗CPU都有自己的缓存，而缓存仅仅对它所在的处理器可见，CPU缓存与内存的数据不容易保证一致。</p> <p>为了避免处理器停顿下来等待向内存写入数据而产生的延迟，处理器使用写缓冲区来临时保存向内存写入的数据。写缓冲区合并对同一内存地址的多次写，并以批处理的方式刷新，也就是说<strong>写缓冲区不会即时将数据刷新到主内存中</strong>。</p> <p><strong>缓存不能及时刷新导致了可见性问题。</strong></p> <p><strong>可见性问题举例</strong></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Test</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> a <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">increase</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        a<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">final</span> <span class="token class-name">Test</span> test <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> <span class="token number">1000</span><span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span>
                        test<span class="token punctuation">.</span><span class="token function">increase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">activeCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token comment">// 保证前面的线程都执行完</span>
            <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token keyword">yield</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>test<span class="token punctuation">.</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>目的：10个线程将inc加到10000。</p> <p>结果：每次运行，得到的结果都小于10000。</p> <p>原因分析：</p> <p><img src="data:image/png;base64,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" alt=""></p> <p>假设线程1和线程2同时开始执行，那么第一次都会将a=0 读到各自的CPU缓存里，线程1执行a++之后a=1，但是<strong>此时线程2是看不到线程1中a的值的</strong>，所以线程2里a=0，执行a++后a=1。</p> <p>线程1和线程2各自CPU缓存里的值都是1，之后线程1和线程2都会将自己缓存中的a=1写入内存，导致内存中a=1，而不是我们期望的2。所以导致最终 a 的值都是小于 10000 的。这就是缓存的可见性问题。</p> <h2 id="原子性"><a href="#原子性" class="header-anchor">#</a> 原子性</h2> <h3 id="原子性是什么"><a href="#原子性是什么" class="header-anchor">#</a> 原子性是什么？</h3> <p>把一个或者多个操作在 CPU 执行的过程中不被中断的特性称为原子性。</p> <p>在并发编程中，原子性的定义不应该和事务中的原子性（一旦代码运行异常可以回滚）一样。应该理解为：一段代码，或者一个变量的操作，在一个线程没有执行完之前，不能被其他线程执行。</p> <h3 id="为什么会有原子性问题"><a href="#为什么会有原子性问题" class="header-anchor">#</a> 为什么会有原子性问题？</h3> <p>线程是CPU调度的基本单位。CPU会根据不同的调度算法进行线程调度，将时间片分派给线程。当一个线程获得时间片之后开始执行，在时间片耗尽之后，就会失去CPU使用权。多线程场景下，由<strong>于时间片在线程间轮换，就会发生原子性问题</strong>。</p> <p>如：对于一段代码，一个线程还没执行完这段代码但是时间片耗尽，在等待CPU分配时间片，此时其他线程可以获取执行这段代码的时间片来执行这段代码，导致多个线程同时执行同一段代码，也就是原子性问题。</p> <h3 id="线程切换带来原子性问题。"><a href="#线程切换带来原子性问题。" class="header-anchor">#</a> <strong>线程切换带来原子性问题。</strong></h3> <p>在Java中，对基本数据类型的变量的读取和赋值操作是原子性操作，即这些操作是不可被中断的，要么执行，要么不执行。</p> <div class="language-java extra-class"><pre class="language-java"><code>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>		<span class="token comment">// 原子性操作</span>
j <span class="token operator">=</span> i<span class="token punctuation">;</span>		<span class="token comment">// 不是原子性操作，包含了两个操作：读取i，将i值赋值给j</span>
i<span class="token operator">++</span><span class="token punctuation">;</span> 			<span class="token comment">// 不是原子性操作，包含了三个操作：读取i值、i + 1 、将+1结果赋值给i</span>
i <span class="token operator">=</span> j <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>		<span class="token comment">// 不是原子性操作，包含了三个操作：读取j值、j + 1 、将+1结果赋值给i</span>

</code></pre></div><h3 id="原子性问题举例"><a href="#原子性问题举例" class="header-anchor">#</a> 原子性问题举例</h3> <p>还是上文中的代码，10个线程将inc加到10000。假设在保证可见性的情况下，仍然会因为原子性问题导致执行结果达不到预期。为方便看，把代码贴到这里：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Test</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> a <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">increase</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        a<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">final</span> <span class="token class-name">Test</span> test <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> <span class="token number">1000</span><span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span>
                        test<span class="token punctuation">.</span><span class="token function">increase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">activeCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token comment">// 保证前面的线程都执行完</span>
            <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token keyword">yield</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>test<span class="token punctuation">.</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>目的：10个线程将inc加到10000。
结果：每次运行，得到的结果都小于10000。</p> <p>原因分析：</p> <blockquote><p>首先来看a++操作，其实包括三个操作：</p> <p>①读取a=0;</p> <p>②计算0+1=1;</p> <p>③将1赋值给a;</p> <p>保证a++的原子性，就是保证这三个操作在一个线程没有执行完之前，不能被其他线程执行。</p></blockquote> <p>实际执行时序图如下：</p> <p><img src="/assets/img/20210713002.576a5207.png" alt=""></p> <p>关键一步：线程2在读取a的值时，线程1还没有完成a=1的赋值操作，导致线程2的计算结果也是a=1。</p> <p><strong>问题在于没有保证a++操作的原子性</strong>。如果保证a++的原子性，线程1在执行完三个操作之前，线程2不能执行a++，那么就可以保证在线程2执行a++时，读取到a=1，从而得到正确的结果。</p> <h2 id="有序性"><a href="#有序性" class="header-anchor">#</a> 有序性</h2> <p>有序性：程序执行的顺序按照代码的先后顺序执行。</p> <p>编译器为了优化性能，有时候会改变程序中语句的先后顺序。例如程序中：“a=6；b=7；”编译器优化后可能变成“b=7；a=6；”，在这个例子中，编译器调整了语句的顺序，但是不影响程序的最终结果。不过有时候编译器及解释器的优化可能导致意想不到的Bug。</p> <h3 id="有序性问题举例"><a href="#有序性问题举例" class="header-anchor">#</a> 有序性问题举例</h3> <p>Java中的一个经典的案例：利用双重检查创建单例对象</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Singleton</span> <span class="token punctuation">{</span>
  <span class="token keyword">static</span> <span class="token class-name">Singleton</span> instance<span class="token punctuation">;</span>
  <span class="token keyword">static</span> <span class="token class-name">Singleton</span> <span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>instance <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">synchronized</span><span class="token punctuation">(</span><span class="token class-name">Singleton</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>instance <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
          instance <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Singleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> instance<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>在获取实例getInstance()的方法中，我们首先判断 instance是否为空，如果为空，则锁定 Singleton.class并再次检查instance是否为空，如果还为空则创建Singleton的一个实例。
看似很完美，既保证了线程完全的初始化单例，又经过判断instance为null时再用synchronized同步加锁。但是还有问题！</p> <p><code>instance = new Singleton();</code> 创建对象的代码，分为三步：
①分配内存空间
②初始化对象Singleton
③将内存空间的地址赋值给instance</p> <p>但是这三步经过重排之后：
①分配内存空间
②将内存空间的地址赋值给instance
③初始化对象Singleton</p> <p>会导致什么结果呢？</p> <p>线程A先执行getInstance()方法，当执行完指令②时恰好发生了线程切换，切换到了线程B上；如果此时线程B也执行getInstance()方法，那么线程B在执行第一个判断时会发现instance!=null，所以直接返回instance，而此时的instance是没有初始化过的，如果我们这个时候访问instance的成员变量就可能触发空指针异常。</p> <p>执行时序图：</p> <p><img src="data:image/png;base64,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" alt=""></p> <h2 id="总结"><a href="#总结" class="header-anchor">#</a> 总结</h2> <p>并发编程的本质就是解决三大问题：原子性、可见性、有序性。</p> <p>原子性：一个或者多个操作在 CPU 执行的过程中不被中断的特性。由于线程的切换，导致多个线程同时执行同一段代码，带来的原子性问题。</p> <p>可见性：一个线程对共享变量的修改，另外一个线程能够立刻看到。缓存不能及时刷新导致了可见性问题。</p> <p>有序性：程序执行的顺序按照代码的先后顺序执行。编译器为了优化性能而改变程序中语句的先后顺序，导致有序性问题。</p> <p>启发：线程的切换、缓存及编译优化都是为了提高性能，但是引发了并发编程的问题。这也告诉我们技术在解决一个问题时，必然会带来另一个问题，需要我们提前考虑新技术带来的问题以规避风险。</p> <div class="custom-block tip"><p class="custom-block-title">来源</p> <p>来源： <a href="https://mp.weixin.qq.com/s?__biz=MzAxMjEwMzQ5MA==&amp;mid=2448888446&amp;idx=2&amp;sn=2d341878615e238eb572e855199b9a7e&amp;scene=21#wechat_redirect" target="_blank" rel="noopener noreferrer">java进阶架构师<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></div></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/bar/four.html" class="prev">
        JVM实战
      </a></span> <span class="next"><a href="/thread/深入理解线程池.html">
        深入理解线程池
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.939029db.js" defer></script><script src="/assets/js/5.a0d7f1b0.js" defer></script><script src="/assets/js/13.f2ff2520.js" defer></script>
  </body>
</html>
