<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>MyBatis的SQL执行流程分析 | JavaPool</title>
    <meta name="generator" content="VuePress 1.8.2">
    
    <meta name="description" content="java poll icu">
    
    <link rel="preload" href="/assets/css/0.styles.f5fa7e15.css" as="style"><link rel="preload" href="/assets/js/app.939029db.js" as="script"><link rel="preload" href="/assets/js/5.a0d7f1b0.js" as="script"><link rel="preload" href="/assets/js/4.5de2ab9a.js" as="script"><link rel="prefetch" href="/assets/js/10.4930db7c.js"><link rel="prefetch" href="/assets/js/11.664c83f6.js"><link rel="prefetch" href="/assets/js/12.b07b045c.js"><link rel="prefetch" href="/assets/js/13.f2ff2520.js"><link rel="prefetch" href="/assets/js/14.6e22c037.js"><link rel="prefetch" href="/assets/js/15.e1312efe.js"><link rel="prefetch" href="/assets/js/16.1cf74602.js"><link rel="prefetch" href="/assets/js/17.b9e8e731.js"><link rel="prefetch" href="/assets/js/18.dcd2a204.js"><link rel="prefetch" href="/assets/js/19.0c0ab762.js"><link rel="prefetch" href="/assets/js/2.dc8fbfc9.js"><link rel="prefetch" href="/assets/js/20.302be875.js"><link rel="prefetch" href="/assets/js/21.84065760.js"><link rel="prefetch" href="/assets/js/22.a772e2e0.js"><link rel="prefetch" href="/assets/js/23.405a3f6d.js"><link rel="prefetch" href="/assets/js/24.cdf49edf.js"><link rel="prefetch" href="/assets/js/25.661bff2a.js"><link rel="prefetch" href="/assets/js/26.e54d2e81.js"><link rel="prefetch" href="/assets/js/27.21badb7b.js"><link rel="prefetch" href="/assets/js/28.abf47a58.js"><link rel="prefetch" href="/assets/js/29.31368a4c.js"><link rel="prefetch" href="/assets/js/3.b22e8034.js"><link rel="prefetch" href="/assets/js/30.2b3fec8b.js"><link rel="prefetch" href="/assets/js/31.127d34fd.js"><link rel="prefetch" href="/assets/js/32.bb536940.js"><link rel="prefetch" href="/assets/js/33.6bb10321.js"><link rel="prefetch" href="/assets/js/34.196e9342.js"><link rel="prefetch" href="/assets/js/35.91f5e2d7.js"><link rel="prefetch" href="/assets/js/36.44bd11af.js"><link rel="prefetch" href="/assets/js/37.2196b9db.js"><link rel="prefetch" href="/assets/js/38.b5fc08ca.js"><link rel="prefetch" href="/assets/js/39.1d39e635.js"><link rel="prefetch" href="/assets/js/40.6a4052db.js"><link rel="prefetch" href="/assets/js/41.74a36917.js"><link rel="prefetch" href="/assets/js/42.c5e0d73e.js"><link rel="prefetch" href="/assets/js/43.eefece58.js"><link rel="prefetch" href="/assets/js/44.99992d39.js"><link rel="prefetch" href="/assets/js/45.f9d650f6.js"><link rel="prefetch" href="/assets/js/46.2470e152.js"><link rel="prefetch" href="/assets/js/47.a03f8573.js"><link rel="prefetch" href="/assets/js/48.130f4e32.js"><link rel="prefetch" href="/assets/js/49.e3515dad.js"><link rel="prefetch" href="/assets/js/50.901c44c5.js"><link rel="prefetch" href="/assets/js/51.a01a4d9e.js"><link rel="prefetch" href="/assets/js/52.35a59463.js"><link rel="prefetch" href="/assets/js/6.f9f76ed6.js"><link rel="prefetch" href="/assets/js/7.f65121c9.js"><link rel="prefetch" href="/assets/js/8.6fa13a5d.js"><link rel="prefetch" href="/assets/js/9.f9cb8b5e.js">
    <link rel="stylesheet" href="/assets/css/0.styles.f5fa7e15.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">JavaPool</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <!----></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><!---->  <ul class="sidebar-links"><li><a href="/" aria-current="page" class="sidebar-link">首页</a></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>基础</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/basics/反射.html" class="sidebar-link">反射</a></li><li><a href="/basics/注解.html" class="sidebar-link">注解</a></li><li><a href="/basics/枚举.html" class="sidebar-link">枚举</a></li><li><a href="/basics/IO.html" class="sidebar-link">IO</a></li><li><a href="/basics/集合.html" class="sidebar-link">集合</a></li><li><a href="/basics/异常.html" class="sidebar-link">异常</a></li><li><a href="/basics/拦截器.html" class="sidebar-link">拦截器</a></li><li><a href="/basics/过虑器.html" class="sidebar-link">过虑器</a></li><li><a href="/basics/jdk8.html" class="sidebar-link">jdk8</a></li><li><a href="/basics/Java8-Lambda.html" class="sidebar-link">Java8-Lambda</a></li><li><a href="/basics/Java8-Stream.html" class="sidebar-link">Java8-Stream</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>设计模式</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/designpattern/黑马-设计模式.html" class="sidebar-link">黑马-设计模式</a></li><li><a href="/designpattern/UML.html" class="sidebar-link">UML类图</a></li><li><a href="/designpattern/七大原则.html" class="sidebar-link">七大原则</a></li><li><a href="/designpattern/23种设计模式.html" class="sidebar-link">23种设计模式</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>JVM</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/bar/three.html" class="sidebar-link">JVM基础概念</a></li><li><a href="/bar/four.html" class="sidebar-link">JVM实战</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>并发多线程</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/thread/并发编程三大核心问题.html" class="sidebar-link">并发编程三大核心问题</a></li><li><a href="/thread/深入理解线程池.html" class="sidebar-link">深入理解线程池</a></li><li><a href="/thread/线程池.html" class="sidebar-link">线程池</a></li><li><a href="/thread/并发编程-FutureTask.html" class="sidebar-link">并发编程-FutureTask</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>MySQL</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/mysql/索引.html" class="sidebar-link">索引</a></li><li><a href="/mysql/锁.html" class="sidebar-link">锁</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Redis</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/redis/持久化.html" class="sidebar-link">持久化</a></li><li><a href="/redis/分布式锁.html" class="sidebar-link">分布式锁</a></li><li><a href="/redis/Redis官方的高可用解决方案.html" class="sidebar-link">Redis官方的高可用解决方案</a></li><li><a href="/redis/数据库缓存最终一致性的四种方案.html" class="sidebar-link">数据库缓存最终一致性的四种方案</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Spring</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/spring/BeanFactory和FactoryBean的区别.html" class="sidebar-link">BeanFactory和FactoryBean的区别</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Mybatis</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/mybatis/MyBatis的SQL执行流程分析.html" class="active sidebar-link">MyBatis的SQL执行流程分析</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/mybatis/MyBatis的SQL执行流程分析.html#前言" class="sidebar-link">前言</a></li><li class="sidebar-sub-header"><a href="/mybatis/MyBatis的SQL执行流程分析.html#概要" class="sidebar-link">概要</a></li><li class="sidebar-sub-header"><a href="/mybatis/MyBatis的SQL执行流程分析.html#获取mapper接口-getmapper" class="sidebar-link">获取Mapper接口(getMapper)</a></li><li class="sidebar-sub-header"><a href="/mybatis/MyBatis的SQL执行流程分析.html#mapper接口和映射文件是何时关联的" class="sidebar-link">Mapper接口和映射文件是何时关联的</a></li><li class="sidebar-sub-header"><a href="/mybatis/MyBatis的SQL执行流程分析.html#sql执行流程分析" class="sidebar-link">sql执行流程分析</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/mybatis/MyBatis的SQL执行流程分析.html#寻找sql" class="sidebar-link">寻找sql</a></li></ul></li><li class="sidebar-sub-header"><a href="/mybatis/MyBatis的SQL执行流程分析.html#执行sql语句" class="sidebar-link">执行sql语句</a></li><li class="sidebar-sub-header"><a href="/mybatis/MyBatis的SQL执行流程分析.html#参数映射" class="sidebar-link">参数映射</a></li><li class="sidebar-sub-header"><a href="/mybatis/MyBatis的SQL执行流程分析.html#自定义typehandler" class="sidebar-link">自定义typeHandler</a></li><li class="sidebar-sub-header"><a href="/mybatis/MyBatis的SQL执行流程分析.html#结果集映射" class="sidebar-link">结果集映射</a></li><li class="sidebar-sub-header"><a href="/mybatis/MyBatis的SQL执行流程分析.html#自定义typehandler结果集" class="sidebar-link">自定义typeHandler结果集</a></li><li class="sidebar-sub-header"><a href="/mybatis/MyBatis的SQL执行流程分析.html#工作流程图" class="sidebar-link">工作流程图</a></li></ul></li><li><a href="/mybatis/MyBatisPlus.html" class="sidebar-link">MyBatisPlus</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>SpringBoot</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/springboot/SpringBoot经典学习笔记.html" class="sidebar-link">SpringBoot经典学习笔记</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Spring Cloud</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/springcloud/springcloud-黑马教程.html" class="sidebar-link">springcloud-黑马教程</a></li><li><a href="/springcloud/springcloud-day2.html" class="sidebar-link">springcloud-day2</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Netty</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/netty/Netty核心技术及源码剖析.html" class="sidebar-link">Netty核心技术及源码剖析</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>K8S</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/k8s/k8s-黑马.html" class="sidebar-link">k8s-黑马教程</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Linux</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/linux/Centos6.8安装mysql6.54.html" class="sidebar-link">Centos6.8安装mysql6.54</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>工具集</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/utils/完整的身份证正则表达式.html" class="sidebar-link">完整的身份证正则表达式</a></li><li><a href="/utils/Java自带工具方法.html" class="sidebar-link">Java自带工具方法</a></li></ul></section></li><li><a href="/about.html" class="sidebar-link">关于</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="mybatis的sql执行流程分析"><a href="#mybatis的sql执行流程分析" class="header-anchor">#</a> MyBatis的SQL执行流程分析</h1> <h2 id="前言"><a href="#前言" class="header-anchor">#</a> 前言</h2> <p>MyBatis可能很多人都一直在用，但是MyBatis的SQL执行流程可能并不是所有人都清楚了，那么既然进来了，通读本文你将收获如下：</p> <p>1、Mapper接口和映射文件是如何进行绑定的
2、MyBatis中SQL语句的执行流程
3、自定义MyBatis中的参数设置处理器typeHandler
4、自定义MyBatis中结果集处理器typeHandler</p> <p>PS：本文基于MyBatis3.5.5版本源码</p> <h2 id="概要"><a href="#概要" class="header-anchor">#</a> 概要</h2> <p>在MyBatis中，利用编程式进行数据查询，主要就是下面几行代码：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">SqlSession</span> session <span class="token operator">=</span> sqlSessionFactory<span class="token punctuation">.</span><span class="token function">openSession</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">UserMapper</span> userMapper <span class="token operator">=</span> session<span class="token punctuation">.</span><span class="token function">getMapper</span><span class="token punctuation">(</span><span class="token class-name">UserMapper</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">LwUser</span><span class="token punctuation">&gt;</span></span> userList <span class="token operator">=</span> userMapper<span class="token punctuation">.</span><span class="token function">listUserByUserName</span><span class="token punctuation">(</span><span class="token string">&quot;孤狼1号&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>第一行是获取一个SqlSession对象，第二行就是获取UserMapper接口，第三行一行代码就实现了整个查询语句的流程，接下来我们就来仔细分析一下第二和第三步。</p> <h2 id="获取mapper接口-getmapper"><a href="#获取mapper接口-getmapper" class="header-anchor">#</a> 获取Mapper接口(getMapper)</h2> <p>第二步是通过SqlSession对象是获取一个Mapper接口，这个流程还是相对简单的，下面就是我们调用session.getMapper方法之后的运行时序图：</p> <p><img src="/assets/img/20210713001.99509be7.png" alt="20210713001.png"></p> <p>1、在调用getMapper之后，会去Configuration对象中获取Mapper对象，因为在项目启动的时候就会把Mapper接口加载并解析存储到Configuration对象</p> <p><img src="/assets/img/20210713002.98ba6db4.png" alt="20210713002.png"></p> <p>2、通过Configuration对象中的MapperRegistry对象属性，继续调用getMapper方法</p> <p><img src="/assets/img/20210713003.c236842e.png" alt="20210713003.png"></p> <p>3、根据type类型，从MapperRegistry对象中的knownMappers获取到当前类型对应的代理工厂类，然后通过代理工厂类生成对应Mapper的代理类</p> <p><img src="/assets/img/20210713004.81fe3e73.png" alt="20210713004.png"></p> <p>4、最终获取到我们接口对应的代理类MapperProxy对象</p> <p><img src="/assets/img/20210713004-1.a00784aa.png" alt="20210713004-1.png"></p> <p>而MapperProxy可以看到实现了InvocationHandler，使用的就是JDK动态代理。</p> <p><img src="/assets/img/20210713005.f8372571.png" alt="20210713005.png"></p> <p>至此获取Mapper流程结束了，那么就有一个问题了MapperRegistry对象内的HashMap属性knownMappers中的数据是什么时候存进去的呢？</p> <h2 id="mapper接口和映射文件是何时关联的"><a href="#mapper接口和映射文件是何时关联的" class="header-anchor">#</a> Mapper接口和映射文件是何时关联的</h2> <p>Mapper接口及其映射文件是在加载mybatis-config配置文件的时候存储进去的，下面就是时序图：</p> <p><img src="/assets/img/20210713006.ecbd81e4.png" alt="20210713006.png"></p> <p>1、首先我们会手动调用SqlSessionFactoryBuilder方法中的build()方法：</p> <p><img src="/assets/img/20210713007.62c3f901.png" alt="20210713007.png"></p> <p>2、然后会构造一个XMLConfigBuilder对象，并调用其parse方法：</p> <p><img src="/assets/img/20210713008.52319c05.png" alt="图片"></p> <p>3、然后会继续调用自己的parseConfiguration来解析配置文件，这里面就会分别去解析全局配置文件的顶级节点，其他的我们先不看，我们直接看最后解析mappers节点</p> <p><img src="/assets/img/20210713009.df11ce27.png" alt="图片"></p> <p>4、继续调用自己的mapperElement来解析mappers文件（这个方法比较长，为了方便截图完整，所以把字体缩小了1号），可以看到，这里面分了四种方式来解析mappers节点的配置，对应了4种mapper配置方式，而其中红框内的两种方式是直接配置的xml映射文件，蓝框内的两种方式是解析直接配置Mapper接口的方式，从这里也可以说明，不论配置哪种方式，最终MyBatis都会将xml映射文件和Mapper接口进行关联。</p> <p><img src="/assets/img/20210713010.89fd3ab4.png" alt="图片"></p> <p>5、我们先看第2种和第3中（直接配置xml映射文件的解析方式），会构建一个XMLMapperBuilder对象并调用其parse方法。</p> <p><img src="/assets/img/20210713011.e6e920bb.png" alt="图片"></p> <p>但是这里有一个问题，如果有多重继承或者多重依赖时在这里是可能会无法被完全解析的，比如说三个映射文件互相依赖，那么if里面(假设是最坏情况)只能加载1个，失败2个，然后走到下面if之外的代码又只能加载1个，还有1个会失败(如下代码中，只会处理1次，再次失败并不会继续加入incompleteResultMaps)：</p> <p><img src="/assets/img/20210713012.9de28d64.png" alt="图片"></p> <p>当然，这个还是会被解析的，后面执行查询的时候会再次通过不断遍历去全部解析完毕，不过有一点需要注意的是，互相引用这种是会导致解析失败报错的，所以在开发过程中我们应该避免循环依赖的产生。
6、解析完映射文件之后，调用自身方法bindMapperForNamespace，开始绑定Mapper接口和映射文件：</p> <p><img src="/assets/img/20210713013.58cde3be.png" alt="图片"></p> <p>7、调用Configuration对象的addMapper</p> <p><img src="/assets/img/20210713014.922afc1e.png" alt="图片"></p> <p>8、调用Configuration对象的属性MapperRegistry内的addMapper方法，这个方法就是正式将Mapper接口添加到knownMappers，所以上面getMapper可以直接获取：</p> <p><img src="/assets/img/20210713015.cc9bfba7.png" alt="图片"></p> <p>到这里我们就完成了Mapper接口和xml映射文件的绑定
9、注意上面红框里面的代码，又调用了一次parse方法，这个parse方法主要是解析注解，比如下面的语句：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Select</span><span class="token punctuation">(</span><span class="token string">&quot;select * from lw_user&quot;</span><span class="token punctuation">)</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">LwUser</span><span class="token punctuation">&gt;</span></span> <span class="token function">listAllUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>所以这个方法里面会去解析@Select等注解，需要注意的是，parse方法里面会同时再解析一次xml映射文件，因为上面我们提到了mappers节点有4种配置方式，其中两种配置的是Mapper接口，而配置Mapper接口会直接先调用addMapper接口，并没有解析映射文件，所以进入注解解析方法parse之中会需要再尝试解析一次XML映射文件。</p> <p><img src="/assets/img/20210713016.d731580e.png" alt="图片"></p> <p>解析完成之后，还会对Mapper接口中的方法进行解析，并将<strong>每个方法的全限定类名作为key</strong>存入存入Configuration中的mappedStatements属性。</p> <p>需要指出的是，这里存储的时候，同一个value会存储2次，<strong>一个全限定名作为key，另一个就是只用方法名(sql语句的id)来作为key：</strong></p> <p><img src="/assets/img/20210713017.f807622c.png" alt="图片"></p> <p>所以最终mappedStatements会是下面的情况：</p> <p><img src="/assets/img/20210713018.9676809c.png" alt="图片"></p> <p>事实上如果我们通过接口的方式来编程的话，最后来getStatement的时候，都是根据全限定名来取的，所以即使有重名对我们也没有影响，而之所以要这么做的原因其实还是为了兼容早期版本的用法，那就是不通过接口，而是直接通过方法名的方式来进行查询：</p> <div class="language-java extra-class"><pre class="language-java"><code>session<span class="token punctuation">.</span><span class="token function">selectList</span><span class="token punctuation">(</span><span class="token string">&quot;com.lonelyWolf.mybatis.mapper.UserMapper.listAllUser&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>这里如果shortName没有重复的话，是可以直接通过简写来查询的：</p> <div class="language-java extra-class"><pre class="language-java"><code>session<span class="token punctuation">.</span><span class="token function">selectList</span><span class="token punctuation">(</span><span class="token string">&quot;listAllUser&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>但是通过简写来查询一旦shortName重复了就会抛出以下异常：</p> <p><img src="/assets/img/20210713019.81e7b735.png" alt="图片"></p> <p>这里的异常其实就是StrickMap的get方法抛出来的：</p> <p><img src="/assets/img/20210713020.1fcbaba8.png" alt="图片"></p> <h2 id="sql执行流程分析"><a href="#sql执行流程分析" class="header-anchor">#</a> sql执行流程分析</h2> <p>上面我们讲到了，获取到的Mapper接口实际上被包装成为了代理对象，所以我们执行查询语句肯定是执行的代理对象方法，接下来我们就以Mapper接口的代理对象MapperProxy来分析一下查询流程。</p> <p>整个sql执行流程可以分为两大步骤：</p> <p>一、寻找sql
二、执行sql语句</p> <h3 id="寻找sql"><a href="#寻找sql" class="header-anchor">#</a> 寻找sql</h3> <p>首先还是来看一下寻找sql语句的时序图：</p> <p><img src="/assets/img/20210713021.98467366.png" alt="图片"></p> <p>1、了解代理模式的应该都知道，调用被代理对象的方法之后实际上执行的就是代理对象的invoke方法</p> <p><img src="/assets/img/20210713022.16951ca7.png" alt="图片"></p> <p>2、因为我们这里并没有调用Object类中的方法，所以肯定走的else。else中会继续调用MapperProxy内部类MapperMethodInvoker中的方法cachedInvoker，这里面会有一个判断，判断一下我们是不是default方法，因为Jdk1.8中接口中可以新增default方法，而default方法是并不是一个抽象方法，所以也需要特殊处理（刚开始会从缓存里面取，缓存相关知识我们这里先不讲，后面会单独写一篇来分析一下缓存)）。</p> <p><img src="/assets/img/20210713023.9abca5d0.png" alt="图片"></p> <p>3、接下来，是构造一个MapperMethod对象,这个对象封装了Mapper接口中对应的方法信息以及对应的sql语句信息：</p> <p><img src="/assets/img/20210713024.af63847b.png" alt="图片"></p> <p>这里面就会把要执行的sql语句，请求参数，方法返回值全部解析封装成MapperMethod对象，然后后面就可以开始准备执行sql语句了</p> <h2 id="执行sql语句"><a href="#执行sql语句" class="header-anchor">#</a> 执行sql语句</h2> <p>还是先来看一下执行Sql语句的时序图：</p> <p><img src="/assets/img/20210713025.c5f44ce7.png" alt="图片"></p> <p>1、我们继续上面的流程进入execute方法：</p> <p><img src="/assets/img/20210713026.91c9fbef.png" alt="图片"></p> <p>2、这里面会根据语句类型以及返回值类型来决定如何执行，本人这里返回的是一个集合，故而我们进入executeForMany方法：</p> <p><img src="/assets/img/20210713027.ebe15e45.png" alt="图片"></p> <p>3、这里面首先会将前面存好的参数进行一次转换，然后绕了这么一圈，回到了起点SqlSession对象，继续调用selectList方法：</p> <p><img src="/assets/img/20210713028.4ff43ec9.png" alt="图片"></p> <p>3、接下来又讲流程委派给了Execute去执行query方法，最终又会去调用queryFromDatabase方法：</p> <p><img src="/assets/img/20210713029.c623b29b.png" alt="图片"></p> <p>4、到这里之后，终于要进入正题了，一般带了这种do开头的方法就是真正做事的，Spring中很多地方也是采用的这种命名方式：</p> <p><img src="/assets/img/20210713030.9bbc6425.png" alt="图片"></p> <p>注意，前面我们的sql语句还是占位符的方式，并没有将参数设置进去，所以这里在return上面一行调用prepareStatement方法创建Statement对象的时候会去设置参数，替换占位符。参数如何设置我们先跳过，等把流程执行完了我们在单独分析参数映射和结果集映射。</p> <p>5、继续进入PreparedStatementHandler对象的query方法，可以看到，这一步就是调用了jdbc操作对象PreparedStatement中的execute方法，最后一步就是转换结果集然后返回。</p> <p><img src="/assets/img/20210713031.de947f56.png" alt="图片"></p> <p>到这里，整个SQL语句执行流程分析就结束了，中途有一些参数的存储以及转换并没有深入进去，因为参数的转换并不是核心，只要清楚整个数据的流转流程，我们自己也可以有自己的实现方式，只要存起来最后我们能重新解析读出来就行。</p> <h2 id="参数映射"><a href="#参数映射" class="header-anchor">#</a> 参数映射</h2> <p>现在我们来看一下上面在执行查询之前参数是如何进行设置的，我们先进入prepareStatement方法：</p> <p><img src="/assets/img/20210713032.c8ccef8b.png" alt="图片"></p> <p>我们发现，最终是调用了StatementHandler中的parameterize进行参数设置，接下来这里为了节省篇幅，我们不会一步步点进去，直接进入设置参数的方法：</p> <p><img src="/assets/img/20210713033.07f1c1cb.png" alt="图片"></p> <p>上面的BaseTypeHandler是一个抽象类，setNonNullParameter并没有实现，都是交给子类去实现，而每一个子类就是对应了数据库的一种类型。下图中就是默认的一个子类StringTypeHandler，里面没什么其他逻辑，就是设置参数。</p> <p><img src="/assets/img/20210713034.08333626.png" alt="图片"></p> <p>可以看到String里面调用了jdbc中的setString方法，而如果是int也会调用setInt方法。
看到这些子类如果大家之前阅读过我前面讲的MyBatis参数配置，应该就很明显可以知道，这些子类就是系统默认提供的一些typeHandler。而这些默认的typeHandler会默认被注册并和Java对象进行绑定：</p> <p><img src="/assets/img/20210713035.1b4dd4ac.png" alt="图片"></p> <p>正是因为MyBatis中默认提供了常用数据类型的映射，所以我们写Sql的时候才可以省略参数映射关系，可以直接采用下面的方式，系统可以根据我们参数的类型，自动选择合适的typeHander进行映射：</p> <div class="language-java extra-class"><pre class="language-java"><code>select user_id<span class="token punctuation">,</span>user_name from lw_user where user_name<span class="token operator">=</span>#<span class="token punctuation">{</span>userName<span class="token punctuation">}</span>
</code></pre></div><p>上面这条语句实际上和下面这条是等价的：</p> <div class="language-java extra-class"><pre class="language-java"><code>select user_id<span class="token punctuation">,</span>user_name from lw_user where user_name<span class="token operator">=</span>#<span class="token punctuation">{</span>userName<span class="token punctuation">,</span>jdbcType<span class="token operator">=</span>VARCHAR<span class="token punctuation">}</span>
</code></pre></div><p>或者说我们可以直接指定typeHandler：</p> <div class="language-java extra-class"><pre class="language-java"><code>select user_id<span class="token punctuation">,</span>user_name from lw_user where user_name<span class="token operator">=</span>#<span class="token punctuation">{</span>userName<span class="token punctuation">,</span>jdbcType<span class="token operator">=</span>VARCHAR<span class="token punctuation">,</span>typeHandler<span class="token operator">=</span><span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>ibatis<span class="token punctuation">.</span>type<span class="token punctuation">.</span></span>IntegerTypeHandler</span><span class="token punctuation">}</span>
</code></pre></div><p>这里因为我们配置了typeHandler，所以会优先以配置的typeHandler为主不会再去读取默认的映射，如果类型不匹配就会直接报错了：</p> <p><img src="/assets/img/20210713036.5e779044.png" alt="图片"></p> <p>看到这里很多人应该就知道了，如果我们自己自定义一个typeHandler，然后就可以配置成我们自己的自定义类。
所以接下来就让我们看看如何自定义一个typeHandler</p> <h2 id="自定义typehandler"><a href="#自定义typehandler" class="header-anchor">#</a> 自定义typeHandler</h2> <p>自定义typeHandler需要实现BaseTypeHandler接口，BaseTypeHandler有4个方法，包括结果集映射，为了节省篇幅，代码没有写上来：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>lonelyWolf<span class="token punctuation">.</span>mybatis<span class="token punctuation">.</span>typeHandler</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>ibatis<span class="token punctuation">.</span>type<span class="token punctuation">.</span></span><span class="token class-name">BaseTypeHandler</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>ibatis<span class="token punctuation">.</span>type<span class="token punctuation">.</span></span><span class="token class-name">JdbcType</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>sql<span class="token punctuation">.</span></span><span class="token class-name">CallableStatement</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>sql<span class="token punctuation">.</span></span><span class="token class-name">PreparedStatement</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>sql<span class="token punctuation">.</span></span><span class="token class-name">ResultSet</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>sql<span class="token punctuation">.</span></span><span class="token class-name">SQLException</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyTypeHandler</span> <span class="token keyword">extends</span> <span class="token class-name">BaseTypeHandler</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>

<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setNonNullParameter</span><span class="token punctuation">(</span><span class="token class-name">PreparedStatement</span> preparedStatement<span class="token punctuation">,</span> <span class="token keyword">int</span> index<span class="token punctuation">,</span> <span class="token class-name">String</span> param<span class="token punctuation">,</span> <span class="token class-name">JdbcType</span> jdbcType<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">SQLException</span> <span class="token punctuation">{</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;自定义typeHandler生效了&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    preparedStatement<span class="token punctuation">.</span><span class="token function">setString</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span>param<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


</code></pre></div><p>然后我们改写一下上面的查询语句：</p> <div class="language-java extra-class"><pre class="language-java"><code>select user_id<span class="token punctuation">,</span>user_name from lw_user where user_name<span class="token operator">=</span>#<span class="token punctuation">{</span>userName<span class="token punctuation">,</span>jdbcType<span class="token operator">=</span>VARCHAR<span class="token punctuation">,</span>typeHandler<span class="token operator">=</span><span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>lonelyWolf<span class="token punctuation">.</span>mybatis<span class="token punctuation">.</span>typeHandler<span class="token punctuation">.</span></span>MyTypeHandler</span><span class="token punctuation">}</span>
</code></pre></div><p>然后执行，可以看到，自定义的typeHandler生效了：</p> <p><img src="/assets/img/20210713037.ebda472a.png" alt="图片"></p> <h2 id="结果集映射"><a href="#结果集映射" class="header-anchor">#</a> 结果集映射</h2> <p>接下来让我们看看结果集的映射，回到上面执行sql流程的最后一个方法：</p> <div class="language-java extra-class"><pre class="language-java"><code>resultSetHandler<span class="token punctuation">.</span><span class="token function">handleResultSets</span><span class="token punctuation">(</span>ps<span class="token punctuation">)</span>
</code></pre></div><p>结果集映射里面的逻辑相对来说还是挺复杂的，因为要考虑到非常多的情况，这里我们就不会去深究每一个细节，直接进入到正式解析结果集的代码，下面的5个代码片段就是一个简单的但是完整的解析流程：</p> <p><img src="/assets/img/20210713038.46246046.png" alt="图片"></p> <p><img src="/assets/img/20210713039.61dd6ff5.png" alt="图片"></p> <p><img src="/assets/img/20210713040.fd701f26.png" alt="图片"></p> <p><img src="/assets/img/20210713041.33120011.png" alt="图片"></p> <p><img src="/assets/img/20210713042.cc531528.png" alt="图片"></p> <p>从上面的代码片段我们也可以看到，实际上解析结果集还是很复杂的，就如我们上一篇介绍的复杂查询一样，一个查询可以不断嵌套其他查询，还有延迟加载等等一些复杂的特性
的处理，所以逻辑分支是有很多，但是不管怎么处理，最后的核心还是上面的一套流程，最终还是会调用typeHandler来获取查询到的结果。</p> <p>是的，你没猜错，这个就是上面我们映射参数的typeHandler，因为typeHandler里面不只是一个设置参数方法，还有获取结果集方法(上面设置参数的时候省略了)。</p> <h2 id="自定义typehandler结果集"><a href="#自定义typehandler结果集" class="header-anchor">#</a> 自定义typeHandler结果集</h2> <p>所以说我们还是用上面那个MyTypeHandler 例子来重写一下取值方法(省略了设置参数方法)：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>lonelyWolf<span class="token punctuation">.</span>mybatis<span class="token punctuation">.</span>typeHandler</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>ibatis<span class="token punctuation">.</span>type<span class="token punctuation">.</span></span><span class="token class-name">BaseTypeHandler</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>ibatis<span class="token punctuation">.</span>type<span class="token punctuation">.</span></span><span class="token class-name">JdbcType</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>sql<span class="token punctuation">.</span></span><span class="token class-name">CallableStatement</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>sql<span class="token punctuation">.</span></span><span class="token class-name">PreparedStatement</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>sql<span class="token punctuation">.</span></span><span class="token class-name">ResultSet</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>sql<span class="token punctuation">.</span></span><span class="token class-name">SQLException</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyTypeHandler</span> <span class="token keyword">extends</span> <span class="token class-name">BaseTypeHandler</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>

    <span class="token comment">/**
     * 设置参数
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setNonNullParameter</span><span class="token punctuation">(</span><span class="token class-name">PreparedStatement</span> preparedStatement<span class="token punctuation">,</span> <span class="token keyword">int</span> index<span class="token punctuation">,</span> <span class="token class-name">String</span> param<span class="token punctuation">,</span> <span class="token class-name">JdbcType</span> jdbcType<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">SQLException</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;设置参数-&gt;自定义typeHandler生效了&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        preparedStatement<span class="token punctuation">.</span><span class="token function">setString</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span>param<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">/**
     * 根据列名获取结果
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getNullableResult</span><span class="token punctuation">(</span><span class="token class-name">ResultSet</span> resultSet<span class="token punctuation">,</span> <span class="token class-name">String</span> columnName<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">SQLException</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;根据columnName获取结果-&gt;自定义typeHandler生效了&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> resultSet<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span>columnName<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 根据列的下标来获取结果
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getNullableResult</span><span class="token punctuation">(</span><span class="token class-name">ResultSet</span> resultSet<span class="token punctuation">,</span> <span class="token keyword">int</span> columnIndex<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">SQLException</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;根据columnIndex获取结果-&gt;自定义typeHandler生效了&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> resultSet<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span>columnIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 处理存储过程的结果集
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getNullableResult</span><span class="token punctuation">(</span><span class="token class-name">CallableStatement</span> callableStatement<span class="token punctuation">,</span> <span class="token keyword">int</span> columnIndex<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">SQLException</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> callableStatement<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span>columnIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><p>改写Mapper映射文件配置：</p> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>resultMap</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>MyUserResultMap<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>lwUser<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>result</span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>user_id<span class="token punctuation">&quot;</span></span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>userId<span class="token punctuation">&quot;</span></span> <span class="token attr-name">jdbcType</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>VARCHAR<span class="token punctuation">&quot;</span></span> <span class="token attr-name">typeHandler</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>com.lonelyWolf.mybatis.typeHandler.MyTypeHandler<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>result</span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>user_name<span class="token punctuation">&quot;</span></span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>userName<span class="token punctuation">&quot;</span></span> <span class="token attr-name">jdbcType</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>VARCHAR<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>resultMap</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>执行之后输出如下：</p> <p><img src="/assets/img/20210713043.82a894d9.png" alt="图片"></p> <p>因为我们属性上面只配置了一个属性，所以只输出了一次。</p> <h2 id="工作流程图"><a href="#工作流程图" class="header-anchor">#</a> 工作流程图</h2> <p>上面介绍了代码的流转，可能绕来绕去有点晕，所以我们来画一个主要的对象之间流程图来更加清晰的展示一下MyBatis主要工作流程：</p> <p><img src="/assets/img/20210713044.206a5ef3.png" alt="图片"></p> <p>从上面的工作流程图上我们可以看到，SqlSession下面还有4大对象，这4大对象也很重要，后面学习拦截器的时候就是针对这4大对象进行的拦截，关于这4大对象的具体详情，我们下一篇文章再展开分析。</p> <p>总结
本文主要分析了MyBatis的SQL执行流程。在分析流程的过程中，我们也举例论证了如何自定义typeHandler来实现自定义的参数映射和结果集映射，不过MyBatis中提供的默认映射其实可以满足大部分的需求，如果我们对某些属性需要特殊处理，那么就可以采用自定义的typeHandle来实现，相信如果本文如果读懂了，以下几点大家应该至少会有一个清晰的认识：</p> <ul><li>Mapper接口和映射文件是如何进行绑定的</li> <li>MyBatis中SQL语句的执行流程</li> <li>自定义MyBatis中的参数设置处理器typeHandler</li> <li>自定义MyBatis中结果集处理器typeHandler</li></ul> <div class="custom-block tip"><p class="custom-block-title">来源</p> <p>版权声明：本文为CSDN博主「双子孤狼」的原创文章，遵循CC 4.0 BY-SA版权协议，转载请附上原文出处链接及本声明。
原文链接：https://blog.csdn.net/zwx900102/article/details/108455514</p></div></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/spring/BeanFactory和FactoryBean的区别.html" class="prev">
        BeanFactory和FactoryBean的区别
      </a></span> <span class="next"><a href="/mybatis/MyBatisPlus.html">
        MyBatisPlus
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.939029db.js" defer></script><script src="/assets/js/5.a0d7f1b0.js" defer></script><script src="/assets/js/4.5de2ab9a.js" defer></script>
  </body>
</html>
